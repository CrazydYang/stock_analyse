import{i as F}from"./index-1yOyFXf9.js";import{x as B,d as M,a as f,I as z,y as P,V as N,O,P as H,c as U,e as u,w as y,i as _,E as V,b as w,l as j,L as q,k as G,o as K,_ as J}from"./index-D4a2Bw9J.js";const W="/django/api/strategy";async function X(A,d){try{return(await B.get(`${W}/industry-turnover-percentile/`,{params:{start_date:A,end_date:d}})).data}catch(o){throw console.error("获取行业换手率分位数数据失败:",o),o}}const Y={class:"congestion-heatmap"},Z={class:"header-controls"},ee={class:"controls"},te=M({__name:"CongestionHeatmap",setup(A){const d=f();let o=null;const p=f("amount"),m=f("20"),b=f(!1),g=f(""),I=f(!1),C=f([]),S=f([]),D=async()=>{I.value=!0;try{const s=new Date,r=s.toISOString().split("T")[0],l=m.value==="all"?30:parseInt(m.value),i=new Date(s);i.setDate(s.getDate()-l);const h=i.toISOString().split("T")[0],t=await X(h,r);if(t){const e=t.data;if(!Array.isArray(e))throw console.error("API返回的数据不是数组:",e),new Error("API返回的数据格式不正确");const n=[...new Set(e.map(c=>c.date))].sort();S.value=n;const a=new Map;e.forEach(c=>{a.has(c.sector_code)||a.set(c.sector_code,{name:c.sector_name,data:[]});const x=a.get(c.sector_code),L=n.indexOf(c.date);for(;x.data.length<n.length;)x.data.push({turnoverRateFQuantile:0,amountCongestionQuantile:0});x.data[L]={turnoverRateFQuantile:c.turnover_ratio_percentile,amountCongestionQuantile:c.turnover_ratio_percentile}}),C.value=Array.from(a.values())}else V.error("获取数据失败: ")}catch(s){console.error("获取数据出错:",s),V.error("获取数据出错，请检查网络连接或API服务是否可用")}finally{I.value=!1}},Q=()=>{let s=C.value;g.value.trim()&&(s=C.value.filter(i=>i.name.toLowerCase().includes(g.value.toLowerCase())));const r=m.value==="all"?S.value:S.value.slice(-parseInt(m.value)),l=s.map(i=>({...i,data:m.value==="all"?i.data:i.data.slice(-parseInt(m.value))}));return{dates:r,industries:l}},R=()=>{d.value&&(o=F(d.value),v())},v=()=>{if(!o)return;const{dates:s,industries:r}=Q();g.value.trim()?$(r,s):T(r,s)},T=(s,r)=>{if(!o)return;const l=[...s].sort((t,e)=>{if(t.data.length===0||e.data.length===0)return 0;const n=t.data[t.data.length-1][p.value==="turnover"?"turnoverRateFQuantile":"amountCongestionQuantile"],a=e.data[e.data.length-1][p.value==="turnover"?"turnoverRateFQuantile":"amountCongestionQuantile"];return b.value?n-a:a-n}),i=[];l.forEach((t,e)=>{t.data.forEach((n,a)=>{const c=p.value==="turnover"?n.turnoverRateFQuantile:n.amountCongestionQuantile;i.push([a,e,c])})}),o.clear(),o.clear();const h={tooltip:{position:"top",formatter:function(t){const[e,n,a]=t.data,c=r[e],x=l[n].name,L=p.value==="turnover"?"等权换手率分位数":"成交金额占比分位数";return`${x}<br/>${c}<br/>${L}: ${a}`}},grid:{height:Math.max(400,l.length*20)+"px",top:"2%",left:"15%",right:"16%",bottom:"2%",containLabel:!0},xAxis:[{type:"category",data:r.map(t=>t.substring(5)),splitArea:{show:!0},axisLabel:{rotate:45,fontSize:10}},{type:"category",position:"top",data:r.map(t=>t.substring(5)),axisTick:{show:!1},axisLine:{show:!1},axisLabel:{rotate:45,fontSize:10,margin:6},name:"日期",nameLocation:"end",nameTextStyle:{fontSize:12}}],yAxis:[{type:"category",data:l.map(t=>t.name),splitArea:{show:!0},axisLabel:{fontSize:11}},{type:"category",position:"right",data:l.map(t=>t.name),axisTick:{show:!1},axisLine:{show:!1},axisLabel:{fontSize:11},name:"行业",nameLocation:"end",nameTextStyle:{fontSize:12}}],visualMap:{min:0,max:100,calculable:!0,orient:"vertical",right:"2%",top:"5%",inRange:{color:["#313695","#4575b4","#74add1","#abd9e9","#e0f3f8","#ffffbf","#fee090","#fdae61","#f46d43","#d73027","#a50026"]},text:["高","低"],textStyle:{fontSize:12}},series:[{name:p.value==="turnover"?"等权换手率分位数":"成交金额占比分位数",type:"heatmap",data:i,label:{show:!0,fontSize:9,formatter:function(t){return t.data[2]}},emphasis:{itemStyle:{shadowBlur:10,shadowColor:"rgba(0, 0, 0, 0.5)"}}}]};if(o.setOption(h),d.value){const t=Math.max(500,l.length*22+120);d.value.style.height=t+"px",o.resize()}},$=(s,r)=>{if(!o)return;const l=["#5470C6","#91CC75","#EE6666","#FAC858","#73C0DE","#3BA272","#FC8452","#9A60B4","#EA7CCC","#2f4554","#61a0a8","#d48265","#749f83","#ca8622","#bda29a","#6e7074","#546570","#c4ccd3"],i=e=>{let n=0;for(let a=0;a<e.length;a++)n=n*31+e.charCodeAt(a)>>>0;return l[n%l.length]},h=s.map(e=>{const n=i(e.name);return{name:e.name,type:"line",data:e.data.map(a=>p.value==="turnover"?a.turnoverRateFQuantile:a.amountCongestionQuantile),smooth:!0,symbol:"circle",symbolSize:6,lineStyle:{width:2,color:n},itemStyle:{color:n}}});o.clear();const t={title:{text:`行业拥挤度趋势图 - ${s.map(e=>e.name).join("、")}`,left:"center"},tooltip:{trigger:"axis",axisPointer:{type:"cross"},formatter:function(e){let n=`${e[0].axisValue}<br/>`;return e.forEach(a=>{const c=p.value==="turnover"?"等权换手率分位数":"成交金额占比分位数";n+=`${a.seriesName} ${c}: ${a.value}<br/>`}),n}},legend:{type:"scroll",data:s.map(e=>e.name),top:"5%"},grid:{left:"3%",right:"4%",bottom:"3%",top:"15%",containLabel:!0},xAxis:{type:"category",boundaryGap:!1,data:r.map(e=>e.substring(5)),axisLabel:{rotate:45}},yAxis:{type:"value",name:p.value==="turnover"?"等权换手率分位数":"成交金额占比分位数",min:0,max:100},series:h};o.setOption(t,!0),d.value&&(d.value.style.height="500px",o.resize())},k=()=>{b.value=!b.value,v()},E=()=>{o&&o.resize()};return z([p,g],()=>{o&&v()}),z(m,async()=>{await D(),o&&v()}),P(async()=>{const s=N.service({target:".congestion-heatmap",text:"加载数据中...",background:"rgba(255, 255, 255, 0.7)"});try{await D(),await O(),R()}finally{s.close()}window.addEventListener("resize",E)}),H(()=>{o&&o.dispose(),window.removeEventListener("resize",E)}),(s,r)=>{const l=_("el-option"),i=_("el-select"),h=_("el-icon"),t=_("el-input"),e=_("el-button"),n=_("el-card");return K(),U("div",Y,[u(n,null,{header:y(()=>[w("div",Z,[r[3]||(r[3]=w("h3",null,"行业拥挤度热力图",-1)),w("div",ee,[u(i,{modelValue:m.value,"onUpdate:modelValue":r[0]||(r[0]=a=>m.value=a),onChange:v,placeholder:"选择日期范围",style:{width:"150px","margin-left":"10px"}},{default:y(()=>[u(l,{label:"最近10天",value:"10"}),u(l,{label:"最近15天",value:"15"}),u(l,{label:"最近20天",value:"20"}),u(l,{label:"全部29天",value:"all"})]),_:1},8,["modelValue"]),u(t,{modelValue:g.value,"onUpdate:modelValue":r[1]||(r[1]=a=>g.value=a),onInput:v,onClear:v,placeholder:"搜索行业",style:{width:"200px","margin-left":"10px"},clearable:""},{prefix:y(()=>[u(h,null,{default:y(()=>[u(j(q))]),_:1})]),_:1},8,["modelValue"]),u(e,{onClick:k,type:"primary"},{default:y(()=>[...r[2]||(r[2]=[G("按最后一列排序",-1)])]),_:1})])])]),default:y(()=>[w("div",{ref_key:"chartContainer",ref:d,class:"chart-container"},null,512)]),_:1})])}}}),oe=J(te,[["__scopeId","data-v-f198392c"]]);export{oe as default};
