import{d as se,a as y,D as Z,f as B,w as t,i as c,c as w,g as P,e,k as d,t as i,b as l,F as oe,A as ne,C as Y,E as I,o as p,_ as re,r as W,y as ve,L as fe,G as ge,H as be,h as X,u as ke}from"./index-CMEqQrDU.js";import{b as ye,d as we,g as he,r as Ce,a as xe}from"./quantBacktestApi-BsEVHrlt.js";const $e={key:0,class:"loading-container"},ze={key:1,class:"result-container"},De={key:0,class:"strategy-params"},Ve={class:"metric-item"},Se={class:"metric-value"},Te={class:"metric-item"},Ne={class:"metric-value"},Be={class:"metric-item"},Le={class:"metric-item"},Re={class:"metric-item"},Fe={class:"metric-value"},Ue={class:"metric-item"},Ie={class:"metric-value negative"},Pe={class:"metric-item"},Ee={class:"metric-value"},He={class:"metric-item"},Me={class:"metric-value"},je={class:"metric-item"},Ae={class:"metric-value"},Ge={class:"metric-item"},Oe={class:"metric-value positive"},Ye={class:"metric-item"},qe={class:"metric-value negative"},Je={class:"card-header"},Ke={class:"trade-count"},Qe={key:2,class:"error-container"},We=se({__name:"BacktestResultDialog",props:{visible:{type:Boolean},taskId:{}},emits:["update:visible"],setup(ee,{emit:q}){const m=ee,f=q,n=y(null),L=y(!1),u=y(""),R=async()=>{if(!m.taskId){u.value="任务ID不能为空";return}L.value=!0,u.value="",n.value=null;try{n.value=await ye(m.taskId)}catch(_){console.error("加载回测结果失败:",_),u.value=_.message||"加载回测结果失败",I.error("加载回测结果失败")}finally{L.value=!1}},z=()=>{f("update:visible",!1),n.value=null,u.value=""};Z(()=>m.visible,_=>{_&&m.taskId&&R()});const h=_=>new Intl.NumberFormat("zh-CN",{style:"currency",currency:"CNY",minimumFractionDigits:2}).format(_),D=_=>_==null?"-":`${_.toFixed(2)}%`,V=_=>new Date(_).toLocaleString("zh-CN"),T=_=>_>0?"positive":_<0?"negative":"";return(_,r)=>{const J=c("el-skeleton"),k=c("el-descriptions-item"),H=c("el-descriptions"),E=c("el-card"),g=c("el-col"),F=c("el-row"),C=c("el-table-column"),K=c("el-tag"),Q=c("el-table"),M=c("el-button"),j=c("el-result"),A=c("el-dialog");return p(),B(A,{"model-value":_.visible,"onUpdate:modelValue":z,title:"回测结果详情",width:"90%","close-on-click-modal":!1,"before-close":z},{footer:t(()=>[e(M,{onClick:z},{default:t(()=>[...r[16]||(r[16]=[d("关闭",-1)])]),_:1})]),default:t(()=>[L.value?(p(),w("div",$e,[e(J,{rows:10,animated:""})])):n.value?(p(),w("div",ze,[e(E,{class:"info-card",shadow:"never"},{header:t(()=>[...r[0]||(r[0]=[l("div",{class:"card-header"},[l("span",null,"基本信息")],-1)])]),default:t(()=>[e(H,{column:3,border:""},{default:t(()=>[e(k,{label:"任务ID"},{default:t(()=>[d(i(n.value.task_info.task_id),1)]),_:1}),e(k,{label:"策略名称"},{default:t(()=>[d(i(n.value.task_info.strategy_name),1)]),_:1}),e(k,{label:"股票代码"},{default:t(()=>[d(i(n.value.task_info.stock_code),1)]),_:1}),e(k,{label:"股票名称"},{default:t(()=>[d(i(n.value.task_info.stock_name),1)]),_:1}),e(k,{label:"开始日期"},{default:t(()=>[d(i(n.value.task_info.start_date),1)]),_:1}),e(k,{label:"结束日期"},{default:t(()=>[d(i(n.value.task_info.end_date),1)]),_:1}),e(k,{label:"初始资金"},{default:t(()=>[d(i(h(n.value.task_info.initial_cash)),1)]),_:1}),e(k,{label:"手续费率"},{default:t(()=>[d(i(D(n.value.task_info.commission)),1)]),_:1}),e(k,{label:"创建时间"},{default:t(()=>[d(i(V(n.value.task_info.created_at)),1)]),_:1}),e(k,{label:"完成时间"},{default:t(()=>[d(i(V(n.value.task_info.completed_at)),1)]),_:1})]),_:1}),n.value.task_info.strategy_params&&Object.keys(n.value.task_info.strategy_params).length>0?(p(),w("div",De,[r[1]||(r[1]=l("h4",null,"策略参数",-1)),e(H,{column:2,border:""},{default:t(()=>[(p(!0),w(oe,null,ne(n.value.task_info.strategy_params,(b,N)=>(p(),B(k,{key:N,label:N},{default:t(()=>[d(i(b),1)]),_:2},1032,["label"]))),128))]),_:1})])):P("",!0)]),_:1}),e(E,{class:"performance-card",shadow:"never"},{header:t(()=>[...r[2]||(r[2]=[l("div",{class:"card-header"},[l("span",null,"绩效指标")],-1)])]),default:t(()=>[e(F,{gutter:16},{default:t(()=>[e(g,{span:6},{default:t(()=>[l("div",Ve,[r[3]||(r[3]=l("div",{class:"metric-label"},"初始价值",-1)),l("div",Se,i(h(n.value.performance.initial_value)),1)])]),_:1}),e(g,{span:6},{default:t(()=>[l("div",Te,[r[4]||(r[4]=l("div",{class:"metric-label"},"最终价值",-1)),l("div",Ne,i(h(n.value.performance.final_value)),1)])]),_:1}),e(g,{span:6},{default:t(()=>[l("div",Be,[r[5]||(r[5]=l("div",{class:"metric-label"},"总收益率",-1)),l("div",{class:Y(["metric-value",T(n.value.performance.total_return)])},i(D(n.value.performance.total_return)),3)])]),_:1}),e(g,{span:6},{default:t(()=>[l("div",Le,[r[6]||(r[6]=l("div",{class:"metric-label"},"年化收益率",-1)),l("div",{class:Y(["metric-value",T(n.value.performance.annual_return)])},i(D(n.value.performance.annual_return)),3)])]),_:1})]),_:1}),e(F,{gutter:16},{default:t(()=>[e(g,{span:6},{default:t(()=>[l("div",Re,[r[7]||(r[7]=l("div",{class:"metric-label"},"夏普比率",-1)),l("div",Fe,i(n.value.performance.sharpe_ratio!==null?n.value.performance.sharpe_ratio.toFixed(4):"-"),1)])]),_:1}),e(g,{span:6},{default:t(()=>[l("div",Ue,[r[8]||(r[8]=l("div",{class:"metric-label"},"最大回撤",-1)),l("div",Ie,i(D(n.value.performance.max_drawdown)),1)])]),_:1}),e(g,{span:6},{default:t(()=>[l("div",Pe,[r[9]||(r[9]=l("div",{class:"metric-label"},"波动率",-1)),l("div",Ee,i(n.value.performance.volatility!==null?D(n.value.performance.volatility):"-"),1)])]),_:1}),e(g,{span:6},{default:t(()=>[l("div",He,[r[10]||(r[10]=l("div",{class:"metric-label"},"总交易次数",-1)),l("div",Me,i(n.value.performance.total_trades),1)])]),_:1})]),_:1}),e(F,{gutter:16},{default:t(()=>[e(g,{span:6},{default:t(()=>[l("div",je,[r[11]||(r[11]=l("div",{class:"metric-label"},"胜率",-1)),l("div",Ae,i(n.value.performance.win_rate!==null?D(n.value.performance.win_rate):"-"),1)])]),_:1}),e(g,{span:6},{default:t(()=>[l("div",Ge,[r[12]||(r[12]=l("div",{class:"metric-label"},"盈利交易",-1)),l("div",Oe,i(n.value.performance.winning_trades),1)])]),_:1}),e(g,{span:6},{default:t(()=>[l("div",Ye,[r[13]||(r[13]=l("div",{class:"metric-label"},"亏损交易",-1)),l("div",qe,i(n.value.performance.losing_trades),1)])]),_:1}),e(g,{span:6})]),_:1})]),_:1}),n.value.detailed_data.trade_records.length>0?(p(),B(E,{key:0,class:"trades-card",shadow:"never"},{header:t(()=>[l("div",Je,[r[14]||(r[14]=l("span",null,"交易记录",-1)),l("span",Ke,"共 "+i(n.value.detailed_data.trade_records.length)+" 笔交易",1)])]),default:t(()=>[e(Q,{data:n.value.detailed_data.trade_records,stripe:"",style:{width:"100%"},"max-height":"400"},{default:t(()=>[e(C,{prop:"datetime",label:"交易时间","min-width":"160"},{default:t(b=>[d(i(V(b.row.datetime)),1)]),_:1}),e(C,{prop:"type",label:"交易类型","min-width":"100"},{default:t(b=>[e(K,{type:b.row.type==="buy"?"success":"danger"},{default:t(()=>[d(i(b.row.type==="buy"?"买入":"卖出"),1)]),_:2},1032,["type"])]),_:1}),e(C,{prop:"size",label:"数量","min-width":"100"}),e(C,{prop:"price",label:"价格","min-width":"120"},{default:t(b=>[d(i(h(b.row.price)),1)]),_:1}),e(C,{prop:"value",label:"交易金额","min-width":"140"},{default:t(b=>[d(i(h(b.row.value)),1)]),_:1}),e(C,{prop:"commission",label:"手续费","min-width":"120"},{default:t(b=>[d(i(h(b.row.commission)),1)]),_:1})]),_:1},8,["data"])]),_:1})):P("",!0)])):u.value?(p(),w("div",Qe,[e(j,{icon:"error",title:"加载失败","sub-title":u.value},{extra:t(()=>[e(M,{type:"primary",onClick:R},{default:t(()=>[...r[15]||(r[15]=[d("重试",-1)])]),_:1})]),_:1},8,["sub-title"])])):P("",!0)]),_:1},8,["model-value"])}}}),Xe=re(We,[["__scopeId","data-v-ed8eda27"]]),Ze={class:"backtest-history-view"},et={class:"filter-panel"},tt={class:"card-header"},at={class:"task-list"},lt={class:"card-header"},st={class:"header-actions"},ot={key:1},nt={key:0,class:"negative"},rt={key:1},it={class:"pagination-container"},dt={key:0,class:"task-detail"},ut={class:"negative"},ct={class:"task-actions",style:{"margin-top":"20px"}},_t=se({__name:"BacktestHistoryView",setup(ee){const q=ke(),m=W({strategyName:"",symbol:"",status:""}),f=W({page:1,pageSize:10,total:0}),n=y([]),L=y([]),u=y(null),R=y(!1),z=y(!1),h=y(!1),D=y(""),V=y(new Set),T=y(new Set),_=W({tasks:[]}),r=async()=>{R.value=!0;try{const s={offset:(f.page-1)*f.pageSize,limit:f.pageSize,...m.strategyName&&{strategy_name:m.strategyName},...m.symbol&&{stock_code:m.symbol},...m.status&&{status:m.status}},a=await we(s);console.log("result.tasks",a.tasks),_.tasks=a.tasks||[],n.value=a.tasks||[],await fe(),f.total=a.total}catch(s){console.error("加载任务列表失败:",s),I.error("加载任务列表失败")}finally{R.value=!1}},J=async()=>{try{const s=await he();L.value=s}catch(s){console.error("加载策略列表失败:",s)}},k=()=>{f.page=1,r()},H=()=>{m.strategyName="",m.symbol="",m.status="",f.page=1,r()},E=()=>{r()},g=async s=>{V.value.add(s);try{if(await Ce(s),I.success("回测任务已启动"),await r(),u.value&&u.value.task_id===s){const a=_.tasks.find(v=>v.task_id===s);a&&(u.value=a)}}catch(a){console.error("运行回测任务失败:",a),I.error("运行回测任务失败")}finally{V.value.delete(s)}},F=async s=>{T.value.add(s);try{const a=await xe(s),v=_.tasks.findIndex(U=>U.task_id===s);v!==-1&&(_.tasks[v].status=a.status,a.completed_at&&(_.tasks[v].completed_at=a.completed_at));const x=n.value.findIndex(U=>U.task_id===s);x!==-1&&(n.value[x].status=a.status,a.completed_at&&(n.value[x].completed_at=a.completed_at)),u.value&&u.value.task_id===s&&(u.value.status=a.status,a.completed_at&&(u.value.completed_at=a.completed_at)),I.success("状态已更新")}catch(a){console.error("查询任务状态失败:",a),I.error("查询任务状态失败")}finally{T.value.delete(s)}},C=s=>{q.push(`/backtest-result/${s}`)},K=s=>{u.value=s,z.value=!0},Q=s=>{f.pageSize=s,f.page=1,r()},M=s=>{f.page=s,r()},j=s=>{switch(s){case"created":return"info";case"running":return"warning";case"completed":return"success";case"failed":return"danger";default:return"info"}},A=s=>{switch(s){case"created":return"已创建";case"running":return"运行中";case"completed":return"已完成";case"failed":return"执行失败";default:return"未知状态"}},b=s=>s>0?"positive":s<0?"negative":"",N=s=>s==null?"-":`${s.toFixed(2)}%`,G=s=>new Date(s).toLocaleString("zh-CN");return Z(n,s=>{console.log("taskList 发生变化，新长度:",s.length)},{deep:!0}),Z(()=>_.tasks,s=>{console.log("tableData.tasks 发生变化，新长度:",s.length),console.log("tableData.tasks 内容:",s)},{deep:!0}),ve(async()=>{await Promise.all([J(),r()])}),(s,a)=>{const v=c("el-button"),x=c("el-option"),U=c("el-select"),O=c("el-form-item"),ie=c("el-input"),de=c("el-form"),te=c("el-card"),$=c("el-table-column"),ae=c("el-tag"),ue=c("el-table"),ce=c("el-pagination"),S=c("el-descriptions-item"),_e=c("el-descriptions"),me=c("el-dialog"),pe=be("loading");return p(),w("div",Ze,[a[25]||(a[25]=l("div",{class:"page-header"},[l("h1",null,"回测历史"),l("p",null,"查看历史回测任务，监控状态和查看结果")],-1)),l("div",et,[e(te,null,{header:t(()=>[l("div",tt,[a[13]||(a[13]=l("span",null,"筛选条件",-1)),e(v,{type:"primary",onClick:E},{default:t(()=>[...a[12]||(a[12]=[d("刷新",-1)])]),_:1})])]),default:t(()=>[e(de,{model:m,inline:"",class:"filter-form"},{default:t(()=>[e(O,{label:"策略名称"},{default:t(()=>[e(U,{modelValue:m.strategyName,"onUpdate:modelValue":a[0]||(a[0]=o=>m.strategyName=o),placeholder:"全部策略",clearable:"",style:{width:"150px"}},{default:t(()=>[(p(!0),w(oe,null,ne(L.value,o=>(p(),B(x,{key:o.name,label:o.description,value:o.name},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),e(O,{label:"股票代码"},{default:t(()=>[e(ie,{modelValue:m.symbol,"onUpdate:modelValue":a[1]||(a[1]=o=>m.symbol=o),placeholder:"请输入股票代码",clearable:"",style:{width:"150px"}},null,8,["modelValue"])]),_:1}),e(O,{label:"状态"},{default:t(()=>[e(U,{modelValue:m.status,"onUpdate:modelValue":a[2]||(a[2]=o=>m.status=o),placeholder:"全部状态",clearable:"",style:{width:"120px"}},{default:t(()=>[e(x,{label:"已创建",value:"created"}),e(x,{label:"运行中",value:"running"}),e(x,{label:"已完成",value:"completed"}),e(x,{label:"执行失败",value:"failed"})]),_:1},8,["modelValue"])]),_:1}),e(O,null,{default:t(()=>[e(v,{type:"primary",onClick:k},{default:t(()=>[...a[14]||(a[14]=[d("查询",-1)])]),_:1}),e(v,{onClick:H},{default:t(()=>[...a[15]||(a[15]=[d("重置",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1})]),l("div",at,[e(te,null,{header:t(()=>[l("div",lt,[a[17]||(a[17]=l("span",null,"回测任务列表",-1)),l("div",st,[e(v,{type:"primary",onClick:a[3]||(a[3]=o=>s.$router.push("/backtest-strategy"))},{default:t(()=>[...a[16]||(a[16]=[d("创建新任务",-1)])]),_:1})])])]),default:t(()=>[ge((p(),B(ue,{data:_.tasks,stripe:"",style:{width:"100%"},onRowClick:K,class:"full-width-table"},{default:t(()=>[e($,{prop:"task_id",label:"任务ID","min-width":"200","show-overflow-tooltip":""}),e($,{prop:"strategy_name",label:"策略","min-width":"120"}),e($,{prop:"stock_code",label:"股票","min-width":"100"}),e($,{label:"状态",width:"100"},{default:t(o=>[e(ae,{type:j(o.row.status)},{default:t(()=>[d(i(A(o.row.status)),1)]),_:2},1032,["type"])]),_:1}),e($,{label:"总收益率","min-width":"120"},{default:t(o=>[o.row.result_summary?.total_return!==void 0?(p(),w("span",{key:0,class:Y(b(o.row.result_summary?.total_return))},i(N(o.row.result_summary?.total_return)),3)):(p(),w("span",ot,"-"))]),_:1}),e($,{label:"最大回撤","min-width":"120"},{default:t(o=>[o.row.result_summary?.max_drawdown!==void 0?(p(),w("span",nt,i(N(o.row.result_summary?.max_drawdown)),1)):(p(),w("span",rt,"-"))]),_:1}),e($,{prop:"created_at",label:"创建时间","min-width":"180"},{default:t(o=>[d(i(G(o.row.created_at)),1)]),_:1}),e($,{prop:"completed_at",label:"完成时间","min-width":"180"},{default:t(o=>[d(i(o.row.completed_at?G(o.row.completed_at):"-"),1)]),_:1}),e($,{label:"操作","min-width":"250",fixed:"right"},{default:t(o=>[e(v,{type:"primary",size:"small",onClick:X(le=>g(o.row.task_id),["stop"]),disabled:o.row.status!=="created",loading:V.value.has(o.row.task_id)},{default:t(()=>[...a[18]||(a[18]=[d(" 运行 ",-1)])]),_:2},1032,["onClick","disabled","loading"]),e(v,{type:"info",size:"small",onClick:X(le=>F(o.row.task_id),["stop"]),loading:T.value.has(o.row.task_id)},{default:t(()=>[...a[19]||(a[19]=[d(" 查询状态 ",-1)])]),_:2},1032,["onClick","loading"]),e(v,{type:"success",size:"small",onClick:X(le=>C(o.row.task_id),["stop"]),disabled:o.row.status!=="completed"},{default:t(()=>[...a[20]||(a[20]=[d(" 查看结果 ",-1)])]),_:2},1032,["onClick","disabled"])]),_:1})]),_:1},8,["data"])),[[pe,R.value]]),l("div",it,[e(ce,{"current-page":f.page,"onUpdate:currentPage":a[4]||(a[4]=o=>f.page=o),"page-size":f.pageSize,"onUpdate:pageSize":a[5]||(a[5]=o=>f.pageSize=o),"page-sizes":[10,20,50,100],total:f.total,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:Q,onCurrentChange:M},null,8,["current-page","page-size","total"])])]),_:1})]),e(me,{modelValue:z.value,"onUpdate:modelValue":a[10]||(a[10]=o=>z.value=o),title:"任务详情",width:"800px","close-on-click-modal":!1},{footer:t(()=>[e(v,{onClick:a[9]||(a[9]=o=>z.value=!1)},{default:t(()=>[...a[24]||(a[24]=[d("关闭",-1)])]),_:1})]),default:t(()=>[u.value?(p(),w("div",dt,[e(_e,{column:2,border:""},{default:t(()=>[e(S,{label:"任务ID"},{default:t(()=>[d(i(u.value.task_id),1)]),_:1}),e(S,{label:"策略名称"},{default:t(()=>[d(i(u.value.strategy_name),1)]),_:1}),e(S,{label:"股票代码"},{default:t(()=>[d(i(u.value.stock_code),1)]),_:1}),e(S,{label:"状态"},{default:t(()=>[e(ae,{type:j(u.value.status)},{default:t(()=>[d(i(A(u.value.status)),1)]),_:1},8,["type"])]),_:1}),e(S,{label:"创建时间"},{default:t(()=>[d(i(G(u.value.created_at)),1)]),_:1}),e(S,{label:"完成时间"},{default:t(()=>[d(i(u.value.completed_at?G(u.value.completed_at):"-"),1)]),_:1}),u.value.result_summary?.total_return!==void 0?(p(),B(S,{key:0,label:"总收益率"},{default:t(()=>[l("span",{class:Y(b(u.value.result_summary?.total_return))},i(N(u.value.result_summary?.total_return)),3)]),_:1})):P("",!0),u.value.result_summary?.max_drawdown!==void 0?(p(),B(S,{key:1,label:"最大回撤"},{default:t(()=>[l("span",ut,i(N(u.value.result_summary?.max_drawdown??0)),1)]),_:1})):P("",!0)]),_:1}),l("div",ct,[e(v,{type:"primary",onClick:a[6]||(a[6]=o=>g(u.value.task_id)),disabled:u.value.status!=="created",loading:V.value.has(u.value.task_id)},{default:t(()=>[...a[21]||(a[21]=[d(" 运行任务 ",-1)])]),_:1},8,["disabled","loading"]),e(v,{type:"info",onClick:a[7]||(a[7]=o=>F(u.value.task_id)),loading:T.value.has(u.value.task_id)},{default:t(()=>[...a[22]||(a[22]=[d(" 刷新状态 ",-1)])]),_:1},8,["loading"]),e(v,{type:"success",onClick:a[8]||(a[8]=o=>C(u.value.task_id)),disabled:u.value.status!=="completed"},{default:t(()=>[...a[23]||(a[23]=[d(" 查看结果 ",-1)])]),_:1},8,["disabled"])])])):P("",!0)]),_:1},8,["modelValue"]),e(Xe,{visible:h.value,"onUpdate:visible":a[11]||(a[11]=o=>h.value=o),"task-id":D.value},null,8,["visible","task-id"])])}}}),vt=re(_t,[["__scopeId","data-v-b0e2f4bb"]]);export{vt as default};
