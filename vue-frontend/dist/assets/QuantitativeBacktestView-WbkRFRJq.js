import{S as be}from"./StockKLineChart-C7h14v6i.js";import{f as T,g as N,a as we,b as De,c as Ce}from"./stockHistoryApi-DNEDVjGc.js";import{g as Ve,c as Me,r as xe,a as Se,b as Ye}from"./quantBacktestApi-B2r0orqK.js";import{i as Te,L as Pe}from"./index-1yOyFXf9.js";import{d as Be,r as H,a as w,B as Ne,G as $e,C as Ue,c as D,b as d,g as k,e as a,w as l,i as p,E as _,f as C,F as K,A as O,k as f,t as i,o as m,_ as Fe}from"./index-BBEcv-Cz.js";const Re={class:"quantitative-backtest-view"},Le={class:"control-panel"},Ie={key:0,class:"chart-container"},qe={class:"card-header"},ze={class:"stock-info"},Ae={key:1,class:"empty-state"},Ee={key:2,class:"strategy-panel"},Ge={key:3,class:"result-container"},He={class:"card-header"},Ke={key:0,class:"trades-table"},Oe={class:"performance-metrics"},Qe={key:0,class:"result-chart"},je=Be({__name:"QuantitativeBacktestView",setup(Je){const r=H({stockCode:"",stockName:"",dateRangeType:"month",startDate:"",endDate:""}),u=H({strategyName:"",initialCash:1e5,strategyParams:{}}),M=w([]),c=H({code:"",name:"",industry:"",listDate:"",totalMarketCap:0,circulatingMarketCap:0}),z=w([]),A=w([]),P=w(null),h=w(""),x=w(""),n=w(null),$=w([]),E=w(null),b=w(!1),te=Ne(()=>!!r.stockCode&&!!u.strategyName&&M.value.length>0),ae=t=>{const e=z.value.find(o=>o.code===t);e&&(r.stockCode=e.code,r.stockName=e.name,le(e.code))},le=async t=>{try{const e=await De(t);c.code=e.code,c.name=e.name,c.industry=e.industry,c.listDate=e.list_date,c.totalMarketCap=e.total_market_cap,c.circulatingMarketCap=e.circulating_market_cap}catch(e){console.error("获取股票详细信息失败:",e),_.error("获取股票详细信息失败")}},Q=()=>{const e=T(new Date);switch(r.endDate=e,r.dateRangeType){case"week":r.startDate=T(N(7));break;case"month":r.startDate=T(N(30));break;case"threeMonths":r.startDate=T(N(90));break;case"sixMonths":r.startDate=T(N(180));break;case"year":r.startDate=T(N(365));break;case"threeYears":r.startDate=T(N(365*3));break;case"all":r.startDate="";break}},se=async()=>{if(!r.stockCode){_.warning("请先选择股票");return}if(r.dateRangeType==="custom"&&(!r.startDate||!r.endDate)){_.warning("请选择完整的日期范围");return}b.value=!0;try{let t=r.startDate,e=r.endDate;t&&(t=t.replace(/-/g,"")),e&&(e=e.replace(/-/g,""));const o=await Ce(r.stockCode,t,e);M.value=o,o.length>0?_.success("股票数据获取成功"):_.warning("未查询到股票历史数据"),j()}catch(t){console.error("获取股票数据失败:",t),_.error("获取股票数据失败"),M.value=[]}finally{b.value=!1}},re=()=>{r.stockCode="",r.stockName="",r.dateRangeType="month",r.startDate="",r.endDate="",M.value=[],c.code="",c.name="",c.industry="",c.listDate="",c.totalMarketCap=0,c.circulatingMarketCap=0,j()},j=()=>{u.strategyName="",u.strategyParams={},P.value=null,h.value="",x.value="",n.value=null,$.value=[]},oe=()=>{u.strategyName="",u.initialCash=1e5,u.strategyParams={},P.value=null,h.value="",x.value="",n.value=null,$.value=[]},J=t=>t?t>=1e8?`${(t/1e8).toFixed(2)}亿`:t>=1e4?`${(t/1e4).toFixed(2)}万`:t.toString():"未知",R=t=>t==null?"-":`${(t*100).toFixed(2)}%`,L=t=>t?t.toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2}):"0.00",ne=t=>{switch(t){case"created":return"info";case"running":return"warning";case"completed":return"success";case"failed":return"danger";default:return"info"}},ue=t=>{switch(t){case"created":return"已创建";case"running":return"运行中";case"completed":return"已完成";case"failed":return"执行失败";default:return"未知状态"}},de=async()=>{try{b.value=!0;const{data:t}=await we(1,100);z.value=t}catch(t){console.error("加载股票列表失败:",t),_.error("加载股票列表失败")}finally{b.value=!1}},ce=async()=>{try{b.value=!0;const t=await Ve();A.value=t}catch(t){console.error("加载策略列表失败:",t),_.error("加载策略列表失败")}finally{b.value=!1}},ie=t=>{const e=A.value.find(o=>o.name===t);e&&(P.value=e,console.log("选择策略:",e),u.strategyParams={},e.params&&Object.keys(e.params).forEach(o=>{u.strategyParams[o]=e.params[o].default}))},me=async()=>{if(!r.stockCode||!u.strategyName){_.warning("请选择股票和策略");return}b.value=!0;try{const t=y=>y?y.includes("-")?y:y.length===8?`${y.slice(0,4)}-${y.slice(4,6)}-${y.slice(6,8)}`:y:"",e={strategy_name:u.strategyName,stock_code:r.stockCode,start_date:t(r.startDate),end_date:t(r.endDate),initial_cash:u.initialCash,strategy_params:u.strategyParams},o=await Me(e);h.value=o.task_id,x.value=o.status,_.success("回测任务创建成功")}catch(t){console.error("创建回测任务失败:",t),_.error("创建回测任务失败")}finally{b.value=!1}},fe=async()=>{if(!h.value){_.warning("请先创建回测任务");return}b.value=!0;try{const t=await xe(h.value);x.value=t.status,_.success("回测任务已启动"),W()}catch(t){console.error("启动回测任务失败:",t),_.error("启动回测任务失败")}finally{b.value=!1}},W=async()=>{if(h.value)try{const t=await Se(h.value);x.value=t.status,t.status==="completed"?pe():t.status==="failed"?_.error("回测任务执行失败"):t.status==="running"&&setTimeout(W,2e3)}catch(t){console.error("获取任务状态失败:",t),_.error("获取任务状态失败")}},pe=async()=>{if(h.value)try{const t=await Ye(h.value);n.value=t,_e(),X()}catch(t){console.error("获取回测结果失败:",t),_.error("获取回测结果失败")}},_e=()=>{if(!n.value)return;const t=[];if(n.value.detailed_data?.trade_records){const e=n.value.detailed_data.trade_records;for(const o of e)t.push({date:o.datetime.split("T")[0],price:o.price,type:o.type,description:`${o.type==="buy"?"买入":"卖出"} ${Math.abs(o.size)}股`})}else if(n.value.trades){const e=n.value.trades;for(const o of e)t.push({date:o.date,price:o.price,type:o.action,description:`${o.action==="buy"?"买入":"卖出"} ${Math.abs(o.quantity)}股`})}$.value=t,console.log("交易点数据已更新:",$.value.length,"个交易点")},X=()=>{if(!E.value||!n.value)return;const t=n.value.detailed_data?.portfolio_values||n.value.portfolio_value;if(!t||t.length===0)return;const e=Te(E.value),o=t.map(v=>v.date),y=t.map(v=>v.value),g={title:{text:"投资组合价值变化",left:"center"},tooltip:{trigger:"axis",formatter:v=>{const U=v[0].axisValue,I=v[0].data;return`${U}<br/>组合价值: ${L(I)}`}},xAxis:{type:"category",data:o},yAxis:{type:"value",name:"组合价值",axisLabel:{formatter:v=>L(v)}},series:[{name:"组合价值",type:"line",data:y,smooth:!0,lineStyle:{width:2,color:"#5470c6"},areaStyle:{color:new Pe(0,0,0,1,[{offset:0,color:"rgba(84, 112, 198, 0.5)"},{offset:1,color:"rgba(84, 112, 198, 0.1)"}])}}]};e.setOption(g),window.addEventListener("resize",()=>{e.resize()})};return $e(()=>n.value,()=>{setTimeout(()=>{X()},0)}),Ue(()=>{Q(),de(),ce()}),(t,e)=>{const o=p("el-option"),y=p("el-select"),g=p("el-form-item"),v=p("el-col"),U=p("el-row"),I=p("el-date-picker"),F=p("el-button"),Z=p("el-form"),q=p("el-card"),ve=p("el-empty"),G=p("el-input-number"),ye=p("el-input"),ge=p("el-switch"),ee=p("el-tag"),B=p("el-table-column"),ke=p("el-table"),S=p("el-descriptions-item"),he=p("el-descriptions");return m(),D("div",Re,[e[16]||(e[16]=d("div",{class:"page-header"},[d("h1",null,"量化策略回测"),d("p",null,"选择股票和策略，进行量化回测分析")],-1)),d("div",Le,[a(q,null,{header:l(()=>[...e[6]||(e[6]=[d("div",{class:"card-header"},[d("span",null,"股票选择")],-1)])]),default:l(()=>[a(Z,{model:r,"label-width":"100px",class:"query-form"},{default:l(()=>[a(U,{gutter:20},{default:l(()=>[a(v,{span:8},{default:l(()=>[a(g,{label:"股票代码"},{default:l(()=>[a(y,{modelValue:r.stockCode,"onUpdate:modelValue":e[0]||(e[0]=s=>r.stockCode=s),placeholder:"请选择股票",class:"full-width",onChange:ae},{default:l(()=>[(m(!0),D(K,null,O(z.value,s=>(m(),C(o,{key:s.code,label:`${s.code} ${s.name}`,value:s.code},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1}),a(v,{span:8},{default:l(()=>[a(g,{label:"时间范围"},{default:l(()=>[a(y,{modelValue:r.dateRangeType,"onUpdate:modelValue":e[1]||(e[1]=s=>r.dateRangeType=s),onChange:Q,class:"full-width"},{default:l(()=>[a(o,{label:"最近一周",value:"week"}),a(o,{label:"最近一月",value:"month"}),a(o,{label:"最近三月",value:"threeMonths"}),a(o,{label:"最近六月",value:"sixMonths"}),a(o,{label:"最近一年",value:"year"}),a(o,{label:"最近三年",value:"threeYears"}),a(o,{label:"全部",value:"all"}),a(o,{label:"自定义",value:"custom"})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),r.dateRangeType==="custom"?(m(),C(U,{key:0,gutter:20},{default:l(()=>[a(v,{span:8},{default:l(()=>[a(g,{label:"开始日期"},{default:l(()=>[a(I,{modelValue:r.startDate,"onUpdate:modelValue":e[2]||(e[2]=s=>r.startDate=s),type:"date",placeholder:"选择开始日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",class:"full-width"},null,8,["modelValue"])]),_:1})]),_:1}),a(v,{span:8},{default:l(()=>[a(g,{label:"结束日期"},{default:l(()=>[a(I,{modelValue:r.endDate,"onUpdate:modelValue":e[3]||(e[3]=s=>r.endDate=s),type:"date",placeholder:"选择结束日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",class:"full-width"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})):k("",!0),a(g,null,{default:l(()=>[a(F,{type:"primary",onClick:se},{default:l(()=>[...e[7]||(e[7]=[f("查询",-1)])]),_:1}),a(F,{onClick:re},{default:l(()=>[...e[8]||(e[8]=[f("重置",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1})]),M.value.length>0?(m(),D("div",Ie,[a(q,null,{header:l(()=>[d("div",qe,[d("span",null,i(c.name)+"("+i(c.code)+") K线图",1),d("div",ze,[d("span",null,"行业: "+i(c.industry||"未知"),1),d("span",null,"上市日期: "+i(c.listDate||"未知"),1),d("span",null,"总市值: "+i(J(c.totalMarketCap)),1),d("span",null,"流通市值: "+i(J(c.circulatingMarketCap)),1)])])]),default:l(()=>[a(be,{"stock-code":c.code,"stock-name":c.name,"kline-data":M.value,"trade-signals":$.value,height:"500px","show-volume":!0},null,8,["stock-code","stock-name","kline-data","trade-signals"])]),_:1})])):k("",!0),M.value.length===0?(m(),D("div",Ae,[a(ve,{description:"请选择股票并查询数据"})])):k("",!0),M.value.length>0?(m(),D("div",Ee,[a(q,null,{header:l(()=>[...e[9]||(e[9]=[d("div",{class:"card-header"},[d("span",null,"策略配置")],-1)])]),default:l(()=>[a(Z,{model:u,"label-width":"120px",class:"strategy-form"},{default:l(()=>[a(g,{label:"选择策略"},{default:l(()=>[a(y,{modelValue:u.strategyName,"onUpdate:modelValue":e[4]||(e[4]=s=>u.strategyName=s),placeholder:"请选择策略",class:"full-width",onChange:ie},{default:l(()=>[(m(!0),D(K,null,O(A.value,s=>(m(),C(o,{key:s.name,label:s.description,value:s.name},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),a(g,{label:"初始资金"},{default:l(()=>[a(G,{modelValue:u.initialCash,"onUpdate:modelValue":e[5]||(e[5]=s=>u.initialCash=s),min:1e4,step:1e4,precision:0,class:"full-width"},null,8,["modelValue"])]),_:1}),P.value&&P.value.params?(m(!0),D(K,{key:0},O(P.value.params,(s,V)=>(m(),C(g,{key:V,label:s.description},{default:l(()=>[s.type==="int"?(m(),C(G,{key:0,modelValue:u.strategyParams[V],"onUpdate:modelValue":Y=>u.strategyParams[V]=Y,min:1,precision:0,class:"full-width"},null,8,["modelValue","onUpdate:modelValue"])):s.type==="string"?(m(),C(ye,{key:1,modelValue:u.strategyParams[V],"onUpdate:modelValue":Y=>u.strategyParams[V]=Y,class:"full-width"},null,8,["modelValue","onUpdate:modelValue"])):s.type==="float"?(m(),C(G,{key:2,modelValue:u.strategyParams[V],"onUpdate:modelValue":Y=>u.strategyParams[V]=Y,precision:2,class:"full-width"},null,8,["modelValue","onUpdate:modelValue"])):s.type==="boolean"?(m(),C(ge,{key:3,modelValue:u.strategyParams[V],"onUpdate:modelValue":Y=>u.strategyParams[V]=Y},null,8,["modelValue","onUpdate:modelValue"])):k("",!0)]),_:2},1032,["label"]))),128)):k("",!0),a(g,null,{default:l(()=>[a(F,{type:"primary",onClick:me,disabled:!te.value},{default:l(()=>[...e[10]||(e[10]=[f("创建回测任务",-1)])]),_:1},8,["disabled"]),a(F,{type:"success",onClick:fe,disabled:!h.value},{default:l(()=>[...e[11]||(e[11]=[f("运行回测",-1)])]),_:1},8,["disabled"]),a(F,{onClick:oe},{default:l(()=>[...e[12]||(e[12]=[f("重置",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1})])):k("",!0),n.value?(m(),D("div",Ge,[a(q,null,{header:l(()=>[d("div",He,[e[13]||(e[13]=d("span",null,"回测结果",-1)),x.value?(m(),C(ee,{key:0,type:ne(x.value)},{default:l(()=>[f(i(ue(x.value)),1)]),_:1},8,["type"])):k("",!0)])]),default:l(()=>[a(U,{gutter:20},{default:l(()=>[a(v,{span:16},{default:l(()=>[n.value.detailed_data?.trade_records&&n.value.detailed_data.trade_records.length>0||n.value.trades&&n.value.trades.length>0?(m(),D("div",Ke,[e[14]||(e[14]=d("h3",null,"交易记录",-1)),a(ke,{data:n.value.detailed_data?.trade_records||n.value.trades,stripe:"",style:{width:"100%"}},{default:l(()=>[a(B,{label:"日期",width:"180"},{default:l(s=>[f(i(s.row.datetime||s.row.date),1)]),_:1}),a(B,{label:"操作",width:"80"},{default:l(s=>[a(ee,{type:(s.row.type||s.row.action)==="buy"?"danger":"success"},{default:l(()=>[f(i((s.row.type||s.row.action)==="buy"?"买入":"卖出"),1)]),_:2},1032,["type"])]),_:1}),a(B,{prop:"price",label:"价格",width:"100"}),a(B,{label:"数量",width:"100"},{default:l(s=>[f(i(Math.abs(s.row.size||s.row.quantity)),1)]),_:1}),a(B,{label:"金额",width:"120"},{default:l(s=>[f(i(L(s.row.value||s.row.amount)),1)]),_:1}),n.value.detailed_data?.trade_records?(m(),C(B,{key:0,label:"手续费",width:"100"},{default:l(s=>[f(i(L(s.row.commission)),1)]),_:1})):k("",!0)]),_:1},8,["data"])])):k("",!0)]),_:1}),a(v,{span:8},{default:l(()=>[d("div",Oe,[e[15]||(e[15]=d("h3",null,"绩效指标",-1)),a(he,{column:1,border:""},{default:l(()=>[a(S,{label:"总收益率"},{default:l(()=>[f(i(R(n.value.performance?.total_return)),1)]),_:1}),a(S,{label:"年化收益率"},{default:l(()=>[f(i(R(n.value.performance?.annual_return)),1)]),_:1}),a(S,{label:"最大回撤"},{default:l(()=>[f(i(R(n.value.performance?.max_drawdown)),1)]),_:1}),a(S,{label:"夏普比率"},{default:l(()=>[f(i(n.value.performance?.sharpe_ratio?.toFixed(2)||"-"),1)]),_:1}),a(S,{label:"胜率"},{default:l(()=>[f(i(R(n.value.performance?.win_rate)),1)]),_:1}),a(S,{label:"交易次数"},{default:l(()=>[f(i(n.value.performance?.total_trades),1)]),_:1}),a(S,{label:"盈利交易"},{default:l(()=>[f(i(n.value.performance?.winning_trades),1)]),_:1}),a(S,{label:"亏损交易"},{default:l(()=>[f(i(n.value.performance?.losing_trades),1)]),_:1})]),_:1})])]),_:1})]),_:1}),n.value.detailed_data?.portfolio_values&&n.value.detailed_data.portfolio_values.length>0||n.value.portfolio_value&&n.value.portfolio_value.length>0?(m(),D("div",Qe,[d("div",{ref_key:"portfolioChartRef",ref:E,style:{height:"300px"}},null,512)])):k("",!0)]),_:1})])):k("",!0)])}}}),at=Fe(je,[["__scopeId","data-v-de9fa83d"]]);export{at as default};
