import{i as oe}from"./index-1yOyFXf9.js";import{x as q,d as re,a as g,G as $,y as se,W as le,D as ie,M as ue,c as M,e as f,w as y,i as A,E as k,b as z,f as D,g as G,k as Q,F as ce,A as de,l as H,J as pe,o as R,_ as fe}from"./index-Do2I22sE.js";const me="/django/api/strategy";async function ve(u,_){try{return(await q.get(`${me}/industry-turnover-percentile/`,{params:{start_date:u,end_date:_}})).data}catch(s){throw console.error("获取行业换手率分位数数据失败:",s),s}}const _e="/django/api/stock";async function ge(u,_,s,h){try{const m={};return u&&(m.industry=u),_&&(m.report_type=_),(await q.get(`${_e}/industry/heatmap-data/`,{params:m})).data}catch(m){throw console.error("获取行业热力图数据失败:",m),m}}var j=(u=>(u.OPERATING_REVENUE_GROWTH="avg_operating_revenue_growth_rate",u.NET_PROFIT_GROWTH="avg_net_profit_growth_rate",u.TOTAL_OPERATING_REVENUE="total_operating_revenue",u.TOTAL_NET_PROFIT="total_net_profit",u.EARNINGS_PER_SHARE="avg_earnings_per_share",u.ROE="avg_roe",u.GROSS_PROFIT_MARGIN="avg_gross_profit_margin",u.NET_ASSETS_PER_SHARE="avg_net_assets_per_share",u.OPERATING_CASH_FLOW_PER_SHARE="avg_operating_cash_flow_per_share",u))(j||{});const W={avg_operating_revenue_growth_rate:{name:"营业收入增长率",unit:"%",description:"平均营业收入增长率"},avg_net_profit_growth_rate:{name:"净利润增长率",unit:"%",description:"平均净利润增长率"},total_operating_revenue:{name:"总营业收入",unit:"亿元",description:"总营业收入",formatter:u=>(u/1e8).toFixed(2)},total_net_profit:{name:"总净利润",unit:"亿元",description:"总净利润",formatter:u=>(u/1e8).toFixed(2)},avg_earnings_per_share:{name:"每股收益",unit:"元",description:"平均每股收益"},avg_roe:{name:"净资产收益率",unit:"%",description:"平均净资产收益率"},avg_gross_profit_margin:{name:"毛利率",unit:"%",description:"平均毛利率"},avg_net_assets_per_share:{name:"每股净资产",unit:"元",description:"平均每股净资产"},avg_operating_cash_flow_per_share:{name:"每股经营现金流",unit:"元",description:"平均每股经营现金流"}},he={class:"congestion-heatmap"},xe={class:"header-controls"},ye={class:"controls"},we=re({__name:"CongestionHeatmap",setup(u){const _=g();let s=null;const h=g("amount"),m=g("20"),V=g(!0),w=g(""),B=g(!1),b=g("turnover"),L=g(j.OPERATING_REVENUE_GROWTH),T=g("annual"),N=g([]),O=g([]),P=g(null),F=async()=>{B.value=!0;try{b.value==="turnover"?await J():await K()}catch(r){console.error("获取数据出错:",r),k.error("获取数据出错，请检查网络连接或API服务是否可用")}finally{B.value=!1}},J=async()=>{const r=new Date,e=r.toISOString().split("T")[0],c=m.value==="all"?30:parseInt(m.value),p=new Date(r);p.setDate(r.getDate()-c);const i=p.toISOString().split("T")[0],n=await ve(i,e);if(n){const t=n.data;if(!Array.isArray(t))throw console.error("API返回的数据不是数组:",t),new Error("API返回的数据格式不正确");const l=[...new Set(t.map(d=>d.date))].sort();O.value=l;const o=new Map;t.forEach(d=>{o.has(d.sector_code)||o.set(d.sector_code,{name:d.sector_name,data:[]});const a=o.get(d.sector_code),v=l.indexOf(d.date);for(;a.data.length<l.length;)a.data.push({turnoverRateFQuantile:0,amountCongestionQuantile:0});a.data[v]={turnoverRateFQuantile:d.turnover_ratio_percentile,amountCongestionQuantile:d.turnover_ratio_percentile}}),N.value=Array.from(o.values())}else k.error("获取数据失败: ")},K=async()=>{const r=await ge(w.value.trim()||void 0,T.value,void 0,void 0);r?P.value=r:k.error("获取行业业绩数据失败")},X=()=>{let r=N.value;w.value.trim()&&(r=N.value.filter(p=>p.name.toLowerCase().includes(w.value.toLowerCase())));const e=m.value==="all"?O.value:O.value.slice(-parseInt(m.value)),c=r.map(p=>({...p,data:m.value==="all"?p.data:p.data.slice(-parseInt(m.value))}));return{dates:e,industries:c}},Y=()=>{_.value&&(s=oe(_.value),x())},x=()=>{if(s)if(b.value==="turnover"){const{dates:r,industries:e}=X();w.value.trim()?te(e,r):ee(e,r)}else Z()},Z=()=>{if(!s||!P.value)return;const r=P.value,e=r.dates,c=r.swCodeNames;let p=c;w.value.trim()&&(p=c.filter(a=>a.indexName.toLowerCase().includes(w.value.toLowerCase())));const i=[...p].sort((a,v)=>{const C=r.congestions[a.indexCode],E=r.congestions[v.indexCode];if(!C||!E||C.length===0||E.length===0)return 0;const I=C[C.length-1][L.value],S=E[E.length-1][L.value];return V.value?I-S:S-I}),n=[];let t=1/0,l=-1/0;i.forEach((a,v)=>{const C=r.congestions[a.indexCode];C&&C.forEach((E,I)=>{const S=E[L.value];n.push([I,v,S]),t=Math.min(t,S),l=Math.max(l,S)})});const o=W[L.value];s.clear();const d={tooltip:{position:"top",formatter:function(a){const[v,C,E]=a.data,I=e[v],S=i[C].indexName,ne=o.formatter?o.formatter(E):E.toFixed(2);return`${S}<br/>${I}<br/>${o.name}: ${ne}${o.unit}`}},grid:{height:Math.max(400,i.length*20)+"px",top:"2%",left:"15%",right:"16%",bottom:"2%",containLabel:!0},xAxis:[{type:"category",data:e,splitArea:{show:!0},axisLabel:{rotate:45,fontSize:10}},{type:"category",position:"top",data:e,axisTick:{show:!1},axisLine:{show:!1},axisLabel:{rotate:45,fontSize:10,margin:6},name:"报告期",nameLocation:"end",nameTextStyle:{fontSize:12}}],yAxis:[{type:"category",data:i.map(a=>a.indexName),splitArea:{show:!0},axisLabel:{fontSize:11}},{type:"category",position:"right",data:i.map(a=>a.indexName),axisTick:{show:!1},axisLine:{show:!1},axisLabel:{fontSize:11},name:"行业",nameLocation:"end",nameTextStyle:{fontSize:12}}],visualMap:{min:t,max:l,calculable:!0,orient:"vertical",right:"2%",top:"5%",inRange:{color:["#313695","#4575b4","#74add1","#abd9e9","#e0f3f8","#ffffbf","#fee090","#fdae61","#f46d43","#d73027","#a50026"]},text:["高","低"],textStyle:{fontSize:12}},series:[{name:o.name,type:"heatmap",data:n,label:{show:!0,fontSize:9,formatter:function(a){const v=a.data[2];return o.formatter?o.formatter(v):v.toFixed(1)}},emphasis:{itemStyle:{shadowBlur:10,shadowColor:"rgba(0, 0, 0, 0.5)"}}}]};if(s.setOption(d),_.value){const a=Math.max(500,i.length*22+120);_.value.style.height=a+"px",s.resize()}},ee=(r,e)=>{if(!s)return;const c=[...r].sort((n,t)=>{if(n.data.length===0||t.data.length===0)return 0;const l=n.data[n.data.length-1][h.value==="turnover"?"turnoverRateFQuantile":"amountCongestionQuantile"],o=t.data[t.data.length-1][h.value==="turnover"?"turnoverRateFQuantile":"amountCongestionQuantile"];return V.value?l-o:o-l}),p=[];c.forEach((n,t)=>{n.data.forEach((l,o)=>{const d=h.value==="turnover"?l.turnoverRateFQuantile:l.amountCongestionQuantile;p.push([o,t,d])})}),s.clear(),s.clear();const i={tooltip:{position:"top",formatter:function(n){const[t,l,o]=n.data,d=e[t],a=c[l].name,v=h.value==="turnover"?"等权换手率分位数":"成交金额占比分位数";return`${a}<br/>${d}<br/>${v}: ${o}`}},grid:{height:Math.max(400,c.length*20)+"px",top:"2%",left:"15%",right:"16%",bottom:"2%",containLabel:!0},xAxis:[{type:"category",data:e.map(n=>n.substring(5)),splitArea:{show:!0},axisLabel:{rotate:45,fontSize:10}},{type:"category",position:"top",data:e.map(n=>n.substring(5)),axisTick:{show:!1},axisLine:{show:!1},axisLabel:{rotate:45,fontSize:10,margin:6},name:"日期",nameLocation:"end",nameTextStyle:{fontSize:12}}],yAxis:[{type:"category",data:c.map(n=>n.name),splitArea:{show:!0},axisLabel:{fontSize:11}},{type:"category",position:"right",data:c.map(n=>n.name),axisTick:{show:!1},axisLine:{show:!1},axisLabel:{fontSize:11},name:"行业",nameLocation:"end",nameTextStyle:{fontSize:12}}],visualMap:{min:0,max:100,calculable:!0,orient:"vertical",right:"2%",top:"5%",inRange:{color:["#313695","#4575b4","#74add1","#abd9e9","#e0f3f8","#ffffbf","#fee090","#fdae61","#f46d43","#d73027","#a50026"]},text:["高","低"],textStyle:{fontSize:12}},series:[{name:h.value==="turnover"?"等权换手率分位数":"成交金额占比分位数",type:"heatmap",data:p,label:{show:!0,fontSize:9,formatter:function(n){return n.data[2]}},emphasis:{itemStyle:{shadowBlur:10,shadowColor:"rgba(0, 0, 0, 0.5)"}}}]};if(s.setOption(i),_.value){const n=Math.max(500,c.length*22+120);_.value.style.height=n+"px",s.resize()}},te=(r,e)=>{if(!s)return;const c=["#5470C6","#91CC75","#EE6666","#FAC858","#73C0DE","#3BA272","#FC8452","#9A60B4","#EA7CCC","#2f4554","#61a0a8","#d48265","#749f83","#ca8622","#bda29a","#6e7074","#546570","#c4ccd3"],p=t=>{let l=0;for(let o=0;o<t.length;o++)l=l*31+t.charCodeAt(o)>>>0;return c[l%c.length]},i=r.map(t=>{const l=p(t.name);return{name:t.name,type:"line",data:t.data.map(o=>h.value==="turnover"?o.turnoverRateFQuantile:o.amountCongestionQuantile),smooth:!0,symbol:"circle",symbolSize:6,lineStyle:{width:2,color:l},itemStyle:{color:l}}});s.clear();const n={title:{text:`行业拥挤度趋势图 - ${r.map(t=>t.name).join("、")}`,left:"center"},tooltip:{trigger:"axis",axisPointer:{type:"cross"},formatter:function(t){let l=`${t[0].axisValue}<br/>`;return t.forEach(o=>{const d=h.value==="turnover"?"等权换手率分位数":"成交金额占比分位数";l+=`${o.seriesName} ${d}: ${o.value}<br/>`}),l}},legend:{type:"scroll",data:r.map(t=>t.name),top:"5%"},grid:{left:"3%",right:"4%",bottom:"3%",top:"15%",containLabel:!0},xAxis:{type:"category",boundaryGap:!1,data:e.map(t=>t.substring(5)),axisLabel:{rotate:45}},yAxis:{type:"value",name:h.value==="turnover"?"等权换手率分位数":"成交金额占比分位数",min:0,max:100},series:i};s.setOption(n,!0),_.value&&(_.value.style.height="500px",s.resize())},ae=()=>{V.value=!V.value,x()},U=()=>{s&&s.resize()};return $([h,w],()=>{s&&x()}),$([b,L,T],async()=>{await F(),s&&x()}),$(m,async()=>{b.value==="turnover"&&(await F(),s&&x())}),se(async()=>{const r=le.service({target:".congestion-heatmap",text:"加载数据中...",background:"rgba(255, 255, 255, 0.7)"});try{await F(),await ie(),Y()}finally{r.close()}window.addEventListener("resize",U)}),ue(()=>{s&&s.dispose(),window.removeEventListener("resize",U)}),(r,e)=>{const c=A("el-radio-button"),p=A("el-radio-group"),i=A("el-option"),n=A("el-select"),t=A("el-icon"),l=A("el-input"),o=A("el-button"),d=A("el-card");return R(),M("div",he,[f(d,null,{header:y(()=>[z("div",xe,[e[8]||(e[8]=z("h3",null,"行业拥挤度热力图",-1)),z("div",ye,[f(p,{modelValue:b.value,"onUpdate:modelValue":e[0]||(e[0]=a=>b.value=a),onChange:x,size:"small"},{default:y(()=>[f(c,{label:"turnover"},{default:y(()=>[...e[5]||(e[5]=[Q("成交金额占比分位数",-1)])]),_:1}),f(c,{label:"performance"},{default:y(()=>[...e[6]||(e[6]=[Q("行业业绩指标",-1)])]),_:1})]),_:1},8,["modelValue"]),b.value==="performance"?(R(),D(n,{key:0,modelValue:L.value,"onUpdate:modelValue":e[1]||(e[1]=a=>L.value=a),onChange:x,placeholder:"选择指标",style:{width:"180px","margin-left":"10px"}},{default:y(()=>[(R(!0),M(ce,null,de(H(W),(a,v)=>(R(),D(i,{key:v,label:a.name,value:v},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])):G("",!0),b.value==="performance"?(R(),D(n,{key:1,modelValue:T.value,"onUpdate:modelValue":e[2]||(e[2]=a=>T.value=a),onChange:x,placeholder:"选择报告类型",style:{width:"120px","margin-left":"10px"}},{default:y(()=>[f(i,{label:"年报",value:"annual"}),f(i,{label:"中报",value:"semi_annual"}),f(i,{label:"一季报",value:"q1"}),f(i,{label:"三季报",value:"q3"}),f(i,{label:"季报",value:"quarterly"})]),_:1},8,["modelValue"])):G("",!0),b.value==="turnover"?(R(),D(n,{key:2,modelValue:m.value,"onUpdate:modelValue":e[3]||(e[3]=a=>m.value=a),onChange:x,placeholder:"选择日期范围",style:{width:"150px","margin-left":"10px"}},{default:y(()=>[f(i,{label:"最近10天",value:"10"}),f(i,{label:"最近15天",value:"15"}),f(i,{label:"最近20天",value:"20"}),f(i,{label:"全部29天",value:"all"})]),_:1},8,["modelValue"])):G("",!0),f(l,{modelValue:w.value,"onUpdate:modelValue":e[4]||(e[4]=a=>w.value=a),onInput:x,onClear:x,placeholder:"搜索行业",style:{width:"200px","margin-left":"10px"},clearable:""},{prefix:y(()=>[f(t,null,{default:y(()=>[f(H(pe))]),_:1})]),_:1},8,["modelValue"]),f(o,{onClick:ae,type:"primary"},{default:y(()=>[...e[7]||(e[7]=[Q("按最后一列排序",-1)])]),_:1})])])]),default:y(()=>[z("div",{ref_key:"chartContainer",ref:_,class:"chart-container"},null,512)]),_:1})])}}}),Ee=fe(we,[["__scopeId","data-v-df278f0d"]]);export{Ee as default};
