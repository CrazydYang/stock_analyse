import{d as P,a as N,G as z,C as U,M as E,N as W,c as Y,b as f,g as O,t as C,O as q,o as D,_ as H,r as A,e as r,w as i,i as v,E as V,f as B,F as J,A as G,k as I}from"./index-BOpQlxeb.js";import{i as Z}from"./index-OzhOYD-U.js";const Q={class:"stock-kline-chart-container"},X={class:"chart-header"},ee={key:0},te=P({__name:"StockKLineChart",props:{title:{default:""},stockCode:{},stockName:{default:""},klineData:{},tradeSignals:{default:()=>[]},height:{default:"600px"}},setup(d){q(p=>({"7a8900b8":e.height}));const e=d,s=N();let a=null;const c=()=>{s.value&&(a&&a.dispose(),a=Z(s.value),g(),window.addEventListener("resize",x))},g=()=>{if(!a||!e.klineData||e.klineData.length===0)return;const p=e.klineData.map(t=>t.date),b=e.klineData.map(t=>[t.open_price,t.close_price,t.low_price,t.high_price]),S=t=>t?t.replace(/[^0-9]/g,""):"",L=new Map;p.forEach((t,y)=>{L.set(S(t),y)});const F=(t,y)=>{if(!t||!Array.isArray(t)||t.length===0)return[];const u=[...t].filter(l=>l.type===y).sort((l,w)=>{const m=S(l.date),_=S(w.date);return m.localeCompare(_)}),k=new Set;return console.log(`生成${y}信号标记，数量:`,u.length),y==="sell"&&console.log("卖出信号原始数据:",JSON.stringify(u)),u.map(l=>{const w=L.get(S(l.date));if(w===void 0)return console.log(`信号日期${l.date}不在K线数据范围内`),null;const m=S(l.date);if(k.has(m))return console.log(`日期${l.date}已有标记，跳过`),null;k.add(m);const _=y==="buy";return{name:_?"买入点":"卖出点",coord:[p[w],l.price],symbol:"arrow",symbolSize:50,symbolRotate:_?0:180,symbolOffset:[0,_?-100:20],value:l.price,itemStyle:{color:_?"#FF0000":"#00FF00",borderColor:"#fff",borderWidth:2},label:{show:!0,color:"#fff",backgroundColor:"rgba(255,0,0,0.7)",padding:[5,10],borderRadius:4,position:_?"top":"bottom",formatter:_?`买入
${l.price.toFixed(2)}元`:`卖出
${l.price.toFixed(2)}元`,fontSize:14,fontWeight:"bold"},tooltip:{formatter:_?`买入
价格: ${l.price.toFixed(2)}
${l.description||""}`:`卖出
价格: ${l.price.toFixed(2)}
${l.description||""}`}}}).filter(l=>l!==null)};console.log("更新图表，交易信号数量:",e.tradeSignals.length),console.log("交易信号详情:",JSON.stringify(e.tradeSignals));const T=F(e.tradeSignals,"buy"),n=F(e.tradeSignals,"sell");console.log("生成的买入信号数量:",T.length),console.log("生成的卖出信号数量:",n.length),console.log("卖出信号详情:",JSON.stringify(n));const o={title:{text:e.title||`${e.stockName}(${e.stockCode})K线图`,left:"center"},tooltip:{trigger:"axis",axisPointer:{type:"cross"},formatter:t=>{let u=`<div style="font-weight:bold;margin-bottom:5px;">${t[0].axisValue}</div>`;return t.forEach(k=>{const l=k.color,w=k.seriesName,m=k.value;w==="K线"&&(u+=`<div style="color:${l};">${w}</div>`,u+=`<div>开盘价: ${m[0]}</div>`,u+=`<div>收盘价: ${m[1]}</div>`,u+=`<div>最低价: ${m[2]}</div>`,u+=`<div>最高价: ${m[3]}</div>`)}),u}},grid:{left:"10%",right:"10%",top:"15%",bottom:"15%"},xAxis:{type:"category",data:p,boundaryGap:!1,axisLine:{onZero:!1},splitLine:{show:!1}},yAxis:{scale:!0,splitArea:{show:!0}},dataZoom:[{type:"inside",start:0,end:100},{show:!0,type:"slider",bottom:"5%",start:0,end:100}],series:[{name:"K线",type:"candlestick",data:b.map(t=>[t[0],t[1],t[3],t[2]]),markPoint:{symbol:"arrow",symbolSize:50,data:[...T,...n],clipByCoordinateSystem:!1,silent:!1,animation:!1,avoidLabelOverlap:!0,zlevel:10,emphasis:{disabled:!1},label:{fontSize:14,fontWeight:"bold",padding:[5,10],borderRadius:4,show:!0,formatter:function(t){return t.data&&t.data.name==="卖出点"?`卖出
${t.data.value.toFixed(2)}元`:t.data&&t.data.name==="买入点"?`买入
${t.data.value.toFixed(2)}元`:t.name}},itemStyle:{borderWidth:2,borderColor:"#fff",color:function(t){return t.data.name==="卖出点"?"#00FF00":"#FF0000"}}},itemStyle:{color:"#ec0000",color0:"#00da3c",borderColor:"#8A0000",borderColor0:"#008F28"}}]};a.setOption(o,!0)},x=()=>{a?.resize()};return z([()=>e.klineData,()=>e.tradeSignals],()=>{E(()=>{g()})},{deep:!0,immediate:!0}),z(()=>e.tradeSignals,()=>{E(()=>{g()})},{deep:!0,immediate:!0}),U(()=>{E(()=>{c()})}),W(()=>{a&&(a.dispose(),a=null),window.removeEventListener("resize",x)}),(p,b)=>(D(),Y("div",Q,[f("div",X,[p.title?(D(),Y("h3",ee,C(p.title),1)):O("",!0)]),f("div",{ref_key:"chartContainer",ref:s,class:"chart-container"},null,512)]))}}),ae=H(te,[["__scopeId","data-v-517c2dc2"]]),R="/django/api/individual_stock";async function oe(d,e,s,a=""){try{const c=new URLSearchParams;e&&c.append("start_date",e),s&&c.append("end_date",s),a&&c.append("adjust",a);const g=c.toString()?`?${c.toString()}`:"",x=`${R}/stocks/${d}/history/${g}`,p=await fetch(x);if(!p.ok)throw new Error(`HTTP error! status: ${p.status}`);const b=await p.json();if(b.code!==200)throw new Error(b.message||"获取股票历史数据失败");return b.data}catch(c){throw console.error(`获取股票 ${d} 历史数据失败:`,c),c}}async function re(d){try{const e=await fetch(`${R}/stocks/${d}/info/`);if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const s=await e.json();if(s.code!==200)throw new Error(s.message||"获取股票详细信息失败");return s.data}catch(e){throw console.error(`获取股票 ${d} 详细信息失败:`,e),e}}async function ne(d=1,e=20){try{const s=new URLSearchParams;s.append("page",d.toString()),s.append("page_size",e.toString());const a=await fetch(`${R}/stocks/?${s.toString()}`);if(!a.ok)throw new Error(`HTTP error! status: ${a.status}`);const c=await a.json();if(c.code!==200)throw new Error(c.message||"获取股票列表失败");return{total:c.data.total,data:c.data.data}}catch(s){throw console.error("获取股票列表失败:",s),s}}function $(d){const e=typeof d=="string"?new Date(d):d,s=e.getFullYear(),a=String(e.getMonth()+1).padStart(2,"0"),c=String(e.getDate()).padStart(2,"0");return`${s}${a}${c}`}function M(d){const e=new Date;return e.setDate(e.getDate()-d),e}const se={class:"stock-kline-view"},le={class:"control-panel"},ce={key:0,class:"chart-container"},ie={class:"card-header"},de={class:"stock-info"},ue={key:1,class:"empty-state"},fe=P({__name:"StockKLineView",setup(d){const e=A({stockCode:"",stockName:"",dateRangeType:"month",startDate:"",endDate:""}),s=N([]),a=A({code:"",name:"",industry:"",listDate:"",totalMarketCap:0,circulatingMarketCap:0}),c=N([]),g=N(!1),x=n=>{const o=c.value.find(t=>t.code===n);o&&(e.stockCode=o.code,e.stockName=o.name,p(o.code))},p=async n=>{try{const o=await re(n);a.code=o.code,a.name=o.name,a.industry=o.industry,a.listDate=o.list_date,a.totalMarketCap=o.total_market_cap,a.circulatingMarketCap=o.circulating_market_cap}catch(o){console.error("获取股票详细信息失败:",o),V.error("获取股票详细信息失败")}},b=()=>{const o=$(new Date);switch(e.endDate=o,e.dateRangeType){case"week":e.startDate=$(M(7));break;case"month":e.startDate=$(M(30));break;case"threeMonths":e.startDate=$(M(90));break;case"sixMonths":e.startDate=$(M(180));break;case"year":e.startDate=$(M(365));break;case"threeYears":e.startDate=$(M(365*3));break;case"all":e.startDate="";break}},S=async()=>{if(!e.stockCode){V.warning("请选择股票");return}g.value=!0;try{let n=e.startDate,o=e.endDate;n&&(n=n.replace(/-/g,"")),o&&(o=o.replace(/-/g,""));const t=await oe(e.stockCode,n,o);s.value=t,t.length===0&&V.warning("未查询到股票历史数据")}catch(n){console.error("获取股票数据失败:",n),V.error("获取股票数据失败")}finally{g.value=!1}},L=()=>{e.stockCode="",e.stockName="",e.dateRangeType="month",e.startDate="",e.endDate="",s.value=[],a.code="",a.name="",a.industry="",a.listDate="",a.totalMarketCap=0,a.circulatingMarketCap=0},F=n=>n?n>=1e8?`${(n/1e8).toFixed(2)}亿`:n>=1e4?`${(n/1e4).toFixed(2)}万`:n.toString():"未知",T=async()=>{try{g.value=!0;const{data:n}=await ne(1,100);c.value=n}catch(n){console.error("加载股票列表失败:",n),V.error("加载股票列表失败")}finally{g.value=!1}};return U(()=>{b(),T()}),(n,o)=>{const t=v("el-option"),y=v("el-select"),u=v("el-form-item"),k=v("el-col"),l=v("el-row"),w=v("el-date-picker"),m=v("el-button"),_=v("el-form"),K=v("el-card"),j=v("el-empty");return D(),Y("div",se,[o[7]||(o[7]=f("div",{class:"page-header"},[f("h1",null,"股票K线图分析"),f("p",null,"查看个股历史K线数据，支持技术指标分析")],-1)),f("div",le,[r(K,null,{header:i(()=>[...o[4]||(o[4]=[f("div",{class:"card-header"},[f("span",null,"查询条件")],-1)])]),default:i(()=>[r(_,{model:e,"label-width":"100px",class:"query-form"},{default:i(()=>[r(l,{gutter:20},{default:i(()=>[r(k,{span:8},{default:i(()=>[r(u,{label:"股票代码"},{default:i(()=>[r(y,{modelValue:e.stockCode,"onUpdate:modelValue":o[0]||(o[0]=h=>e.stockCode=h),placeholder:"请选择股票",class:"full-width",onChange:x},{default:i(()=>[(D(!0),Y(J,null,G(c.value,h=>(D(),B(t,{key:h.code,label:`${h.code} ${h.name}`,value:h.code},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1}),r(k,{span:8},{default:i(()=>[r(u,{label:"时间范围"},{default:i(()=>[r(y,{modelValue:e.dateRangeType,"onUpdate:modelValue":o[1]||(o[1]=h=>e.dateRangeType=h),onChange:b,class:"full-width"},{default:i(()=>[r(t,{label:"最近一周",value:"week"}),r(t,{label:"最近一月",value:"month"}),r(t,{label:"最近三月",value:"threeMonths"}),r(t,{label:"最近六月",value:"sixMonths"}),r(t,{label:"最近一年",value:"year"}),r(t,{label:"最近三年",value:"threeYears"}),r(t,{label:"全部",value:"all"}),r(t,{label:"自定义",value:"custom"})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),e.dateRangeType==="custom"?(D(),B(l,{key:0,gutter:20},{default:i(()=>[r(k,{span:8},{default:i(()=>[r(u,{label:"开始日期"},{default:i(()=>[r(w,{modelValue:e.startDate,"onUpdate:modelValue":o[2]||(o[2]=h=>e.startDate=h),type:"date",placeholder:"选择开始日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",class:"full-width"},null,8,["modelValue"])]),_:1})]),_:1}),r(k,{span:8},{default:i(()=>[r(u,{label:"结束日期"},{default:i(()=>[r(w,{modelValue:e.endDate,"onUpdate:modelValue":o[3]||(o[3]=h=>e.endDate=h),type:"date",placeholder:"选择结束日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",class:"full-width"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})):O("",!0),r(u,null,{default:i(()=>[r(m,{type:"primary",onClick:S},{default:i(()=>[...o[5]||(o[5]=[I("查询",-1)])]),_:1}),r(m,{onClick:L},{default:i(()=>[...o[6]||(o[6]=[I("重置",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1})]),s.value.length>0?(D(),Y("div",ce,[r(K,null,{header:i(()=>[f("div",ie,[f("span",null,C(a.name)+"("+C(a.code)+") K线图",1),f("div",de,[f("span",null,"行业: "+C(a.industry||"未知"),1),f("span",null,"上市日期: "+C(a.listDate||"未知"),1),f("span",null,"总市值: "+C(F(a.totalMarketCap)),1),f("span",null,"流通市值: "+C(F(a.circulatingMarketCap)),1)])])]),default:i(()=>[r(ae,{"stock-code":a.code,"stock-name":a.name,"kline-data":s.value,height:"600px","show-volume":!0},null,8,["stock-code","stock-name","kline-data"])]),_:1})])):(D(),Y("div",ue,[r(j,{description:"请选择股票并查询数据"})]))])}}}),he=H(fe,[["__scopeId","data-v-7cce85c9"]]);export{he as default};
