import{d as fe,a as c,z as O,y as pe,j as me,E,M as he,c as S,b as e,G as Y,e as s,w as l,i as _,g as ee,t as r,H as be,f as K,L as we,u as ye,k as I,l as T,P as ge,Q as xe,C as L,R as ke,S as Se,T as Le,o as w,_ as Ce}from"./index-CQOkaYGk.js";import{i as N}from"./index-1yOyFXf9.js";import{b as De,e as Re,f as Ae}from"./quantBacktestApi-DfKsyIzI.js";const ze={class:"backtest-result-view"},Fe={class:"page-header"},Be={class:"header-content"},Ie={key:0},Te={class:"content-container"},Me={class:"basic-stats-section"},$e={key:0,class:"stats-container"},Ve={class:"backtest-period"},Oe={class:"period-item"},Ee={class:"period-value"},Ne={class:"main-stats"},Pe={class:"main-stat-item"},Ge={class:"stat-icon positive-bg"},je={class:"stat-content"},Ue={class:"main-stat-item"},We={class:"stat-icon info-bg"},Ze={class:"stat-content"},He={class:"main-stat-item"},qe={class:"stat-icon warning-bg"},Ke={class:"stat-content"},Qe={class:"stat-value negative"},Je={class:"main-stat-item"},Xe={class:"stat-icon success-bg"},Ye={class:"stat-content"},et={class:"stat-value"},tt={class:"funds-info"},at={class:"fund-item"},st={class:"fund-icon"},ot={class:"fund-content"},lt={class:"fund-value"},rt={class:"fund-item"},it={class:"fund-icon"},nt={class:"fund-content"},dt={class:"secondary-stats"},ct={class:"secondary-stat-item"},ut={class:"stat-header"},_t={class:"stat-value"},vt={class:"stat-progress"},ft={class:"stat-description"},pt={class:"secondary-stat-item"},mt={class:"stat-header"},ht={class:"stat-badge"},bt={class:"stat-value"},wt={class:"stat-description"},yt={class:"secondary-stat-item"},gt={class:"stat-header"},xt={class:"stat-badge success"},kt={class:"stat-value positive"},St={class:"stat-description"},Lt={class:"secondary-stat-item"},Ct={class:"stat-header"},Dt={class:"stat-badge danger"},Rt={class:"stat-value negative"},At={class:"stat-description"},zt={class:"secondary-stat-item"},Ft={class:"stat-header"},Bt={class:"stat-value"},It={class:"secondary-stat-item"},Tt={class:"stat-header"},Mt={class:"stat-badge info"},$t={class:"stat-value"},Vt={class:"charts-section"},Ot={class:"chart-container"},Et={class:"observer-charts-container"},Nt={class:"date-value"},Pt={class:"price-value"},Gt={class:"quantity-value"},jt={class:"amount-value"},Ut={key:1,class:"text-muted"},Wt={class:"commission-value"},Zt={class:"remark-text"},Ht=fe({__name:"BacktestResultView",setup(qt){const te=me(),ae=ye(),M=c(!1),C=c(""),o=c(null),f=c(null),y=c(null),h=c(null),se=c(null);c("ALL"),c(""),c(""),c(null);const P=c(),G=c(),j=c(),U=c();c();const x=c([]);let D=null,R=null,A=null,z=null;const oe=async()=>{try{const t=await De(C.value);o.value={task_id:t.task_info.task_id,strategy_name:t.task_info.strategy_name,symbol:t.task_info.stock_code,period:{start_date:t.task_info.start_date,end_date:t.task_info.end_date},detailed_data:t.detailed_data,performance:{total_return:t.performance.total_return,annual_return:t.performance.annual_return,max_drawdown:t.performance.max_drawdown,sharpe_ratio:t.performance.sharpe_ratio||0,win_rate:t.performance.win_rate||0,total_trades:t.performance.total_trades,winning_trades:t.performance.winning_trades,losing_trades:t.performance.losing_trades,initial_value:t.performance.initial_value,final_value:t.performance.final_value,volatility:t.performance.volatility||0},portfolio_value:t.detailed_data?.portfolio_values||t.portfolio_value||[],trades:t.detailed_data?.trade_records||t.trades||[]},o.value&&(x.value=o.value.trades)}catch(t){console.error("获取回测结果失败:",t),E.error("获取回测结果失败")}},le=async()=>{try{const t=await Re(C.value);f.value=t.data,h.value=t.data.task_info}catch(t){console.error("获取观测器数据失败:",t),E.error("获取观测器数据失败")}},re=async()=>{try{const t=await Ae(C.value);y.value=t.data,se.value=t.data.indicator_data}catch(t){console.error("获取原始数据和指标数据失败:",t),E.error("获取原始数据和指标数据失败")}},ie=async()=>{if(await we(),f.value?.observer_data?.broker?f.value.observer_data.broker.map(t=>t.datetime.split(" ")[0]):y.value?.raw_data&&y.value.raw_data.datetime,U.value&&y.value?.raw_data){z=N(U.value);const t=y.value.raw_data,a=t.datetime||[],n=a.map((u,m)=>t.close[m]),p=[],i=[];f.value?.observer_data?.buysell&&f.value.observer_data.buysell.forEach(u=>{const m=a.findIndex(B=>B.startsWith(u.datetime.split(" ")[0]));m!==-1&&(u.size>0?p.push([m,u.price]):i.push([m,u.price]))});const v=[{name:"收盘价",type:"line",data:n,smooth:!0,showSymbol:!1,lineStyle:{width:2,color:"#5470c6"},z:5},{name:"买入",type:"scatter",data:p,symbolSize:8,itemStyle:{color:"#67C23A"},symbol:"triangle"},{name:"卖出",type:"scatter",data:i,symbolSize:8,itemStyle:{color:"#F56C6C"},symbol:"triangle",symbolRotate:180}];if(y.value?.indicator_data){const u=y.value.indicator_data,m=["#5470c6","#91cc75","#fac858","#ee6666","#73c0de","#3ba272","#fc8452","#9a60b4","#ea7ccc","#2f4554"];let B=0;Object.keys(u).forEach(g=>{if(u[g]){const Z=g.toLowerCase().includes("crossover"),H=g.toLowerCase().includes("signal"),q=Z||H?1:0,V=m[B++%m.length];v.push({name:g,type:"line",data:u[g],smooth:!0,showSymbol:!1,yAxisIndex:q,lineStyle:{width:1.5,color:V}})}})}const k={tooltip:{trigger:"axis",axisPointer:{type:"cross"}},legend:{data:["收盘价","买入","卖出",...Object.keys(y.value?.indicator_data||{})],type:"scroll",orient:"horizontal",top:0,textStyle:{fontSize:11},pageButtonItemGap:5,pageButtonGap:5},grid:{left:"3%",right:"4%",bottom:"15%",top:"60px",containLabel:!0},xAxis:{type:"category",data:a,scale:!0,boundaryGap:!1,axisLine:{onZero:!1},splitLine:{show:!1},axisLabel:{rotate:45,interval:"auto",formatter:function(u){return u.substring(5,10)}}},yAxis:[{name:"价格",type:"value",scale:!0,position:"left",axisLine:{show:!1},axisTick:{show:!1},axisLabel:{color:"#909399",fontSize:10},splitLine:{show:!0,lineStyle:{type:"dashed",color:"#ebeef5"}}},{name:"指标值",type:"value",scale:!0,position:"right",axisLine:{show:!1},axisTick:{show:!1},axisLabel:{color:"#909399",fontSize:10},splitLine:{show:!1}}],dataZoom:[{type:"inside",start:0,end:100},{show:!0,type:"slider",bottom:0,start:0,end:100}],series:v};z.setOption(k)}if(P.value&&f.value?.observer_data?.broker){D=N(P.value);const t=f.value.observer_data.broker,a=t.map(v=>v.datetime.split(" ")[0]),n=t.map(v=>v.value),p=t.map(v=>v.cash),i={tooltip:{trigger:"axis",formatter:v=>{let k=`${v[0].axisValue}<br/>`;return v.forEach(u=>{k+=`${u.seriesName}: ¥${u.value.toLocaleString()}<br/>`}),k}},grid:{left:"3%",right:"4%",bottom:"0%",top:"3%",containLabel:!0,height:60},xAxis:{type:"category",data:a,axisLabel:{show:!1},axisLine:{show:!1},axisTick:{show:!1}},yAxis:{type:"value",axisLine:{show:!1},axisTick:{show:!1},splitLine:{show:!0,lineStyle:{type:"dashed",color:"#ebeef5"}},axisLabel:{color:"#909399",fontSize:10,formatter:v=>`¥${(v/1e3).toFixed(0)}K`}},series:[{name:"总资产",type:"line",data:n,smooth:!0,showSymbol:!1,lineStyle:{color:"#5470c6",width:2},areaStyle:{color:{type:"linear",x:0,y:0,x2:0,y2:1,colorStops:[{offset:0,color:"rgba(84, 112, 198, 0.3)"},{offset:1,color:"rgba(84, 112, 198, 0.1)"}]}}},{name:"现金",type:"line",data:p,smooth:!0,showSymbol:!1,lineStyle:{color:"#67C23A",width:1.5}}]};D.setOption(i)}if(G.value&&f.value?.observer_data?.timereturn){R=N(G.value);const t=f.value.observer_data.timereturn,a=t.map(i=>i.datetime.split(" ")[0]),n=t.map(i=>i.timereturn*100),p={tooltip:{trigger:"axis",formatter:i=>`${i[0].axisValue}<br/>收益率: ${i[0].value.toFixed(2)}%`},grid:{left:"3%",right:"4%",bottom:"0%",top:"3%",containLabel:!0,height:60},xAxis:{type:"category",data:a,axisLabel:{show:!1},axisLine:{show:!1},axisTick:{show:!1}},yAxis:{type:"value",axisLine:{show:!1},axisTick:{show:!1},splitLine:{show:!0,lineStyle:{type:"dashed",color:"#ebeef5"}},axisLabel:{color:"#909399",fontSize:10,formatter:i=>`${i.toFixed(1)}%`}},series:[{name:"收益率",type:"line",data:n,smooth:!0,showSymbol:!1,lineStyle:{color:"#91cc75",width:2},areaStyle:{color:{type:"linear",x:0,y:0,x2:0,y2:1,colorStops:[{offset:0,color:"rgba(145, 204, 117, 0.3)"},{offset:1,color:"rgba(145, 204, 117, 0.1)"}]}}}]};R.setOption(p)}if(j.value&&f.value?.observer_data?.drawdown){A=N(j.value);const t=f.value.observer_data.drawdown,a=t.map(i=>i.datetime.split(" ")[0]),n=t.map(i=>i.drawdown*100),p={tooltip:{trigger:"axis",formatter:i=>`${i[0].axisValue}<br/>回撤: ${i[0].value.toFixed(2)}%`},grid:{left:"3%",right:"4%",bottom:"5%",top:"3%",containLabel:!0,height:60},xAxis:{type:"category",data:a,axisLabel:{show:!1},axisLine:{show:!1},axisTick:{show:!1}},yAxis:{type:"value",axisLine:{show:!1},axisTick:{show:!1},splitLine:{show:!0,lineStyle:{type:"dashed",color:"#ebeef5"}},axisLabel:{color:"#909399",fontSize:10,formatter:i=>`${i.toFixed(1)}%`}},dataZoom:[{type:"inside",xAxisIndex:0,start:0,end:100},{show:!1,xAxisIndex:0,type:"slider",bottom:0,start:0,end:100}],series:[{name:"回撤",type:"line",data:n,smooth:!0,showSymbol:!1,lineStyle:{color:"#ee6666",width:2},areaStyle:{color:{type:"linear",x:0,y:0,x2:0,y2:1,colorStops:[{offset:0,color:"rgba(238, 102, 102, 0.5)"},{offset:1,color:"rgba(238, 102, 102, 0.2)"}]}},emphasis:{focus:"series",itemStyle:{shadowBlur:10,shadowColor:"rgba(238, 102, 102, 0.5)"}}}]};A.setOption(p)}},$=t=>t>0?"positive":t<0?"negative":"",F=t=>t==null?"0.00%":`${t.toFixed(2)}%`,Q=t=>t==null?"0.00":t.toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2}),ne=t=>t>=70?"#67c23a":t>=50?"#e6a23c":"#f56c6c",de=(t,a)=>Math.abs(t)<.1&&a>1.5?"low-risk":Math.abs(t)<.2&&a>1?"medium-risk":"high-risk",ce=(t,a)=>Math.abs(t)<.1&&a>1.5?"低风险":Math.abs(t)<.2&&a>1?"中风险":"高风险";O(()=>x.value.length),O(()=>x.value.filter(t=>t.type==="buy").length),O(()=>x.value.filter(t=>t.type==="sell").length),O(()=>x.value.reduce((t,a)=>t+a.value,0));const W=t=>t.split("T")[0],J=()=>{ae.push({name:"BacktestHistory"})};pe(async()=>{if(C.value=te.params.taskId,!C.value){E.error("缺少任务ID参数"),J();return}M.value=!0;try{await Promise.all([oe(),le(),re()]),await ie()}catch(t){console.error("页面初始化失败:",t)}finally{M.value=!1}});const ue=()=>{D&&(D.dispose(),D=null),R&&(R.dispose(),R=null),A&&(A.dispose(),A=null),z&&(z.dispose(),z=null)};return he(()=>{ue()}),(t,a)=>{const n=_("el-icon"),p=_("el-button"),i=_("Money"),v=_("Wallet"),k=_("ArrowUp"),u=_("ArrowDown"),m=_("el-progress"),B=_("DataLine"),g=_("CircleCheck"),Z=_("CircleClose"),H=_("Shield"),q=_("Scale"),V=_("el-card"),b=_("el-table-column"),_e=_("el-tag"),ve=_("el-table"),X=be("loading");return w(),S("div",ze,[e("div",Fe,[s(p,{type:"primary",onClick:J,class:"back-button"},{default:l(()=>[s(n,null,{default:l(()=>[s(T(ge))]),_:1}),a[0]||(a[0]=I(" 返回 ",-1))]),_:1}),e("div",Be,[a[1]||(a[1]=e("h1",null,"回测结果详情",-1)),h.value?(w(),S("p",Ie,r(h.value.strategy_name)+" - "+r(h.value.stock_name)+"("+r(h.value.stock_code)+")",1)):ee("",!0)])]),Y((w(),S("div",Te,[e("div",Me,[s(V,{class:"stats-card"},{header:l(()=>[...a[2]||(a[2]=[e("div",{class:"card-header"},[e("span",{class:"card-title"},"回测基本数据")],-1)])]),default:l(()=>[o.value?(w(),S("div",$e,[e("div",Ve,[e("div",Oe,[a[3]||(a[3]=e("span",{class:"period-label"},"回测区间:",-1)),e("span",Ee,r(W(h.value.start_date))+" 至 "+r(W(h.value.end_date)),1)])]),e("div",Ne,[e("div",Pe,[e("div",Ge,[s(n,null,{default:l(()=>[s(T(xe))]),_:1})]),e("div",je,[a[4]||(a[4]=e("div",{class:"stat-label"},"总收益率",-1)),e("div",{class:L(["stat-value",$(o.value.performance.total_return)])},r(F(o.value.performance.total_return)),3)])]),e("div",Ue,[e("div",We,[s(n,null,{default:l(()=>[s(T(ke))]),_:1})]),e("div",Ze,[a[5]||(a[5]=e("div",{class:"stat-label"},"年化收益率",-1)),e("div",{class:L(["stat-value",$(o.value.performance.annual_return)])},r(F(o.value.performance.annual_return)),3)])]),e("div",He,[e("div",qe,[s(n,null,{default:l(()=>[s(T(Se))]),_:1})]),e("div",Ke,[a[6]||(a[6]=e("div",{class:"stat-label"},"最大回撤",-1)),e("div",Qe,r(F(o.value.performance.max_drawdown)),1)])]),e("div",Je,[e("div",Xe,[s(n,null,{default:l(()=>[s(T(Le))]),_:1})]),e("div",Ye,[a[7]||(a[7]=e("div",{class:"stat-label"},"夏普比率",-1)),e("div",et,r(o.value.performance.sharpe_ratio.toFixed(2)),1)])])]),e("div",tt,[e("div",at,[e("div",st,[s(n,null,{default:l(()=>[s(i)]),_:1})]),e("div",ot,[a[8]||(a[8]=e("div",{class:"fund-label"},"初始资金",-1)),e("div",lt,"¥"+r(Q(h.value.initial_cash)),1)])]),e("div",rt,[e("div",it,[s(n,null,{default:l(()=>[s(v)]),_:1})]),e("div",nt,[a[9]||(a[9]=e("div",{class:"fund-label"},"最终资金",-1)),e("div",{class:L(["fund-value",$(o.value.performance.final_value-h.value.initial_cash)])}," ¥"+r(Q(o.value.performance.final_value)),3)])])]),e("div",dt,[e("div",ct,[e("div",ut,[a[10]||(a[10]=e("div",{class:"stat-label"},"胜率",-1)),e("div",{class:L(["trend-indicator",o.value.performance.win_rate>=.6?"trend-up":"trend-down"])},[o.value.performance.win_rate>=.6?(w(),K(n,{key:0},{default:l(()=>[s(k)]),_:1})):(w(),K(n,{key:1},{default:l(()=>[s(u)]),_:1}))],2)]),e("div",_t,r(F(o.value.performance.win_rate)),1),e("div",vt,[s(m,{percentage:o.value.performance.win_rate,"show-text":!1,"stroke-width":6,color:ne(o.value.performance.win_rate)},null,8,["percentage","color"])]),e("div",ft,r(o.value.performance.win_rate>=.6?"表现优秀":o.value.performance.win_rate>=.4?"表现一般":"需要改进"),1)]),e("div",pt,[e("div",mt,[a[11]||(a[11]=e("div",{class:"stat-label"},"总交易次数",-1)),e("div",ht,[s(n,null,{default:l(()=>[s(B)]),_:1})])]),e("div",bt,r(o.value.performance.total_trades),1),e("div",wt," 交易频率: "+r((o.value.performance.total_trades/252).toFixed(1))+"/年 ",1)]),e("div",yt,[e("div",gt,[a[12]||(a[12]=e("div",{class:"stat-label"},"盈利交易",-1)),e("div",xt,[s(n,null,{default:l(()=>[s(g)]),_:1})])]),e("div",kt,r(o.value.performance.winning_trades),1),e("div",St," 占比: "+r((o.value.performance.winning_trades/o.value.performance.total_trades*100).toFixed(1))+"% ",1)]),e("div",Lt,[e("div",Ct,[a[13]||(a[13]=e("div",{class:"stat-label"},"亏损交易",-1)),e("div",Dt,[s(n,null,{default:l(()=>[s(Z)]),_:1})])]),e("div",Rt,r(o.value.performance.losing_trades),1),e("div",At," 占比: "+r((o.value.performance.losing_trades/o.value.performance.total_trades*100).toFixed(1))+"% ",1)]),e("div",zt,[e("div",Ft,[a[14]||(a[14]=e("div",{class:"stat-label"},"风险评级",-1)),e("div",{class:L(["risk-level",de(o.value.performance.max_drawdown,o.value.performance.sharpe_ratio)])},[s(n,null,{default:l(()=>[s(H)]),_:1})],2)]),e("div",Bt,r(ce(o.value.performance.max_drawdown,o.value.performance.sharpe_ratio)),1),a[15]||(a[15]=e("div",{class:"stat-description"}," 基于回撤和夏普比率 ",-1))]),e("div",It,[e("div",Tt,[a[16]||(a[16]=e("div",{class:"stat-label"},"收益风险比",-1)),e("div",Mt,[s(n,null,{default:l(()=>[s(q)]),_:1})])]),e("div",$t,r((Math.abs(o.value.performance.total_return)/Math.abs(o.value.performance.max_drawdown)).toFixed(2)),1),a[17]||(a[17]=e("div",{class:"stat-description"}," 收益/最大回撤 ",-1))])])])):ee("",!0)]),_:1})]),e("div",Vt,[s(V,{class:"chart-card main-chart"},{header:l(()=>[...a[18]||(a[18]=[e("div",{class:"card-header"},[e("span",{class:"card-title"},"价格走势与交易信号")],-1)])]),default:l(()=>[e("div",Ot,[e("div",{ref_key:"klineChartRef",ref:U,class:"chart main-chart-content"},null,512),a[19]||(a[19]=e("div",{class:"observer-legend",style:{"margin-top":"10px","margin-bottom":"5px","text-align":"center"}},[e("span",{class:"legend-item"},[e("span",{class:"color-dot broker-color"}),I("资金曲线")]),e("span",{class:"legend-item"},[e("span",{class:"color-dot return-color"}),I("收益率曲线")]),e("span",{class:"legend-item"},[e("span",{class:"color-dot drawdown-color"}),I("回撤曲线")])],-1)),e("div",Et,[e("div",{ref_key:"brokerChartRef",ref:P,class:"chart observer-chart"},null,512),e("div",{ref_key:"returnChartRef",ref:G,class:"chart observer-chart"},null,512),e("div",{ref_key:"drawdownChartRef",ref:j,class:"chart observer-chart"},null,512)])])]),_:1})]),Y((w(),K(ve,{data:x.value||[],stripe:"",style:{width:"100%"},"default-sort":{prop:"datetime",order:"descending"},class:"trades-table"},{default:l(()=>[s(b,{type:"index",label:"#","min-width":"60"}),s(b,{prop:"datetime",label:"交易日期","min-width":"120",sortable:""},{default:l(d=>[e("span",Nt,r(W(d.row.datetime)),1)]),_:1}),s(b,{label:"操作","min-width":"80",align:"center"},{default:l(d=>[s(_e,{type:d.row.type==="buy"?"success":"danger",size:"small",effect:"dark"},{default:l(()=>[I(r(d.row.type==="buy"?"买入":"卖出"),1)]),_:2},1032,["type"])]),_:1}),s(b,{prop:"price",label:"价格","min-width":"100",sortable:"",align:"right"},{default:l(d=>[e("span",Pt,"¥"+r(d.row.price.toFixed(2)),1)]),_:1}),s(b,{prop:"size",label:"数量","min-width":"100",align:"right"},{default:l(d=>[e("span",Gt,r(d.row.size.toLocaleString()),1)]),_:1}),s(b,{prop:"value",label:"金额","min-width":"120",sortable:"",align:"right"},{default:l(d=>[e("span",jt,"¥"+r(d.row.value.toLocaleString()),1)]),_:1}),s(b,{label:"收益率","min-width":"100",align:"right"},{default:l(d=>[d.row.type==="sell"?(w(),S("span",{key:0,class:L($(d.row.return_rate||0))},r(F(d.row.return_rate||0)),3)):(w(),S("span",Ut,"-"))]),_:1}),s(b,{label:"手续费","min-width":"100",align:"right"},{default:l(d=>[e("span",Wt,"¥"+r(d.row.commission?.toFixed(2)||"0.00"),1)]),_:1}),s(b,{label:"备注","min-width":"120"},{default:l(d=>[e("span",Zt,r(d.row.type==="buy"?"策略买入信号":"策略卖出信号"),1)]),_:1})]),_:1},8,["data"])),[[X,M.value]])])),[[X,M.value]])])}}}),Xt=Ce(Ht,[["__scopeId","data-v-10f01219"]]);export{Xt as default};
