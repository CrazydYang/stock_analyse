import{d as le,a as y,H as X,f as L,w as t,i as c,c as w,g as H,e,k as i,t as n,b as l,F as se,B as oe,G as Y,E,o as p,_ as ne,r as Q,D as pe,N as ve,I as fe,J as ge,h as W,u as ke}from"./index-DXmEjQ3L.js";import{b as be,d as ye,g as we,r as he,a as Ce}from"./quantBacktestApi-Bv7K6dIt.js";const xe={key:0,class:"loading-container"},$e={key:1,class:"result-container"},ze={key:0,class:"strategy-params"},De={class:"metric-item"},Ve={class:"metric-value"},Se={class:"metric-item"},Ne={class:"metric-value"},Te={class:"metric-item"},Be={class:"metric-item"},Re={class:"metric-item"},Fe={class:"metric-value"},Le={class:"metric-item"},Ie={class:"metric-value negative"},Ue={class:"metric-item"},Pe={class:"metric-value"},Ee={class:"metric-item"},He={class:"metric-value"},Me={class:"metric-item"},je={class:"metric-value"},Ge={class:"metric-item"},Je={class:"metric-value positive"},Oe={class:"metric-item"},Ye={class:"metric-value negative"},qe={class:"card-header"},Ae={class:"trade-count"},Ke={key:2,class:"error-container"},Qe=le({__name:"BacktestResultDialog",props:{visible:{type:Boolean},taskId:{}},emits:["update:visible"],setup(Z,{emit:v}){const m=Z,T=v,r=y(null),u=y(!1),C=y(""),B=async()=>{if(!m.taskId){C.value="任务ID不能为空";return}u.value=!0,C.value="",r.value=null;try{r.value=await be(m.taskId)}catch(_){console.error("加载回测结果失败:",_),C.value=_.message||"加载回测结果失败",E.error("加载回测结果失败")}finally{u.value=!1}},R=()=>{T("update:visible",!1),r.value=null,C.value=""};X(()=>m.visible,_=>{_&&m.taskId&&B()});const $=_=>new Intl.NumberFormat("zh-CN",{style:"currency",currency:"CNY",minimumFractionDigits:2}).format(_),h=_=>`${(_*100).toFixed(2)}%`,V=_=>new Date(_).toLocaleString("zh-CN"),x=_=>_>0?"positive":_<0?"negative":"";return(_,d)=>{const q=c("el-skeleton"),b=c("el-descriptions-item"),j=c("el-descriptions"),I=c("el-card"),k=c("el-col"),U=c("el-row"),S=c("el-table-column"),A=c("el-tag"),K=c("el-table"),M=c("el-button"),G=c("el-result"),J=c("el-dialog");return p(),L(J,{"model-value":_.visible,"onUpdate:modelValue":R,title:"回测结果详情",width:"90%","close-on-click-modal":!1,"before-close":R},{footer:t(()=>[e(M,{onClick:R},{default:t(()=>[...d[16]||(d[16]=[i("关闭",-1)])]),_:1})]),default:t(()=>[u.value?(p(),w("div",xe,[e(q,{rows:10,animated:""})])):r.value?(p(),w("div",$e,[e(I,{class:"info-card",shadow:"never"},{header:t(()=>[...d[0]||(d[0]=[l("div",{class:"card-header"},[l("span",null,"基本信息")],-1)])]),default:t(()=>[e(j,{column:3,border:""},{default:t(()=>[e(b,{label:"任务ID"},{default:t(()=>[i(n(r.value.task_info.task_id),1)]),_:1}),e(b,{label:"策略名称"},{default:t(()=>[i(n(r.value.task_info.strategy_name),1)]),_:1}),e(b,{label:"股票代码"},{default:t(()=>[i(n(r.value.task_info.stock_code),1)]),_:1}),e(b,{label:"股票名称"},{default:t(()=>[i(n(r.value.task_info.stock_name),1)]),_:1}),e(b,{label:"开始日期"},{default:t(()=>[i(n(r.value.task_info.start_date),1)]),_:1}),e(b,{label:"结束日期"},{default:t(()=>[i(n(r.value.task_info.end_date),1)]),_:1}),e(b,{label:"初始资金"},{default:t(()=>[i(n($(r.value.task_info.initial_cash)),1)]),_:1}),e(b,{label:"手续费率"},{default:t(()=>[i(n(h(r.value.task_info.commission)),1)]),_:1}),e(b,{label:"创建时间"},{default:t(()=>[i(n(V(r.value.task_info.created_at)),1)]),_:1}),e(b,{label:"完成时间"},{default:t(()=>[i(n(V(r.value.task_info.completed_at)),1)]),_:1})]),_:1}),r.value.task_info.strategy_params&&Object.keys(r.value.task_info.strategy_params).length>0?(p(),w("div",ze,[d[1]||(d[1]=l("h4",null,"策略参数",-1)),e(j,{column:2,border:""},{default:t(()=>[(p(!0),w(se,null,oe(r.value.task_info.strategy_params,(f,F)=>(p(),L(b,{key:F,label:F},{default:t(()=>[i(n(f),1)]),_:2},1032,["label"]))),128))]),_:1})])):H("",!0)]),_:1}),e(I,{class:"performance-card",shadow:"never"},{header:t(()=>[...d[2]||(d[2]=[l("div",{class:"card-header"},[l("span",null,"绩效指标")],-1)])]),default:t(()=>[e(U,{gutter:16},{default:t(()=>[e(k,{span:6},{default:t(()=>[l("div",De,[d[3]||(d[3]=l("div",{class:"metric-label"},"初始价值",-1)),l("div",Ve,n($(r.value.performance.initial_value)),1)])]),_:1}),e(k,{span:6},{default:t(()=>[l("div",Se,[d[4]||(d[4]=l("div",{class:"metric-label"},"最终价值",-1)),l("div",Ne,n($(r.value.performance.final_value)),1)])]),_:1}),e(k,{span:6},{default:t(()=>[l("div",Te,[d[5]||(d[5]=l("div",{class:"metric-label"},"总收益率",-1)),l("div",{class:Y(["metric-value",x(r.value.performance.total_return)])},n(h(r.value.performance.total_return)),3)])]),_:1}),e(k,{span:6},{default:t(()=>[l("div",Be,[d[6]||(d[6]=l("div",{class:"metric-label"},"年化收益率",-1)),l("div",{class:Y(["metric-value",x(r.value.performance.annual_return)])},n(h(r.value.performance.annual_return)),3)])]),_:1})]),_:1}),e(U,{gutter:16},{default:t(()=>[e(k,{span:6},{default:t(()=>[l("div",Re,[d[7]||(d[7]=l("div",{class:"metric-label"},"夏普比率",-1)),l("div",Fe,n(r.value.performance.sharpe_ratio!==null?r.value.performance.sharpe_ratio.toFixed(4):"-"),1)])]),_:1}),e(k,{span:6},{default:t(()=>[l("div",Le,[d[8]||(d[8]=l("div",{class:"metric-label"},"最大回撤",-1)),l("div",Ie,n(h(r.value.performance.max_drawdown)),1)])]),_:1}),e(k,{span:6},{default:t(()=>[l("div",Ue,[d[9]||(d[9]=l("div",{class:"metric-label"},"波动率",-1)),l("div",Pe,n(r.value.performance.volatility!==null?h(r.value.performance.volatility):"-"),1)])]),_:1}),e(k,{span:6},{default:t(()=>[l("div",Ee,[d[10]||(d[10]=l("div",{class:"metric-label"},"总交易次数",-1)),l("div",He,n(r.value.performance.total_trades),1)])]),_:1})]),_:1}),e(U,{gutter:16},{default:t(()=>[e(k,{span:6},{default:t(()=>[l("div",Me,[d[11]||(d[11]=l("div",{class:"metric-label"},"胜率",-1)),l("div",je,n(r.value.performance.win_rate!==null?h(r.value.performance.win_rate):"-"),1)])]),_:1}),e(k,{span:6},{default:t(()=>[l("div",Ge,[d[12]||(d[12]=l("div",{class:"metric-label"},"盈利交易",-1)),l("div",Je,n(r.value.performance.winning_trades),1)])]),_:1}),e(k,{span:6},{default:t(()=>[l("div",Oe,[d[13]||(d[13]=l("div",{class:"metric-label"},"亏损交易",-1)),l("div",Ye,n(r.value.performance.losing_trades),1)])]),_:1}),e(k,{span:6})]),_:1})]),_:1}),r.value.detailed_data.trade_records.length>0?(p(),L(I,{key:0,class:"trades-card",shadow:"never"},{header:t(()=>[l("div",qe,[d[14]||(d[14]=l("span",null,"交易记录",-1)),l("span",Ae,"共 "+n(r.value.detailed_data.trade_records.length)+" 笔交易",1)])]),default:t(()=>[e(K,{data:r.value.detailed_data.trade_records,stripe:"",style:{width:"100%"},"max-height":"400"},{default:t(()=>[e(S,{prop:"datetime",label:"交易时间","min-width":"160"},{default:t(f=>[i(n(V(f.row.datetime)),1)]),_:1}),e(S,{prop:"type",label:"交易类型","min-width":"100"},{default:t(f=>[e(A,{type:f.row.type==="buy"?"success":"danger"},{default:t(()=>[i(n(f.row.type==="buy"?"买入":"卖出"),1)]),_:2},1032,["type"])]),_:1}),e(S,{prop:"size",label:"数量","min-width":"100"}),e(S,{prop:"price",label:"价格","min-width":"120"},{default:t(f=>[i(n($(f.row.price)),1)]),_:1}),e(S,{prop:"value",label:"交易金额","min-width":"140"},{default:t(f=>[i(n($(f.row.value)),1)]),_:1}),e(S,{prop:"commission",label:"手续费","min-width":"120"},{default:t(f=>[i(n($(f.row.commission)),1)]),_:1})]),_:1},8,["data"])]),_:1})):H("",!0)])):C.value?(p(),w("div",Ke,[e(G,{icon:"error",title:"加载失败","sub-title":C.value},{extra:t(()=>[e(M,{type:"primary",onClick:B},{default:t(()=>[...d[15]||(d[15]=[i("重试",-1)])]),_:1})]),_:1},8,["sub-title"])])):H("",!0)]),_:1},8,["model-value"])}}}),We=ne(Qe,[["__scopeId","data-v-701d87de"]]),Xe={class:"backtest-history-view"},Ze={class:"filter-panel"},et={class:"card-header"},tt={class:"task-list"},at={class:"card-header"},lt={class:"header-actions"},st={key:1},ot={key:0,class:"negative"},nt={key:1},rt={class:"pagination-container"},it={key:0,class:"task-detail"},dt={class:"negative"},ut={class:"task-actions",style:{"margin-top":"20px"}},ct=le({__name:"BacktestHistoryView",setup(Z){ke();const v=Q({strategyName:"",symbol:"",status:""}),m=Q({page:1,pageSize:10,total:0}),T=y([]),r=y([]),u=y(null),C=y(!1),B=y(!1),R=y(!1),$=y(""),h=y(new Set),V=y(new Set),x=Q({tasks:[]}),_=async()=>{C.value=!0;try{const s={offset:(m.page-1)*m.pageSize,limit:m.pageSize,...v.strategyName&&{strategy_name:v.strategyName},...v.symbol&&{stock_code:v.symbol},...v.status&&{status:v.status}},a=await ye(s);console.log("result.tasks",a.tasks),x.tasks=a.tasks||[],T.value=a.tasks||[],await ve(),m.total=a.total}catch(s){console.error("加载任务列表失败:",s),E.error("加载任务列表失败")}finally{C.value=!1}},d=async()=>{try{const s=await we();r.value=s}catch(s){console.error("加载策略列表失败:",s)}},q=()=>{m.page=1,_()},b=()=>{v.strategyName="",v.symbol="",v.status="",m.page=1,_()},j=()=>{_()},I=async s=>{h.value.add(s);try{if(await he(s),E.success("回测任务已启动"),await _(),u.value&&u.value.task_id===s){const a=x.tasks.find(g=>g.task_id===s);a&&(u.value=a)}}catch(a){console.error("运行回测任务失败:",a),E.error("运行回测任务失败")}finally{h.value.delete(s)}},k=async s=>{V.value.add(s);try{const a=await Ce(s),g=x.tasks.findIndex(P=>P.task_id===s);g!==-1&&(x.tasks[g].status=a.status,a.completed_at&&(x.tasks[g].completed_at=a.completed_at));const z=T.value.findIndex(P=>P.task_id===s);z!==-1&&(T.value[z].status=a.status,a.completed_at&&(T.value[z].completed_at=a.completed_at)),u.value&&u.value.task_id===s&&(u.value.status=a.status,a.completed_at&&(u.value.completed_at=a.completed_at)),E.success("状态已更新")}catch(a){console.error("查询任务状态失败:",a),E.error("查询任务状态失败")}finally{V.value.delete(s)}},U=s=>{$.value=s,R.value=!0},S=s=>{u.value=s,B.value=!0},A=s=>{m.pageSize=s,m.page=1,_()},K=s=>{m.page=s,_()},M=s=>{switch(s){case"created":return"info";case"running":return"warning";case"completed":return"success";case"failed":return"danger";default:return"info"}},G=s=>{switch(s){case"created":return"已创建";case"running":return"运行中";case"completed":return"已完成";case"failed":return"执行失败";default:return"未知状态"}},J=s=>s>0?"positive":s<0?"negative":"",f=s=>`${(s*100).toFixed(2)}%`,F=s=>new Date(s).toLocaleString("zh-CN");return X(T,s=>{console.log("taskList 发生变化，新长度:",s.length)},{deep:!0}),X(()=>x.tasks,s=>{console.log("tableData.tasks 发生变化，新长度:",s.length),console.log("tableData.tasks 内容:",s)},{deep:!0}),pe(async()=>{await Promise.all([d(),_()])}),(s,a)=>{const g=c("el-button"),z=c("el-option"),P=c("el-select"),O=c("el-form-item"),re=c("el-input"),ie=c("el-form"),ee=c("el-card"),D=c("el-table-column"),te=c("el-tag"),de=c("el-table"),ue=c("el-pagination"),N=c("el-descriptions-item"),ce=c("el-descriptions"),_e=c("el-dialog"),me=ge("loading");return p(),w("div",Xe,[a[25]||(a[25]=l("div",{class:"page-header"},[l("h1",null,"回测历史"),l("p",null,"查看历史回测任务，监控状态和查看结果")],-1)),l("div",Ze,[e(ee,null,{header:t(()=>[l("div",et,[a[13]||(a[13]=l("span",null,"筛选条件",-1)),e(g,{type:"primary",onClick:j},{default:t(()=>[...a[12]||(a[12]=[i("刷新",-1)])]),_:1})])]),default:t(()=>[e(ie,{model:v,inline:"",class:"filter-form"},{default:t(()=>[e(O,{label:"策略名称"},{default:t(()=>[e(P,{modelValue:v.strategyName,"onUpdate:modelValue":a[0]||(a[0]=o=>v.strategyName=o),placeholder:"全部策略",clearable:"",style:{width:"150px"}},{default:t(()=>[(p(!0),w(se,null,oe(r.value,o=>(p(),L(z,{key:o.name,label:o.description,value:o.name},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),e(O,{label:"股票代码"},{default:t(()=>[e(re,{modelValue:v.symbol,"onUpdate:modelValue":a[1]||(a[1]=o=>v.symbol=o),placeholder:"请输入股票代码",clearable:"",style:{width:"150px"}},null,8,["modelValue"])]),_:1}),e(O,{label:"状态"},{default:t(()=>[e(P,{modelValue:v.status,"onUpdate:modelValue":a[2]||(a[2]=o=>v.status=o),placeholder:"全部状态",clearable:"",style:{width:"120px"}},{default:t(()=>[e(z,{label:"已创建",value:"created"}),e(z,{label:"运行中",value:"running"}),e(z,{label:"已完成",value:"completed"}),e(z,{label:"执行失败",value:"failed"})]),_:1},8,["modelValue"])]),_:1}),e(O,null,{default:t(()=>[e(g,{type:"primary",onClick:q},{default:t(()=>[...a[14]||(a[14]=[i("查询",-1)])]),_:1}),e(g,{onClick:b},{default:t(()=>[...a[15]||(a[15]=[i("重置",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1})]),l("div",tt,[e(ee,null,{header:t(()=>[l("div",at,[a[17]||(a[17]=l("span",null,"回测任务列表",-1)),l("div",lt,[e(g,{type:"primary",onClick:a[3]||(a[3]=o=>s.$router.push("/backtest-strategy"))},{default:t(()=>[...a[16]||(a[16]=[i("创建新任务",-1)])]),_:1})])])]),default:t(()=>[fe((p(),L(de,{data:x.tasks,stripe:"",style:{width:"100%"},onRowClick:S,class:"full-width-table"},{default:t(()=>[e(D,{prop:"task_id",label:"任务ID","min-width":"200","show-overflow-tooltip":""}),e(D,{prop:"strategy_name",label:"策略","min-width":"120"}),e(D,{prop:"stock_code",label:"股票","min-width":"100"}),e(D,{label:"状态",width:"100"},{default:t(o=>[e(te,{type:M(o.row.status)},{default:t(()=>[i(n(G(o.row.status)),1)]),_:2},1032,["type"])]),_:1}),e(D,{label:"总收益率","min-width":"120"},{default:t(o=>[o.row.result_summary?.total_return!==void 0?(p(),w("span",{key:0,class:Y(J(o.row.result_summary?.total_return))},n(f(o.row.result_summary?.total_return)),3)):(p(),w("span",st,"-"))]),_:1}),e(D,{label:"最大回撤","min-width":"120"},{default:t(o=>[o.row.result_summary?.max_drawdown!==void 0?(p(),w("span",ot,n(f(o.row.result_summary?.max_drawdown)),1)):(p(),w("span",nt,"-"))]),_:1}),e(D,{prop:"created_at",label:"创建时间","min-width":"180"},{default:t(o=>[i(n(F(o.row.created_at)),1)]),_:1}),e(D,{prop:"completed_at",label:"完成时间","min-width":"180"},{default:t(o=>[i(n(o.row.completed_at?F(o.row.completed_at):"-"),1)]),_:1}),e(D,{label:"操作","min-width":"250",fixed:"right"},{default:t(o=>[e(g,{type:"primary",size:"small",onClick:W(ae=>I(o.row.task_id),["stop"]),disabled:o.row.status!=="created",loading:h.value.has(o.row.task_id)},{default:t(()=>[...a[18]||(a[18]=[i(" 运行 ",-1)])]),_:2},1032,["onClick","disabled","loading"]),e(g,{type:"info",size:"small",onClick:W(ae=>k(o.row.task_id),["stop"]),loading:V.value.has(o.row.task_id)},{default:t(()=>[...a[19]||(a[19]=[i(" 查询状态 ",-1)])]),_:2},1032,["onClick","loading"]),e(g,{type:"success",size:"small",onClick:W(ae=>U(o.row.task_id),["stop"]),disabled:o.row.status!=="completed"},{default:t(()=>[...a[20]||(a[20]=[i(" 查看结果 ",-1)])]),_:2},1032,["onClick","disabled"])]),_:1})]),_:1},8,["data"])),[[me,C.value]]),l("div",rt,[e(ue,{"current-page":m.page,"onUpdate:currentPage":a[4]||(a[4]=o=>m.page=o),"page-size":m.pageSize,"onUpdate:pageSize":a[5]||(a[5]=o=>m.pageSize=o),"page-sizes":[10,20,50,100],total:m.total,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:A,onCurrentChange:K},null,8,["current-page","page-size","total"])])]),_:1})]),e(_e,{modelValue:B.value,"onUpdate:modelValue":a[10]||(a[10]=o=>B.value=o),title:"任务详情",width:"800px","close-on-click-modal":!1},{footer:t(()=>[e(g,{onClick:a[9]||(a[9]=o=>B.value=!1)},{default:t(()=>[...a[24]||(a[24]=[i("关闭",-1)])]),_:1})]),default:t(()=>[u.value?(p(),w("div",it,[e(ce,{column:2,border:""},{default:t(()=>[e(N,{label:"任务ID"},{default:t(()=>[i(n(u.value.task_id),1)]),_:1}),e(N,{label:"策略名称"},{default:t(()=>[i(n(u.value.strategy_name),1)]),_:1}),e(N,{label:"股票代码"},{default:t(()=>[i(n(u.value.stock_code),1)]),_:1}),e(N,{label:"状态"},{default:t(()=>[e(te,{type:M(u.value.status)},{default:t(()=>[i(n(G(u.value.status)),1)]),_:1},8,["type"])]),_:1}),e(N,{label:"创建时间"},{default:t(()=>[i(n(F(u.value.created_at)),1)]),_:1}),e(N,{label:"完成时间"},{default:t(()=>[i(n(u.value.completed_at?F(u.value.completed_at):"-"),1)]),_:1}),u.value.result_summary?.total_return!==void 0?(p(),L(N,{key:0,label:"总收益率"},{default:t(()=>[l("span",{class:Y(J(u.value.result_summary?.total_return))},n(f(u.value.result_summary?.total_return)),3)]),_:1})):H("",!0),u.value.result_summary?.max_drawdown!==void 0?(p(),L(N,{key:1,label:"最大回撤"},{default:t(()=>[l("span",dt,n(f(u.value.result_summary?.max_drawdown??0)),1)]),_:1})):H("",!0)]),_:1}),l("div",ut,[e(g,{type:"primary",onClick:a[6]||(a[6]=o=>I(u.value.task_id)),disabled:u.value.status!=="created",loading:h.value.has(u.value.task_id)},{default:t(()=>[...a[21]||(a[21]=[i(" 运行任务 ",-1)])]),_:1},8,["disabled","loading"]),e(g,{type:"info",onClick:a[7]||(a[7]=o=>k(u.value.task_id)),loading:V.value.has(u.value.task_id)},{default:t(()=>[...a[22]||(a[22]=[i(" 刷新状态 ",-1)])]),_:1},8,["loading"]),e(g,{type:"success",onClick:a[8]||(a[8]=o=>U(u.value.task_id)),disabled:u.value.status!=="completed"},{default:t(()=>[...a[23]||(a[23]=[i(" 查看结果 ",-1)])]),_:1},8,["disabled"])])])):H("",!0)]),_:1},8,["modelValue"]),e(We,{visible:R.value,"onUpdate:visible":a[11]||(a[11]=o=>R.value=o),"task-id":$.value},null,8,["visible","task-id"])])}}}),pt=ne(ct,[["__scopeId","data-v-be84a59a"]]);export{pt as default};
