import{d as vt,a as u,z as E,y as ft,j as pt,E as P,M as mt,c as y,b as t,H as et,e as s,w as l,i as v,g as J,t as r,I as ht,f as X,D as bt,u as wt,k as F,l as T,P as yt,C as k,Q as gt,R as xt,S as kt,T as St,o as p,_ as Lt}from"./index-CKwFFpm-.js";import{i as j}from"./index-1yOyFXf9.js";import{b as Ct,e as Dt,f as Rt}from"./quantBacktestApi-D0m2yB8-.js";const zt={class:"backtest-result-view"},At={class:"page-header"},It={class:"header-content"},Mt={key:0},Bt={class:"content-container"},Ft={class:"basic-stats-section"},Tt={key:0,class:"stats-container"},Vt={class:"top-info-row"},$t={class:"fund-item"},Ot={class:"period-item"},Nt={key:0,class:"period-value"},Et={class:"fund-item"},Pt={class:"fund-icon"},jt={class:"fund-content"},Gt={class:"fund-value"},Ut={class:"fund-item"},Wt={class:"fund-icon"},Zt={class:"fund-content"},Ht={class:"main-stats"},qt={class:"main-stat-item"},Kt={class:"stat-icon positive-bg"},Qt={class:"stat-content"},Jt={class:"main-stat-item"},Xt={class:"stat-icon info-bg"},Yt={class:"stat-content"},te={class:"main-stat-item"},ee={class:"stat-icon warning-bg"},ae={class:"stat-content"},se={class:"stat-value negative"},oe={class:"main-stat-item"},le={class:"stat-icon success-bg"},re={class:"stat-content"},ne={class:"stat-value"},ie={class:"secondary-stats horizontal-stats"},de={class:"secondary-stat-item"},ce={class:"stat-header"},ue={class:"stat-value"},_e={class:"stat-progress"},ve={class:"stat-description"},fe={class:"secondary-stat-item"},pe={class:"stat-header"},me={class:"stat-badge"},he={class:"stat-value"},be={class:"stat-description"},we={class:"secondary-stat-item"},ye={class:"stat-header"},ge={class:"stat-badge success"},xe={class:"stat-value positive"},ke={class:"stat-description"},Se={class:"secondary-stat-item"},Le={class:"stat-header"},Ce={class:"stat-badge danger"},De={class:"stat-value negative"},Re={class:"stat-description"},ze={class:"secondary-stat-item"},Ae={class:"stat-header"},Ie={class:"stat-value"},Me={class:"secondary-stat-item"},Be={class:"stat-header"},Fe={class:"stat-badge info"},Te={class:"stat-value"},Ve={class:"charts-section"},$e={class:"chart-container"},Oe={class:"observer-charts-container"},Ne={class:"date-value"},Ee={class:"price-value"},Pe={class:"quantity-value"},je={class:"amount-value"},Ge={key:1,class:"text-muted"},Ue={key:1,class:"text-muted"},We={class:"commission-value"},Ze={class:"remark-text"},He=vt({__name:"BacktestResultView",setup(qe){const at=pt(),st=wt(),V=u(!1),C=u(""),o=u(null),m=u(null),g=u(null),h=u(null),ot=u(null);u("ALL"),u(""),u(""),u(null);const G=u(),U=u(),W=u(),Z=u();u();const S=u([]);let D=null,R=null,z=null,A=null;const lt=async()=>{try{const e=await Ct(C.value);o.value={task_id:e.task_info.task_id,strategy_name:e.task_info.strategy_name,symbol:e.task_info.stock_code,period:{start_date:e.task_info.start_date,end_date:e.task_info.end_date},detailed_data:e.detailed_data,performance:{total_return:e.performance.total_return,annual_return:e.performance.annual_return,max_drawdown:e.performance.max_drawdown,sharpe_ratio:e.performance.sharpe_ratio||0,win_rate:e.performance.win_rate||0,total_trades:e.performance.total_trades,winning_trades:e.performance.winning_trades,losing_trades:e.performance.losing_trades,initial_value:e.performance.initial_value,final_value:e.performance.final_value,volatility:e.performance.volatility||0},portfolio_value:e.detailed_data?.portfolio_values||e.portfolio_value||[],trades:e.detailed_data?.trade_records||e.trades||[]},o.value&&(S.value=o.value.trades)}catch(e){console.error("获取回测结果失败:",e),P.error("获取回测结果失败")}},rt=async()=>{try{const e=await Dt(C.value);m.value=e.data,h.value=e.data.task_info}catch(e){console.error("获取观测器数据失败:",e),P.error("获取观测器数据失败")}},nt=async()=>{try{const e=await Rt(C.value);g.value=e.data,ot.value=e.data.indicator_data}catch(e){console.error("获取原始数据和指标数据失败:",e),P.error("获取原始数据和指标数据失败")}},it=async()=>{if(await bt(),m.value?.observer_data?.broker?m.value.observer_data.broker.map(e=>e.datetime.split(" ")[0]):g.value?.raw_data&&g.value.raw_data.datetime,Z.value&&g.value?.raw_data){A=j(Z.value);const e=g.value.raw_data,a=e.datetime||[],d=a.map((c,w)=>e.close[w]),b=[],i=[];m.value?.observer_data?.buysell&&m.value.observer_data.buysell.forEach(c=>{const w=a.findIndex(B=>B.startsWith(c.datetime.split(" ")[0]));w!==-1&&(c.size>0?b.push([w,c.price]):i.push([w,c.price]))});const _=[{name:"收盘价",type:"line",data:d,smooth:!0,showSymbol:!1,lineStyle:{width:2,color:"#5470c6"},z:5},{name:"买入",type:"scatter",data:b,symbolSize:8,itemStyle:{color:"#F20505"},symbol:"triangle"},{name:"卖出",type:"scatter",data:i,symbolSize:8,itemStyle:{color:"#030008"},symbol:"triangle",symbolRotate:180}];if(g.value?.indicator_data){const c=g.value.indicator_data,w=["#5470c6","#91cc75","#fac858","#ee6666","#73c0de","#3ba272","#fc8452","#9a60b4","#ea7ccc","#2f4554"];let B=0;const q=Math.max(...d);Object.keys(c).forEach(x=>{if(c[x]){const K=Math.max(...c[x].filter(n=>n!=null)),O=x.toLowerCase().includes("crossover"),f=x.toLowerCase().includes("signal"),Q=K/q<.5||O||f?1:0,N=w[B++%w.length];_.push({name:x,type:"line",data:c[x],smooth:!0,showSymbol:!1,yAxisIndex:Q,lineStyle:{width:1.5,color:N}})}})}const L={tooltip:{trigger:"axis",axisPointer:{type:"cross"}},legend:{data:["收盘价","买入","卖出",...Object.keys(g.value?.indicator_data||{})],type:"scroll",orient:"horizontal",top:0,textStyle:{fontSize:11},pageButtonItemGap:5,pageButtonGap:5},grid:{left:"3%",right:"4%",bottom:"15%",top:"60px",containLabel:!0},xAxis:{type:"category",data:a,scale:!0,boundaryGap:!1,axisLine:{onZero:!1},splitLine:{show:!1},axisLabel:{rotate:45,interval:"auto",formatter:function(c){return c.substring(5,10)}}},yAxis:[{name:"价格",type:"value",scale:!0,position:"left",axisLine:{show:!1},axisTick:{show:!1},axisLabel:{color:"#909399",fontSize:10},splitLine:{show:!0,lineStyle:{type:"dashed",color:"#ebeef5"}}},{name:"指标值",type:"value",scale:!0,position:"right",axisLine:{show:!1},axisTick:{show:!1},axisLabel:{color:"#909399",fontSize:10},splitLine:{show:!1}}],dataZoom:[{type:"inside",start:0,end:100},{show:!0,type:"slider",bottom:0,start:0,end:100}],series:_};A.setOption(L)}if(G.value&&m.value?.observer_data?.broker){D=j(G.value);const e=m.value.observer_data.broker,a=e.map(_=>_.datetime.split(" ")[0]),d=e.map(_=>_.value),b=e.map(_=>_.cash),i={tooltip:{trigger:"axis",formatter:_=>{let L=`${_[0].axisValue}<br/>`;return _.forEach(c=>{L+=`${c.seriesName}: ¥${c.value.toLocaleString()}<br/>`}),L}},grid:{left:"3%",right:"4%",bottom:"0%",top:"3%",containLabel:!0,height:60},xAxis:{type:"category",data:a,axisLabel:{show:!1},axisLine:{show:!1},axisTick:{show:!1}},yAxis:{type:"value",axisLine:{show:!1},axisTick:{show:!1},splitLine:{show:!0,lineStyle:{type:"dashed",color:"#ebeef5"}},axisLabel:{color:"#909399",fontSize:10,formatter:_=>`¥${(_/1e3).toFixed(0)}K`}},series:[{name:"总资产",type:"line",data:d,smooth:!0,showSymbol:!1,lineStyle:{color:"#5470c6",width:2},areaStyle:{color:{type:"linear",x:0,y:0,x2:0,y2:1,colorStops:[{offset:0,color:"rgba(84, 112, 198, 0.3)"},{offset:1,color:"rgba(84, 112, 198, 0.1)"}]}}},{name:"现金",type:"line",data:b,smooth:!0,showSymbol:!1,lineStyle:{color:"#67C23A",width:1.5}}]};D.setOption(i)}if(U.value&&m.value?.observer_data?.timereturn){R=j(U.value);const e=m.value.observer_data.timereturn,a=e.map(i=>i.datetime.split(" ")[0]),d=e.map(i=>i.return),b={tooltip:{trigger:"axis",formatter:i=>`${i[0].axisValue}<br/>收益率: ${i[0].value.toFixed(2)}%`},grid:{left:"3%",right:"4%",bottom:"0%",top:"3%",containLabel:!0,height:60},xAxis:{type:"category",data:a,axisLabel:{show:!1},axisLine:{show:!1},axisTick:{show:!1}},yAxis:{type:"value",axisLine:{show:!1},axisTick:{show:!1},splitLine:{show:!0,lineStyle:{type:"dashed",color:"#ebeef5"}},axisLabel:{color:"#909399",fontSize:10,formatter:i=>`${i.toFixed(1)}%`}},series:[{name:"收益率",type:"line",data:d,smooth:!0,showSymbol:!1,lineStyle:{color:"#91cc75",width:2},areaStyle:{color:{type:"linear",x:0,y:0,x2:0,y2:1,colorStops:[{offset:0,color:"rgba(145, 204, 117, 0.3)"},{offset:1,color:"rgba(145, 204, 117, 0.1)"}]}}}]};R.setOption(b)}if(W.value&&m.value?.observer_data?.drawdown){z=j(W.value);const e=m.value.observer_data.drawdown,a=e.map(i=>i.datetime.split(" ")[0]),d=e.map(i=>i.drawdown*100),b={tooltip:{trigger:"axis",formatter:i=>`${i[0].axisValue}<br/>回撤: ${i[0].value.toFixed(2)}%`},grid:{left:"3%",right:"4%",bottom:"5%",top:"3%",containLabel:!0,height:60},xAxis:{type:"category",data:a,axisLabel:{show:!1},axisLine:{show:!1},axisTick:{show:!1}},yAxis:{type:"value",axisLine:{show:!1},axisTick:{show:!1},splitLine:{show:!0,lineStyle:{type:"dashed",color:"#ebeef5"}},axisLabel:{color:"#909399",fontSize:10,formatter:i=>`${i.toFixed(1)}%`}},dataZoom:[{type:"inside",xAxisIndex:0,start:0,end:100},{show:!1,xAxisIndex:0,type:"slider",bottom:0,start:0,end:100}],series:[{name:"回撤",type:"line",data:d,smooth:!0,showSymbol:!1,lineStyle:{color:"#ee6666",width:2},areaStyle:{color:{type:"linear",x:0,y:0,x2:0,y2:1,colorStops:[{offset:0,color:"rgba(238, 102, 102, 0.5)"},{offset:1,color:"rgba(238, 102, 102, 0.2)"}]}},emphasis:{focus:"series",itemStyle:{shadowBlur:10,shadowColor:"rgba(238, 102, 102, 0.5)"}}}]};z.setOption(b)}},I=e=>e>0?"positive":e<0?"negative":"",M=e=>e==null?"0.00%":`${e.toFixed(2)}%`,$=e=>e==null?"0.00":e.toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2}),dt=e=>e>=70?"#67c23a":e>=50?"#e6a23c":"#f56c6c",ct=(e,a)=>Math.abs(e)<.1&&a>1.5?"low-risk":Math.abs(e)<.2&&a>1?"medium-risk":"high-risk",ut=(e,a)=>Math.abs(e)<.1&&a>1.5?"低风险":Math.abs(e)<.2&&a>1?"中风险":"高风险";E(()=>S.value.length),E(()=>S.value.filter(e=>e.type==="buy").length),E(()=>S.value.filter(e=>e.type==="sell").length),E(()=>S.value.reduce((e,a)=>e+a.value,0));const H=e=>e.split("T")[0],Y=()=>{st.push({name:"BacktestHistory"})};ft(async()=>{if(C.value=at.params.taskId,!C.value){P.error("缺少任务ID参数"),Y();return}V.value=!0;try{await Promise.all([lt(),rt(),nt()]),await it()}catch(e){console.error("页面初始化失败:",e)}finally{V.value=!1}});const _t=()=>{D&&(D.dispose(),D=null),R&&(R.dispose(),R=null),z&&(z.dispose(),z=null),A&&(A.dispose(),A=null)};return mt(()=>{_t()}),(e,a)=>{const d=v("el-icon"),b=v("el-button"),i=v("Money"),_=v("Wallet"),L=v("ArrowUp"),c=v("ArrowDown"),w=v("el-progress"),B=v("DataLine"),q=v("CircleCheck"),x=v("CircleClose"),K=v("Coin"),O=v("el-card"),f=v("el-table-column"),tt=v("el-tag"),Q=v("el-table"),N=ht("loading");return p(),y("div",zt,[t("div",At,[s(b,{type:"primary",onClick:Y,class:"back-button"},{default:l(()=>[s(d,null,{default:l(()=>[s(T(yt))]),_:1}),a[0]||(a[0]=F(" 返回 ",-1))]),_:1}),t("div",It,[a[1]||(a[1]=t("h1",null,"回测结果详情",-1)),h.value?(p(),y("p",Mt,r(h.value.strategy_name)+" - "+r(h.value.stock_name)+"("+r(h.value.stock_code)+")",1)):J("",!0)])]),et((p(),y("div",Bt,[t("div",Ft,[s(O,{class:"stats-card"},{header:l(()=>[...a[2]||(a[2]=[t("div",{class:"card-header"},[t("span",{class:"card-title"},"回测基本数据")],-1)])]),default:l(()=>[o.value?(p(),y("div",Tt,[t("div",Vt,[t("div",$t,[t("div",Ot,[a[3]||(a[3]=t("span",{class:"period-label"},"回测区间:",-1)),h.value?(p(),y("span",Nt,r(H(h.value.start_date))+" 至 "+r(H(h.value.end_date)),1)):J("",!0)])]),t("div",Et,[t("div",Pt,[s(d,null,{default:l(()=>[s(i)]),_:1})]),t("div",jt,[a[4]||(a[4]=t("div",{class:"fund-label"},"初始资金",-1)),t("div",Gt,"¥"+r($(h.value.initial_cash)),1)])]),t("div",Ut,[t("div",Wt,[s(d,null,{default:l(()=>[s(_)]),_:1})]),t("div",Zt,[a[5]||(a[5]=t("div",{class:"fund-label"},"最终资金",-1)),t("div",{class:k(["fund-value",I(o.value.performance.final_value-h.value.initial_cash)])}," ¥"+r($(o.value.performance.final_value)),3)])])]),t("div",Ht,[t("div",qt,[t("div",Kt,[s(d,null,{default:l(()=>[s(T(gt))]),_:1})]),t("div",Qt,[a[6]||(a[6]=t("div",{class:"stat-label"},"总收益率",-1)),t("div",{class:k(["stat-value",I(o.value.performance.total_return)])},r(M(o.value.performance.total_return)),3)])]),t("div",Jt,[t("div",Xt,[s(d,null,{default:l(()=>[s(T(xt))]),_:1})]),t("div",Yt,[a[7]||(a[7]=t("div",{class:"stat-label"},"年化收益率",-1)),t("div",{class:k(["stat-value",I(o.value.performance.annual_return)])},r(M(o.value.performance.annual_return)),3)])]),t("div",te,[t("div",ee,[s(d,null,{default:l(()=>[s(T(kt))]),_:1})]),t("div",ae,[a[8]||(a[8]=t("div",{class:"stat-label"},"最大回撤",-1)),t("div",se,r(M(o.value.performance.max_drawdown)),1)])]),t("div",oe,[t("div",le,[s(d,null,{default:l(()=>[s(T(St))]),_:1})]),t("div",re,[a[9]||(a[9]=t("div",{class:"stat-label"},"夏普比率",-1)),t("div",ne,r(o.value.performance.sharpe_ratio.toFixed(2)),1)])])]),t("div",ie,[t("div",de,[t("div",ce,[a[10]||(a[10]=t("div",{class:"stat-label"},"胜率",-1)),t("div",{class:k(["trend-indicator",o.value.performance.win_rate>=.6?"trend-up":"trend-down"])},[o.value.performance.win_rate>=.6?(p(),X(d,{key:0},{default:l(()=>[s(L)]),_:1})):(p(),X(d,{key:1},{default:l(()=>[s(c)]),_:1}))],2)]),t("div",ue,r(M(o.value.performance.win_rate)),1),t("div",_e,[s(w,{percentage:o.value.performance.win_rate,"show-text":!1,"stroke-width":6,color:dt(o.value.performance.win_rate)},null,8,["percentage","color"])]),t("div",ve,r(o.value.performance.win_rate>=.6?"表现优秀":o.value.performance.win_rate>=.4?"表现一般":"需要改进"),1)]),t("div",fe,[t("div",pe,[a[11]||(a[11]=t("div",{class:"stat-label"},"总交易次数",-1)),t("div",me,[s(d,null,{default:l(()=>[s(B)]),_:1})])]),t("div",he,r(o.value.performance.total_trades),1),t("div",be," 交易频率: "+r((o.value.performance.total_trades/252).toFixed(1))+"/年 ",1)]),t("div",we,[t("div",ye,[a[12]||(a[12]=t("div",{class:"stat-label"},"盈利交易",-1)),t("div",ge,[s(d,null,{default:l(()=>[s(q)]),_:1})])]),t("div",xe,r(o.value.performance.winning_trades),1),t("div",ke," 占比: "+r((o.value.performance.winning_trades/o.value.performance.total_trades*100).toFixed(1))+"% ",1)]),t("div",Se,[t("div",Le,[a[13]||(a[13]=t("div",{class:"stat-label"},"亏损交易",-1)),t("div",Ce,[s(d,null,{default:l(()=>[s(x)]),_:1})])]),t("div",De,r(o.value.performance.losing_trades),1),t("div",Re," 占比: "+r((o.value.performance.losing_trades/o.value.performance.total_trades*100).toFixed(1))+"% ",1)]),t("div",ze,[t("div",Ae,[a[14]||(a[14]=t("div",{class:"stat-label"},"风险评级",-1)),t("div",{class:k(["risk-level",ct(o.value.performance.max_drawdown,o.value.performance.sharpe_ratio)])},[s(d,null,{default:l(()=>[s(_)]),_:1})],2)]),t("div",Ie,r(ut(o.value.performance.max_drawdown,o.value.performance.sharpe_ratio)),1),a[15]||(a[15]=t("div",{class:"stat-description"}," 基于回撤和夏普比率 ",-1))]),t("div",Me,[t("div",Be,[a[16]||(a[16]=t("div",{class:"stat-label"},"收益风险比",-1)),t("div",Fe,[s(d,null,{default:l(()=>[s(K)]),_:1})])]),t("div",Te,r((Math.abs(o.value.performance.total_return)/Math.abs(o.value.performance.max_drawdown)).toFixed(2)),1),a[17]||(a[17]=t("div",{class:"stat-description"}," 收益/最大回撤 ",-1))])])])):J("",!0)]),_:1})]),t("div",Ve,[s(O,{class:"chart-card main-chart"},{header:l(()=>[...a[18]||(a[18]=[t("div",{class:"card-header"},[t("span",{class:"card-title"},"价格走势与交易信号")],-1)])]),default:l(()=>[t("div",$e,[t("div",{ref_key:"klineChartRef",ref:Z,class:"chart main-chart-content"},null,512),a[19]||(a[19]=t("div",{class:"observer-legend",style:{"margin-top":"10px","margin-bottom":"5px","text-align":"center"}},[t("span",{class:"legend-item"},[t("span",{class:"color-dot broker-color"}),F("资金曲线")]),t("span",{class:"legend-item"},[t("span",{class:"color-dot return-color"}),F("收益率曲线")]),t("span",{class:"legend-item"},[t("span",{class:"color-dot drawdown-color"}),F("回撤曲线")])],-1)),t("div",Oe,[t("div",{ref_key:"brokerChartRef",ref:G,class:"chart observer-chart"},null,512),t("div",{ref_key:"returnChartRef",ref:U,class:"chart observer-chart"},null,512),t("div",{ref_key:"drawdownChartRef",ref:W,class:"chart observer-chart"},null,512)])])]),_:1})]),et((p(),X(Q,{data:S.value,stripe:"",style:{width:"100%"},"default-sort":{prop:"datetime",order:"descending"},class:"trades-table"},{default:l(()=>[s(f,{type:"index",label:"#","min-width":"60"}),s(f,{prop:"datetime",label:"交易日期","min-width":"120",sortable:""},{default:l(n=>[t("span",Ne,r(H(n.row.datetime)),1)]),_:1}),s(f,{label:"操作","min-width":"80",align:"center"},{default:l(n=>[s(tt,{type:n.row.type==="buy"?"success":"danger",size:"small",effect:"dark"},{default:l(()=>[F(r(n.row.type==="buy"?"买入":"卖出"),1)]),_:2},1032,["type"])]),_:1}),s(f,{prop:"price",label:"价格","min-width":"100",sortable:"",align:"right"},{default:l(n=>[t("span",Ee,"¥"+r(n.row.price.toFixed(2)),1)]),_:1}),s(f,{prop:"size",label:"数量","min-width":"100",align:"right"},{default:l(n=>[t("span",Pe,r(n.row.size.toLocaleString()),1)]),_:1}),s(f,{prop:"value",label:"成本","min-width":"120",sortable:"",align:"right"},{default:l(n=>[t("span",je,"¥"+r(n.row.value.toLocaleString()),1)]),_:1}),s(f,{prop:"pnl",label:"盈亏","min-width":"120",sortable:"",align:"right"},{default:l(n=>[n.row.type==="sell"?(p(),y("span",{key:0,class:k(I(n.row.pnl||0))},r($(n.row.pnl)),3)):(p(),y("span",Ge,"-"))]),_:1}),s(f,{label:"收益率","min-width":"100",align:"right"},{default:l(n=>[n.row.type==="sell"?(p(),y("span",{key:0,class:k(I(n.row.pnl_pct||0))},r(M(n.row.pnl_pct||0)),3)):(p(),y("span",Ue,"-"))]),_:1}),s(f,{label:"手续费","min-width":"100",align:"right"},{default:l(n=>[t("span",We,"¥"+r($(Number(n.row.commission??0))),1)]),_:1}),s(f,{label:"备注","min-width":"120"},{default:l(n=>[t("span",Ze,r(n.row.type==="buy"?"策略买入信号":"策略卖出信号"),1)]),_:1})]),_:1},8,["data"])),[[N,V.value]])])),[[N,V.value]])])}}}),Xe=Lt(He,[["__scopeId","data-v-03553534"]]);export{Xe as default};
