import{d as z,a as u,z as h,y as T,c as r,b as a,H as E,X as W,F as A,A as B,g as L,t as d,V as O,D as U,o as c,_ as H}from"./index-Do2I22sE.js";import{i as X}from"./index-1yOyFXf9.js";import{a as j}from"./industryApi-DEyyoGUJ.js";const q={class:"industry-treemap-view"},G={class:"control-panel"},J={class:"metric-selector"},K=["value"],Q={class:"refresh-controls"},R=["disabled"],Y={key:0},Z={key:1},ee={key:0,class:"update-time"},te={key:0,class:"loading-container"},ae={key:1,class:"error-container"},se={class:"error-message"},le={key:2,class:"treemap-container"},ne={class:"chart-info"},oe={class:"statistics"},ie={class:"stats-grid"},re={class:"stat-item"},ce={class:"stat-value"},de={class:"stat-item"},ue={class:"stat-value"},ve={class:"stat-item"},fe={class:"stat-value"},me={class:"stat-item"},pe={class:"stat-value"},ge=z({__name:"IndustryTreemapView",setup(_e){const v=u(!1),p=u(null),n=u([]),i=u("total_market_cap_sum"),k=u(null),g=u();let f=null;const _=[{key:"total_market_cap_sum",label:"总市值",unit:"元",isPercent:!1},{key:"circulating_market_cap_sum",label:"流通市值",unit:"元",isPercent:!1},{key:"avg_change_percent",label:"平均涨跌幅",unit:"%",isPercent:!0},{key:"total_volume",label:"总成交量",unit:"手",isPercent:!1},{key:"total_amount",label:"总成交额",unit:"元",isPercent:!1},{key:"avg_turnover_rate",label:"平均换手率",unit:"%",isPercent:!0},{key:"avg_pe_ratio",label:"平均市盈率",unit:"",isPercent:!1},{key:"avg_pb_ratio",label:"平均市净率",unit:"",isPercent:!1},{key:"stock_count",label:"股票数量",unit:"只",isPercent:!1},{key:"avg_change_60d",label:"60日平均涨跌幅",unit:"%",isPercent:!0},{key:"avg_change_ytd",label:"年初至今平均涨跌幅",unit:"%",isPercent:!0}],x=h(()=>_.find(t=>t.key===i.value)?.label||""),F=h(()=>n.value?.length||0),M=h(()=>!n.value||n.value.length===0?0:Math.max(...n.value.map(e=>e[i.value]))),I=h(()=>!n.value||n.value.length===0?0:Math.min(...n.value.map(e=>e[i.value])));async function D(){try{v.value=!0,p.value=null,console.log("开始加载行业数据...");const e=await j();console.log("API响应数据:",e),n.value=e.industries||[],console.log("设置industryData:",n.value),console.log("数据条数:",n.value?.length||0),k.value=new Date}catch(e){p.value=e instanceof Error?e.message:"加载数据失败",console.error("Failed to load industry data:",e)}finally{v.value=!1,await U(),console.log("DOM更新完成，开始更新树图"),P()}}async function w(){await D()}function P(){if(console.log("updateTreemap被调用"),console.log("treemapChart.value:",g.value),console.log("industryData.value:",n.value),console.log("industryData长度:",n.value?.length||0),!g.value){console.error("treemapChart容器未找到");return}if(!n.value||n.value.length===0){console.error("industryData为空或未定义");return}f||(console.log("初始化ECharts实例"),f=X(g.value));const e=_.find(s=>s.key===i.value);console.log("当前选择的指标:",e);const t=n.value.map(s=>{const o=s[i.value],m=typeof o=="number"?o:Number(o),V=Number.isNaN(m)?0:m,C=typeof s.stock_count=="number"&&s.stock_count>0?s.stock_count:1;return{industry:s.industry,originalValue:V,stockCount:C}});console.log("baseData处理结果:",t.slice(0,3));let l=t.map(s=>({name:s.industry,value:Math.abs(s.originalValue),originalValue:s.originalValue,itemStyle:{color:S(s.originalValue,e?.isPercent||!1)}}));console.log("初始treemapData:",l.slice(0,3));const b=l.reduce((s,o)=>s+o.value,0);if(console.log("总面积:",b),b<=0&&(console.log("所有值为0，使用股票数量作为回退"),l=t.map(s=>({name:s.industry,value:s.stockCount,originalValue:s.originalValue,itemStyle:{color:S(s.originalValue,e?.isPercent||!1)}}))),l=l.filter(s=>s.value>0),console.log("过滤后的treemapData长度:",l.length),console.log("最终treemapData:",l.slice(0,3)),l.length===0){console.error("treemapData为空，无法渲染图表");return}const $={title:{text:`行业${x.value}分布`,left:"center",textStyle:{fontSize:16,fontWeight:"bold"}},tooltip:{trigger:"item",formatter:s=>{const o=s.data,m=l.reduce((V,C)=>V+C.value,0);return`
          <div style="padding: 8px;">
            <div style="font-weight: bold; margin-bottom: 4px;">${o.name}</div>
            <div>${x.value}: ${y(o.originalValue)}</div>
            <div>占比: ${m>0?(o.value/m*100).toFixed(2):"0.00"}%</div>
          </div>
        `}},series:[{type:"treemap",data:l,roam:!1,nodeClick:!1,breadcrumb:{show:!1},label:{show:!0,formatter:s=>`${s.name}
${y(s.data.originalValue)}`,fontSize:12,color:"#fff",fontWeight:"bold"},itemStyle:{borderColor:"#fff",borderWidth:2,gapWidth:2},emphasis:{itemStyle:{borderColor:"#333",borderWidth:3},label:{fontSize:14}}}]};console.log("设置ECharts选项:",$),f.setOption($),console.log("ECharts选项设置完成")}function S(e,t){if(t)return e>0?"#52c41a":e<0?"#ff4d4f":"#d9d9d9";{const l=["#1890ff","#13c2c2","#52c41a","#faad14","#f759ab","#722ed1","#fa541c","#eb2f96"],b=Math.abs(e.toString().charCodeAt(0))%l.length;return l[b]}}function y(e){const t=_.find(l=>l.key===i.value);return t?.isPercent?`${e.toFixed(2)}%`:t?.unit==="元"?e>=1e12?`${(e/1e12).toFixed(2)}万亿`:e>=1e8?`${(e/1e8).toFixed(2)}亿`:e>=1e4?`${(e/1e4).toFixed(2)}万`:e.toFixed(2):e>=1e8?`${(e/1e8).toFixed(2)}亿`:e>=1e4?`${(e/1e4).toFixed(2)}万`:e.toFixed(2)+(t?.unit||"")}function N(e){return e.toLocaleString("zh-CN")}return T(async()=>{await D(),window.addEventListener("resize",()=>{f&&f.resize()})}),(e,t)=>(c(),r("div",q,[a("div",G,[a("div",J,[t[1]||(t[1]=a("label",{for:"metric-select"},"选择指标：",-1)),E(a("select",{id:"metric-select","onUpdate:modelValue":t[0]||(t[0]=l=>i.value=l),onChange:P,class:"metric-select"},[(c(),r(A,null,B(_,l=>a("option",{key:l.key,value:l.key},d(l.label),9,K)),64))],544),[[W,i.value]])]),a("div",Q,[a("button",{onClick:w,disabled:v.value,class:"refresh-btn"},[v.value?(c(),r("span",Y,"刷新中...")):(c(),r("span",Z,"刷新数据"))],8,R),k.value?(c(),r("span",ee," 最后更新："+d(N(k.value)),1)):L("",!0)])]),v.value?(c(),r("div",te,[...t[2]||(t[2]=[a("div",{class:"loading-spinner"},null,-1),a("p",null,"正在加载行业数据...",-1)])])):p.value?(c(),r("div",ae,[a("div",se,[t[3]||(t[3]=a("h3",null,"数据加载失败",-1)),a("p",null,d(p.value),1),a("button",{onClick:w,class:"retry-btn"},"重试")])])):(c(),r("div",le,[a("div",{ref_key:"treemapChart",ref:g,class:"treemap-chart"},null,512),a("div",ne,[t[9]||(t[9]=O('<div class="legend" data-v-9239363d><h4 data-v-9239363d>图例说明</h4><div class="legend-items" data-v-9239363d><div class="legend-item positive" data-v-9239363d><span class="color-box positive" data-v-9239363d></span><span data-v-9239363d>正值/上涨</span></div><div class="legend-item negative" data-v-9239363d><span class="color-box negative" data-v-9239363d></span><span data-v-9239363d>负值/下跌</span></div><div class="legend-item neutral" data-v-9239363d><span class="color-box neutral" data-v-9239363d></span><span data-v-9239363d>中性/无变化</span></div></div></div>',1)),a("div",oe,[t[8]||(t[8]=a("h4",null,"统计信息",-1)),a("div",ie,[a("div",re,[t[4]||(t[4]=a("span",{class:"stat-label"},"行业总数：",-1)),a("span",ce,d(F.value),1)]),a("div",de,[t[5]||(t[5]=a("span",{class:"stat-label"},"当前指标：",-1)),a("span",ue,d(x.value),1)]),a("div",ve,[t[6]||(t[6]=a("span",{class:"stat-label"},"最大值：",-1)),a("span",fe,d(y(M.value)),1)]),a("div",me,[t[7]||(t[7]=a("span",{class:"stat-label"},"最小值：",-1)),a("span",pe,d(y(I.value)),1)])])])])]))]))}}),ke=H(ge,[["__scopeId","data-v-9239363d"]]);export{ke as default};
