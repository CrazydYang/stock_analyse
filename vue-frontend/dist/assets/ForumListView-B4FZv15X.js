import{d as Z,a as i,r as U,H as ee,y as te,J as oe,K as le,c as F,b as s,g as b,f as z,e as l,w as a,i as n,E as f,l as P,N as ae,k as u,$ as se,h as R,t as D,a0 as ne,u as re,R as ie,o as v,_ as ue}from"./index-BwhP6Rq9.js";import{g as de,c as ce,d as pe}from"./forumApi-BMc9se_X.js";const me={class:"forum-list-view","element-loading-text":"正在加载帖子列表..."},fe={class:"page-header"},ge={class:"header-content"},_e={class:"header-actions"},ve={key:0,class:"post-list-section"},he={class:"table-header"},we={class:"table-controls"},ye={class:"table-footer"},be={class:"dialog-footer"},xe=Z({__name:"ForumListView",setup(Ce){const $=re(),c=i(!1),x=i(!1),h=i([]),C=i({current:1,total_pages:0,total_items:0,has_next:!1,has_previous:!1}),w=i(""),g=i(1),y=i(10),_=i(!1),k=i(),r=U({title:"",content:""}),E=U({title:[{required:!0,message:"请输入帖子标题",trigger:"blur"},{min:2,max:100,message:"标题长度应在2到100个字符之间",trigger:"blur"}],content:[{required:!0,message:"请输入帖子内容",trigger:"blur"},{min:5,max:1e4,message:"内容长度应在5到10000个字符之间",trigger:"blur"}]}),L=ee(()=>{let t=h.value;return w.value&&(t=t.filter(e=>e.title.includes(w.value))),t}),M=t=>t?new Date(t).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):"",I=t=>{const e=localStorage.getItem("user");return e?JSON.parse(e).username===t:!1},p=async()=>{if(!c.value){c.value=!0;try{const t=await de(g.value,y.value);console.log(t),h.value=t.posts,C.value=t.page,f.success("帖子列表加载成功")}catch(t){console.error("加载帖子列表失败:",t),f.error("加载帖子列表失败，请稍后重试")}finally{c.value=!1}}},J=t=>{y.value=t,g.value=1,p()},T=t=>{g.value=t,p()},N=t=>{$.push(`/forum/posts/${t.id}`)},q=()=>{r.title="",r.content="",_.value=!0},K=async()=>{k.value&&await k.value.validate(async t=>{if(t){x.value=!0;try{await ce(r.title,r.content),f.success("帖子发布成功"),_.value=!1,p()}catch(e){console.error("发布帖子失败:",e),f.error("发布帖子失败，请稍后重试")}finally{x.value=!1}}})},A=t=>{ie.confirm("确定要删除这个帖子吗？此操作不可恢复。","删除确认",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{await pe(t.id),f.success("帖子删除成功"),p()}catch(e){console.error("删除帖子失败:",e),f.error("删除帖子失败，请稍后重试")}}).catch(()=>{})};return te(()=>{p()}),(t,e)=>{const d=n("el-button"),S=n("el-card"),V=n("el-input"),m=n("el-table-column"),H=n("el-tag"),O=n("el-table"),j=n("el-pagination"),G=n("el-empty"),B=n("el-form-item"),Q=n("el-form"),W=n("el-dialog"),X=le("loading");return oe((v(),F("div",me,[s("div",fe,[l(S,{shadow:"hover"},{default:a(()=>[s("div",ge,[e[9]||(e[9]=s("div",{class:"forum-info"},[s("h1",{class:"forum-title"},"论坛讨论区"),s("p",{class:"forum-subtitle"},"分享交流投资心得与市场观点")],-1)),s("div",_e,[l(d,{onClick:p,loading:c.value,icon:P(ae),type:"primary"},{default:a(()=>[...e[7]||(e[7]=[u("刷新",-1)])]),_:1},8,["loading","icon"]),l(d,{onClick:q,type:"success",icon:P(se)},{default:a(()=>[...e[8]||(e[8]=[u("发布帖子",-1)])]),_:1},8,["icon"])])])]),_:1})]),h.value.length>0?(v(),F("div",ve,[l(S,{shadow:"hover"},{header:a(()=>[s("div",he,[e[10]||(e[10]=s("h3",null,"帖子列表",-1)),s("div",we,[l(V,{modelValue:w.value,"onUpdate:modelValue":e[0]||(e[0]=o=>w.value=o),placeholder:"搜索帖子标题","prefix-icon":"Search",clearable:"",style:{width:"200px"}},null,8,["modelValue"])])])]),default:a(()=>[l(O,{data:L.value,stripe:"",border:"",style:{width:"100%"},"default-sort":{prop:"created_at",order:"descending"},height:"600","highlight-current-row":"",onRowClick:N},{default:a(()=>[l(m,{type:"index",label:"#",width:"50",fixed:"left",align:"center"}),l(m,{prop:"title",label:"标题","min-width":"300"},{default:a(o=>[l(d,{type:"text",onClick:R(Y=>N(o.row),["stop"])},{default:a(()=>[u(D(o.row.title),1)]),_:2},1032,["onClick"])]),_:1}),l(m,{prop:"author",label:"作者",width:"120",align:"center"},{default:a(o=>[l(H,{size:"small",effect:"plain"},{default:a(()=>[u(D(o.row.author),1)]),_:2},1024)]),_:1}),l(m,{prop:"comment_count",label:"评论数",width:"100",align:"center",sortable:""}),l(m,{prop:"created_at",label:"发布时间",width:"180",align:"center",sortable:""},{default:a(o=>[u(D(M(o.row.created_at)),1)]),_:1}),l(m,{label:"操作",width:"120",align:"center",fixed:"right"},{default:a(o=>[I(o.row.author)?(v(),z(d,{key:0,type:"danger",size:"small",onClick:R(Y=>A(o.row),["stop"]),icon:P(ne)},{default:a(()=>[...e[11]||(e[11]=[u(" 删除 ",-1)])]),_:2},1032,["onClick","icon"])):b("",!0)]),_:1})]),_:1},8,["data"]),s("div",ye,[C.value.total_items>0?(v(),z(j,{key:0,layout:"total, sizes, prev, pager, next",total:C.value.total_items,"page-sizes":[10,20,50,100],"page-size":y.value,"onUpdate:pageSize":e[1]||(e[1]=o=>y.value=o),"current-page":g.value,"onUpdate:currentPage":e[2]||(e[2]=o=>g.value=o),onSizeChange:J,onCurrentChange:T},null,8,["total","page-size","current-page"])):b("",!0)])]),_:1})])):b("",!0),!c.value&&h.value.length===0?(v(),z(G,{key:1,description:"暂无帖子"})):b("",!0),l(W,{modelValue:_.value,"onUpdate:modelValue":e[6]||(e[6]=o=>_.value=o),title:"发布新帖子",width:"50%","close-on-click-modal":!1},{footer:a(()=>[s("span",be,[l(d,{onClick:e[5]||(e[5]=o=>_.value=!1)},{default:a(()=>[...e[12]||(e[12]=[u("取消",-1)])]),_:1}),l(d,{type:"primary",onClick:K,loading:x.value},{default:a(()=>[...e[13]||(e[13]=[u("发布",-1)])]),_:1},8,["loading"])])]),default:a(()=>[l(Q,{model:r,"label-width":"80px",rules:E,ref_key:"postFormRef",ref:k},{default:a(()=>[l(B,{label:"标题",prop:"title"},{default:a(()=>[l(V,{modelValue:r.title,"onUpdate:modelValue":e[3]||(e[3]=o=>r.title=o),placeholder:"请输入帖子标题"},null,8,["modelValue"])]),_:1}),l(B,{label:"内容",prop:"content"},{default:a(()=>[l(V,{modelValue:r.content,"onUpdate:modelValue":e[4]||(e[4]=o=>r.content=o),type:"textarea",rows:10,placeholder:"请输入帖子内容"},null,8,["modelValue"])]),_:1})]),_:1},8,["model","rules"])]),_:1},8,["modelValue"])])),[[X,c.value]])}}}),ze=ue(xe,[["__scopeId","data-v-98c82a87"]]);export{ze as default};
