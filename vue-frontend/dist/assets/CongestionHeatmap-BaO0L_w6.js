import{i as M}from"./index-OzhOYD-U.js";import{S as B,d as N,a as _,G as V,C as P,T as O,M as U,Q as H,c as j,e as c,w as h,i as y,E as Q,b,k as L,l as G,J as q,o as J,_ as K}from"./index-pSneD7Y4.js";const W="/django/api/strategy";async function X(I,f){try{return(await B.get(`${W}/industry-turnover-percentile/`,{params:{start_date:I,end_date:f}})).data}catch(r){throw console.error("获取行业换手率分位数数据失败:",r),r}}const Y={class:"congestion-heatmap"},Z={class:"header-controls"},ee={class:"controls"},te=N({__name:"CongestionHeatmap",setup(I){const f=_();let r=null;const d=_("turnover"),v=_("20"),w=_(!1),x=_(""),D=_(!1),C=_([]),S=_([]),E=async()=>{D.value=!0;try{const s=new Date,t=s.toISOString().split("T")[0],i=v.value==="all"?30:parseInt(v.value),u=new Date(s);u.setDate(s.getDate()-i);const m=u.toISOString().split("T")[0],a=await X(m,t);if(a){const e=a.data;if(!Array.isArray(e))throw console.error("API返回的数据不是数组:",e),new Error("API返回的数据格式不正确");const n=[...new Set(e.map(l=>l.date))].sort();S.value=n;const o=new Map;e.forEach(l=>{o.has(l.sector_code)||o.set(l.sector_code,{name:l.sector_name,data:[]});const p=o.get(l.sector_code),A=n.indexOf(l.date);for(;p.data.length<n.length;)p.data.push({turnoverRateFQuantile:0,amountCongestionQuantile:0});p.data[A]={turnoverRateFQuantile:l.turnover_ratio_percentile,amountCongestionQuantile:l.turnover_ratio_percentile}}),C.value=Array.from(o.values())}else Q.error("获取数据失败: ")}catch(s){console.error("获取数据出错:",s),Q.error("获取数据出错，请检查网络连接或API服务是否可用")}finally{D.value=!1}},T=()=>{let s=C.value;x.value.trim()&&(s=C.value.filter(u=>u.name.toLowerCase().includes(x.value.toLowerCase())));const t=v.value==="all"?S.value:S.value.slice(-parseInt(v.value)),i=s.map(u=>({...u,data:v.value==="all"?u.data:u.data.slice(-parseInt(v.value))}));return{dates:t,industries:i}},R=()=>{f.value&&(r=M(f.value),g())},g=()=>{if(!r)return;const{dates:s,industries:t}=T();x.value.trim()?k(t,s):$(t,s)},$=(s,t)=>{if(!r)return;const i=[...s].sort((a,e)=>{if(a.data.length===0||e.data.length===0)return 0;const n=a.data[a.data.length-1][d.value==="turnover"?"turnoverRateFQuantile":"amountCongestionQuantile"],o=e.data[e.data.length-1][d.value==="turnover"?"turnoverRateFQuantile":"amountCongestionQuantile"];return w.value?n-o:o-n}),u=[];i.forEach((a,e)=>{a.data.forEach((n,o)=>{const l=d.value==="turnover"?n.turnoverRateFQuantile:n.amountCongestionQuantile;u.push([o,e,l])})}),r.clear(),r.clear();const m={tooltip:{position:"top",formatter:function(a){const[e,n,o]=a.data,l=t[e],p=i[n].name,A=d.value==="turnover"?"等权换手率分位数":"成交金额占比分位数";return`${p}<br/>${l}<br/>${A}: ${o}`}},grid:{height:Math.max(400,i.length*20)+"px",top:"2%",left:"15%",right:"16%",bottom:"2%",containLabel:!0},xAxis:[{type:"category",data:t.map(a=>a.substring(5)),splitArea:{show:!0},axisLabel:{rotate:45,fontSize:10}},{type:"category",position:"top",data:t.map(a=>a.substring(5)),axisTick:{show:!1},axisLine:{show:!1},axisLabel:{rotate:45,fontSize:10,margin:6},name:"日期",nameLocation:"end",nameTextStyle:{fontSize:12}}],yAxis:[{type:"category",data:i.map(a=>a.name),splitArea:{show:!0},axisLabel:{fontSize:11}},{type:"category",position:"right",data:i.map(a=>a.name),axisTick:{show:!1},axisLine:{show:!1},axisLabel:{fontSize:11},name:"行业",nameLocation:"end",nameTextStyle:{fontSize:12}}],visualMap:{min:0,max:100,calculable:!0,orient:"vertical",right:"2%",top:"5%",inRange:{color:["#313695","#4575b4","#74add1","#abd9e9","#e0f3f8","#ffffbf","#fee090","#fdae61","#f46d43","#d73027","#a50026"]},text:["高","低"],textStyle:{fontSize:12}},series:[{name:d.value==="turnover"?"等权换手率分位数":"成交金额占比分位数",type:"heatmap",data:u,label:{show:!0,fontSize:9,formatter:function(a){return a.data[2]}},emphasis:{itemStyle:{shadowBlur:10,shadowColor:"rgba(0, 0, 0, 0.5)"}}}]};if(r.setOption(m),f.value){const a=Math.max(500,i.length*22+120);f.value.style.height=a+"px",r.resize()}},k=(s,t)=>{if(!r)return;const i=["#5470C6","#91CC75","#EE6666","#FAC858","#73C0DE","#3BA272","#FC8452","#9A60B4","#EA7CCC","#2f4554","#61a0a8","#d48265","#749f83","#ca8622","#bda29a","#6e7074","#546570","#c4ccd3"],u=e=>{let n=0;for(let o=0;o<e.length;o++)n=n*31+e.charCodeAt(o)>>>0;return i[n%i.length]},m=s.map(e=>{const n=u(e.name);return{name:e.name,type:"line",data:e.data.map(o=>d.value==="turnover"?o.turnoverRateFQuantile:o.amountCongestionQuantile),smooth:!0,symbol:"circle",symbolSize:6,lineStyle:{width:2,color:n},itemStyle:{color:n}}});r.clear();const a={title:{text:`行业拥挤度趋势图 - ${s.map(e=>e.name).join("、")}`,left:"center"},tooltip:{trigger:"axis",axisPointer:{type:"cross"},formatter:function(e){let n=`${e[0].axisValue}<br/>`;return e.forEach(o=>{const l=d.value==="turnover"?"等权换手率分位数":"成交金额占比分位数";n+=`${o.seriesName} ${l}: ${o.value}<br/>`}),n}},legend:{type:"scroll",data:s.map(e=>e.name),top:"5%"},grid:{left:"3%",right:"4%",bottom:"3%",top:"15%",containLabel:!0},xAxis:{type:"category",boundaryGap:!1,data:t.map(e=>e.substring(5)),axisLabel:{rotate:45}},yAxis:{type:"value",name:d.value==="turnover"?"等权换手率分位数":"成交金额占比分位数",min:0,max:100},series:m};r.setOption(a,!0),f.value&&(f.value.style.height="500px",r.resize())},F=()=>{w.value=!w.value,g()},z=()=>{r&&r.resize()};return V([d,x],()=>{r&&g()}),V(v,async()=>{await E(),r&&g()}),P(async()=>{const s=O.service({target:".congestion-heatmap",text:"加载数据中...",background:"rgba(255, 255, 255, 0.7)"});try{await E(),await U(),R()}finally{s.close()}window.addEventListener("resize",z)}),H(()=>{r&&r.dispose(),window.removeEventListener("resize",z)}),(s,t)=>{const i=y("el-radio-button"),u=y("el-radio-group"),m=y("el-option"),a=y("el-select"),e=y("el-icon"),n=y("el-input"),o=y("el-button"),l=y("el-card");return J(),j("div",Y,[c(l,null,{header:h(()=>[b("div",Z,[t[6]||(t[6]=b("h3",null,"行业拥挤度热力图",-1)),b("div",ee,[c(u,{modelValue:d.value,"onUpdate:modelValue":t[0]||(t[0]=p=>d.value=p),onChange:g},{default:h(()=>[c(i,{label:"turnover"},{default:h(()=>[...t[3]||(t[3]=[L("等权换手率分位数",-1)])]),_:1}),c(i,{label:"amount"},{default:h(()=>[...t[4]||(t[4]=[L("成交金额占比分位数",-1)])]),_:1})]),_:1},8,["modelValue"]),c(a,{modelValue:v.value,"onUpdate:modelValue":t[1]||(t[1]=p=>v.value=p),onChange:g,placeholder:"选择日期范围",style:{width:"150px","margin-left":"10px"}},{default:h(()=>[c(m,{label:"最近10天",value:"10"}),c(m,{label:"最近15天",value:"15"}),c(m,{label:"最近20天",value:"20"}),c(m,{label:"全部29天",value:"all"})]),_:1},8,["modelValue"]),c(n,{modelValue:x.value,"onUpdate:modelValue":t[2]||(t[2]=p=>x.value=p),onInput:g,onClear:g,placeholder:"搜索行业",style:{width:"200px","margin-left":"10px"},clearable:""},{prefix:h(()=>[c(e,null,{default:h(()=>[c(G(q))]),_:1})]),_:1},8,["modelValue"]),c(o,{onClick:F,type:"primary"},{default:h(()=>[...t[5]||(t[5]=[L("按最后一列排序",-1)])]),_:1})])])]),default:h(()=>[b("div",{ref_key:"chartContainer",ref:f,class:"chart-container"},null,512)]),_:1})])}}}),oe=K(te,[["__scopeId","data-v-35839c5a"]]);export{oe as default};
