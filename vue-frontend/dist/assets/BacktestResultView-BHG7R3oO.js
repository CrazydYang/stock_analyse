import{d as vt,a as c,z as N,y as ft,j as pt,E,M as mt,c as y,b as t,G as Y,e as s,w as l,i as v,g as K,t as r,H as ht,f as Q,L as bt,u as wt,k as T,l as M,P as yt,C as k,Q as gt,R as xt,S as kt,T as St,o as p,_ as Ct}from"./index-COoaZqH2.js";import{i as P}from"./index-1yOyFXf9.js";import{b as Lt,e as Dt,f as Rt}from"./quantBacktestApi-CuNVYv7M.js";const zt={class:"backtest-result-view"},At={class:"page-header"},Bt={class:"header-content"},Ft={key:0},It={class:"content-container"},Tt={class:"basic-stats-section"},Mt={key:0,class:"stats-container"},$t={class:"top-info-row"},Vt={class:"fund-item"},Ot={class:"period-item"},Nt={key:0,class:"period-value"},Et={class:"fund-item"},Pt={class:"fund-icon"},Gt={class:"fund-content"},jt={class:"fund-value"},Ut={class:"fund-item"},Wt={class:"fund-icon"},Zt={class:"fund-content"},Ht={class:"main-stats"},qt={class:"main-stat-item"},Kt={class:"stat-icon positive-bg"},Qt={class:"stat-content"},Jt={class:"main-stat-item"},Xt={class:"stat-icon info-bg"},Yt={class:"stat-content"},te={class:"main-stat-item"},ee={class:"stat-icon warning-bg"},ae={class:"stat-content"},se={class:"stat-value negative"},oe={class:"main-stat-item"},le={class:"stat-icon success-bg"},re={class:"stat-content"},ne={class:"stat-value"},ie={class:"secondary-stats horizontal-stats"},de={class:"secondary-stat-item"},ce={class:"stat-header"},ue={class:"stat-value"},_e={class:"stat-progress"},ve={class:"stat-description"},fe={class:"secondary-stat-item"},pe={class:"stat-header"},me={class:"stat-badge"},he={class:"stat-value"},be={class:"stat-description"},we={class:"secondary-stat-item"},ye={class:"stat-header"},ge={class:"stat-badge success"},xe={class:"stat-value positive"},ke={class:"stat-description"},Se={class:"secondary-stat-item"},Ce={class:"stat-header"},Le={class:"stat-badge danger"},De={class:"stat-value negative"},Re={class:"stat-description"},ze={class:"secondary-stat-item"},Ae={class:"stat-header"},Be={class:"stat-value"},Fe={class:"secondary-stat-item"},Ie={class:"stat-header"},Te={class:"stat-badge info"},Me={class:"stat-value"},$e={class:"charts-section"},Ve={class:"chart-container"},Oe={class:"observer-charts-container"},Ne={class:"date-value"},Ee={class:"price-value"},Pe={class:"quantity-value"},Ge={class:"amount-value"},je={key:1,class:"text-muted"},Ue={key:1,class:"text-muted"},We={class:"commission-value"},Ze={class:"remark-text"},He=vt({__name:"BacktestResultView",setup(qe){const tt=pt(),et=wt(),$=c(!1),L=c(""),o=c(null),m=c(null),g=c(null),h=c(null),at=c(null);c("ALL"),c(""),c(""),c(null);const G=c(),j=c(),U=c(),W=c();c();const S=c([]);let D=null,R=null,z=null,A=null;const st=async()=>{try{const e=await Lt(L.value);o.value={task_id:e.task_info.task_id,strategy_name:e.task_info.strategy_name,symbol:e.task_info.stock_code,period:{start_date:e.task_info.start_date,end_date:e.task_info.end_date},detailed_data:e.detailed_data,performance:{total_return:e.performance.total_return,annual_return:e.performance.annual_return,max_drawdown:e.performance.max_drawdown,sharpe_ratio:e.performance.sharpe_ratio||0,win_rate:e.performance.win_rate||0,total_trades:e.performance.total_trades,winning_trades:e.performance.winning_trades,losing_trades:e.performance.losing_trades,initial_value:e.performance.initial_value,final_value:e.performance.final_value,volatility:e.performance.volatility||0},portfolio_value:e.detailed_data?.portfolio_values||e.portfolio_value||[],trades:e.detailed_data?.trade_records||e.trades||[]},o.value&&(S.value=o.value.trades)}catch(e){console.error("获取回测结果失败:",e),E.error("获取回测结果失败")}},ot=async()=>{try{const e=await Dt(L.value);m.value=e.data,h.value=e.data.task_info}catch(e){console.error("获取观测器数据失败:",e),E.error("获取观测器数据失败")}},lt=async()=>{try{const e=await Rt(L.value);g.value=e.data,at.value=e.data.indicator_data}catch(e){console.error("获取原始数据和指标数据失败:",e),E.error("获取原始数据和指标数据失败")}},rt=async()=>{if(await bt(),m.value?.observer_data?.broker?m.value.observer_data.broker.map(e=>e.datetime.split(" ")[0]):g.value?.raw_data&&g.value.raw_data.datetime,W.value&&g.value?.raw_data){A=P(W.value);const e=g.value.raw_data,a=e.datetime||[],i=a.map((_,w)=>e.close[w]),b=[],n=[];m.value?.observer_data?.buysell&&m.value.observer_data.buysell.forEach(_=>{const w=a.findIndex(I=>I.startsWith(_.datetime.split(" ")[0]));w!==-1&&(_.size>0?b.push([w,_.price]):n.push([w,_.price]))});const u=[{name:"收盘价",type:"line",data:i,smooth:!0,showSymbol:!1,lineStyle:{width:2,color:"#5470c6"},z:5},{name:"买入",type:"scatter",data:b,symbolSize:8,itemStyle:{color:"#67C23A"},symbol:"triangle"},{name:"卖出",type:"scatter",data:n,symbolSize:8,itemStyle:{color:"#F56C6C"},symbol:"triangle",symbolRotate:180}];if(g.value?.indicator_data){const _=g.value.indicator_data,w=["#5470c6","#91cc75","#fac858","#ee6666","#73c0de","#3ba272","#fc8452","#9a60b4","#ea7ccc","#2f4554"];let I=0;Object.keys(_).forEach(x=>{if(_[x]){const H=x.toLowerCase().includes("crossover"),q=x.toLowerCase().includes("signal"),O=H||q?1:0,f=w[I++%w.length];u.push({name:x,type:"line",data:_[x],smooth:!0,showSymbol:!1,yAxisIndex:O,lineStyle:{width:1.5,color:f}})}})}const C={tooltip:{trigger:"axis",axisPointer:{type:"cross"}},legend:{data:["收盘价","买入","卖出",...Object.keys(g.value?.indicator_data||{})],type:"scroll",orient:"horizontal",top:0,textStyle:{fontSize:11},pageButtonItemGap:5,pageButtonGap:5},grid:{left:"3%",right:"4%",bottom:"15%",top:"60px",containLabel:!0},xAxis:{type:"category",data:a,scale:!0,boundaryGap:!1,axisLine:{onZero:!1},splitLine:{show:!1},axisLabel:{rotate:45,interval:"auto",formatter:function(_){return _.substring(5,10)}}},yAxis:[{name:"价格",type:"value",scale:!0,position:"left",axisLine:{show:!1},axisTick:{show:!1},axisLabel:{color:"#909399",fontSize:10},splitLine:{show:!0,lineStyle:{type:"dashed",color:"#ebeef5"}}},{name:"指标值",type:"value",scale:!0,position:"right",axisLine:{show:!1},axisTick:{show:!1},axisLabel:{color:"#909399",fontSize:10},splitLine:{show:!1}}],dataZoom:[{type:"inside",start:0,end:100},{show:!0,type:"slider",bottom:0,start:0,end:100}],series:u};A.setOption(C)}if(G.value&&m.value?.observer_data?.broker){D=P(G.value);const e=m.value.observer_data.broker,a=e.map(u=>u.datetime.split(" ")[0]),i=e.map(u=>u.value),b=e.map(u=>u.cash),n={tooltip:{trigger:"axis",formatter:u=>{let C=`${u[0].axisValue}<br/>`;return u.forEach(_=>{C+=`${_.seriesName}: ¥${_.value.toLocaleString()}<br/>`}),C}},grid:{left:"3%",right:"4%",bottom:"0%",top:"3%",containLabel:!0,height:60},xAxis:{type:"category",data:a,axisLabel:{show:!1},axisLine:{show:!1},axisTick:{show:!1}},yAxis:{type:"value",axisLine:{show:!1},axisTick:{show:!1},splitLine:{show:!0,lineStyle:{type:"dashed",color:"#ebeef5"}},axisLabel:{color:"#909399",fontSize:10,formatter:u=>`¥${(u/1e3).toFixed(0)}K`}},series:[{name:"总资产",type:"line",data:i,smooth:!0,showSymbol:!1,lineStyle:{color:"#5470c6",width:2},areaStyle:{color:{type:"linear",x:0,y:0,x2:0,y2:1,colorStops:[{offset:0,color:"rgba(84, 112, 198, 0.3)"},{offset:1,color:"rgba(84, 112, 198, 0.1)"}]}}},{name:"现金",type:"line",data:b,smooth:!0,showSymbol:!1,lineStyle:{color:"#67C23A",width:1.5}}]};D.setOption(n)}if(j.value&&m.value?.observer_data?.timereturn){R=P(j.value);const e=m.value.observer_data.timereturn,a=e.map(n=>n.datetime.split(" ")[0]),i=e.map(n=>n.return),b={tooltip:{trigger:"axis",formatter:n=>`${n[0].axisValue}<br/>收益率: ${n[0].value.toFixed(2)}%`},grid:{left:"3%",right:"4%",bottom:"0%",top:"3%",containLabel:!0,height:60},xAxis:{type:"category",data:a,axisLabel:{show:!1},axisLine:{show:!1},axisTick:{show:!1}},yAxis:{type:"value",axisLine:{show:!1},axisTick:{show:!1},splitLine:{show:!0,lineStyle:{type:"dashed",color:"#ebeef5"}},axisLabel:{color:"#909399",fontSize:10,formatter:n=>`${n.toFixed(1)}%`}},series:[{name:"收益率",type:"line",data:i,smooth:!0,showSymbol:!1,lineStyle:{color:"#91cc75",width:2},areaStyle:{color:{type:"linear",x:0,y:0,x2:0,y2:1,colorStops:[{offset:0,color:"rgba(145, 204, 117, 0.3)"},{offset:1,color:"rgba(145, 204, 117, 0.1)"}]}}}]};R.setOption(b)}if(U.value&&m.value?.observer_data?.drawdown){z=P(U.value);const e=m.value.observer_data.drawdown,a=e.map(n=>n.datetime.split(" ")[0]),i=e.map(n=>n.drawdown*100),b={tooltip:{trigger:"axis",formatter:n=>`${n[0].axisValue}<br/>回撤: ${n[0].value.toFixed(2)}%`},grid:{left:"3%",right:"4%",bottom:"5%",top:"3%",containLabel:!0,height:60},xAxis:{type:"category",data:a,axisLabel:{show:!1},axisLine:{show:!1},axisTick:{show:!1}},yAxis:{type:"value",axisLine:{show:!1},axisTick:{show:!1},splitLine:{show:!0,lineStyle:{type:"dashed",color:"#ebeef5"}},axisLabel:{color:"#909399",fontSize:10,formatter:n=>`${n.toFixed(1)}%`}},dataZoom:[{type:"inside",xAxisIndex:0,start:0,end:100},{show:!1,xAxisIndex:0,type:"slider",bottom:0,start:0,end:100}],series:[{name:"回撤",type:"line",data:i,smooth:!0,showSymbol:!1,lineStyle:{color:"#ee6666",width:2},areaStyle:{color:{type:"linear",x:0,y:0,x2:0,y2:1,colorStops:[{offset:0,color:"rgba(238, 102, 102, 0.5)"},{offset:1,color:"rgba(238, 102, 102, 0.2)"}]}},emphasis:{focus:"series",itemStyle:{shadowBlur:10,shadowColor:"rgba(238, 102, 102, 0.5)"}}}]};z.setOption(b)}},B=e=>e>0?"positive":e<0?"negative":"",F=e=>e==null?"0.00%":`${e.toFixed(2)}%`,V=e=>e==null?"0.00":e.toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2}),nt=e=>e>=70?"#67c23a":e>=50?"#e6a23c":"#f56c6c",it=(e,a)=>Math.abs(e)<.1&&a>1.5?"low-risk":Math.abs(e)<.2&&a>1?"medium-risk":"high-risk",dt=(e,a)=>Math.abs(e)<.1&&a>1.5?"低风险":Math.abs(e)<.2&&a>1?"中风险":"高风险";N(()=>S.value.length),N(()=>S.value.filter(e=>e.type==="buy").length),N(()=>S.value.filter(e=>e.type==="sell").length),N(()=>S.value.reduce((e,a)=>e+a.value,0));const Z=e=>e.split("T")[0],J=()=>{et.push({name:"BacktestHistory"})};ft(async()=>{if(L.value=tt.params.taskId,!L.value){E.error("缺少任务ID参数"),J();return}$.value=!0;try{await Promise.all([st(),ot(),lt()]),await rt()}catch(e){console.error("页面初始化失败:",e)}finally{$.value=!1}});const ct=()=>{D&&(D.dispose(),D=null),R&&(R.dispose(),R=null),z&&(z.dispose(),z=null),A&&(A.dispose(),A=null)};return mt(()=>{ct()}),(e,a)=>{const i=v("el-icon"),b=v("el-button"),n=v("Money"),u=v("Wallet"),C=v("ArrowUp"),_=v("ArrowDown"),w=v("el-progress"),I=v("DataLine"),x=v("CircleCheck"),H=v("CircleClose"),q=v("Coin"),O=v("el-card"),f=v("el-table-column"),ut=v("el-tag"),_t=v("el-table"),X=ht("loading");return p(),y("div",zt,[t("div",At,[s(b,{type:"primary",onClick:J,class:"back-button"},{default:l(()=>[s(i,null,{default:l(()=>[s(M(yt))]),_:1}),a[0]||(a[0]=T(" 返回 ",-1))]),_:1}),t("div",Bt,[a[1]||(a[1]=t("h1",null,"回测结果详情",-1)),h.value?(p(),y("p",Ft,r(h.value.strategy_name)+" - "+r(h.value.stock_name)+"("+r(h.value.stock_code)+")",1)):K("",!0)])]),Y((p(),y("div",It,[t("div",Tt,[s(O,{class:"stats-card"},{header:l(()=>[...a[2]||(a[2]=[t("div",{class:"card-header"},[t("span",{class:"card-title"},"回测基本数据")],-1)])]),default:l(()=>[o.value?(p(),y("div",Mt,[t("div",$t,[t("div",Vt,[t("div",Ot,[a[3]||(a[3]=t("span",{class:"period-label"},"回测区间:",-1)),h.value?(p(),y("span",Nt,r(Z(h.value.start_date))+" 至 "+r(Z(h.value.end_date)),1)):K("",!0)])]),t("div",Et,[t("div",Pt,[s(i,null,{default:l(()=>[s(n)]),_:1})]),t("div",Gt,[a[4]||(a[4]=t("div",{class:"fund-label"},"初始资金",-1)),t("div",jt,"¥"+r(V(h.value.initial_cash)),1)])]),t("div",Ut,[t("div",Wt,[s(i,null,{default:l(()=>[s(u)]),_:1})]),t("div",Zt,[a[5]||(a[5]=t("div",{class:"fund-label"},"最终资金",-1)),t("div",{class:k(["fund-value",B(o.value.performance.final_value-h.value.initial_cash)])}," ¥"+r(V(o.value.performance.final_value)),3)])])]),t("div",Ht,[t("div",qt,[t("div",Kt,[s(i,null,{default:l(()=>[s(M(gt))]),_:1})]),t("div",Qt,[a[6]||(a[6]=t("div",{class:"stat-label"},"总收益率",-1)),t("div",{class:k(["stat-value",B(o.value.performance.total_return)])},r(F(o.value.performance.total_return)),3)])]),t("div",Jt,[t("div",Xt,[s(i,null,{default:l(()=>[s(M(xt))]),_:1})]),t("div",Yt,[a[7]||(a[7]=t("div",{class:"stat-label"},"年化收益率",-1)),t("div",{class:k(["stat-value",B(o.value.performance.annual_return)])},r(F(o.value.performance.annual_return)),3)])]),t("div",te,[t("div",ee,[s(i,null,{default:l(()=>[s(M(kt))]),_:1})]),t("div",ae,[a[8]||(a[8]=t("div",{class:"stat-label"},"最大回撤",-1)),t("div",se,r(F(o.value.performance.max_drawdown)),1)])]),t("div",oe,[t("div",le,[s(i,null,{default:l(()=>[s(M(St))]),_:1})]),t("div",re,[a[9]||(a[9]=t("div",{class:"stat-label"},"夏普比率",-1)),t("div",ne,r(o.value.performance.sharpe_ratio.toFixed(2)),1)])])]),t("div",ie,[t("div",de,[t("div",ce,[a[10]||(a[10]=t("div",{class:"stat-label"},"胜率",-1)),t("div",{class:k(["trend-indicator",o.value.performance.win_rate>=.6?"trend-up":"trend-down"])},[o.value.performance.win_rate>=.6?(p(),Q(i,{key:0},{default:l(()=>[s(C)]),_:1})):(p(),Q(i,{key:1},{default:l(()=>[s(_)]),_:1}))],2)]),t("div",ue,r(F(o.value.performance.win_rate)),1),t("div",_e,[s(w,{percentage:o.value.performance.win_rate,"show-text":!1,"stroke-width":6,color:nt(o.value.performance.win_rate)},null,8,["percentage","color"])]),t("div",ve,r(o.value.performance.win_rate>=.6?"表现优秀":o.value.performance.win_rate>=.4?"表现一般":"需要改进"),1)]),t("div",fe,[t("div",pe,[a[11]||(a[11]=t("div",{class:"stat-label"},"总交易次数",-1)),t("div",me,[s(i,null,{default:l(()=>[s(I)]),_:1})])]),t("div",he,r(o.value.performance.total_trades),1),t("div",be," 交易频率: "+r((o.value.performance.total_trades/252).toFixed(1))+"/年 ",1)]),t("div",we,[t("div",ye,[a[12]||(a[12]=t("div",{class:"stat-label"},"盈利交易",-1)),t("div",ge,[s(i,null,{default:l(()=>[s(x)]),_:1})])]),t("div",xe,r(o.value.performance.winning_trades),1),t("div",ke," 占比: "+r((o.value.performance.winning_trades/o.value.performance.total_trades*100).toFixed(1))+"% ",1)]),t("div",Se,[t("div",Ce,[a[13]||(a[13]=t("div",{class:"stat-label"},"亏损交易",-1)),t("div",Le,[s(i,null,{default:l(()=>[s(H)]),_:1})])]),t("div",De,r(o.value.performance.losing_trades),1),t("div",Re," 占比: "+r((o.value.performance.losing_trades/o.value.performance.total_trades*100).toFixed(1))+"% ",1)]),t("div",ze,[t("div",Ae,[a[14]||(a[14]=t("div",{class:"stat-label"},"风险评级",-1)),t("div",{class:k(["risk-level",it(o.value.performance.max_drawdown,o.value.performance.sharpe_ratio)])},[s(i,null,{default:l(()=>[s(u)]),_:1})],2)]),t("div",Be,r(dt(o.value.performance.max_drawdown,o.value.performance.sharpe_ratio)),1),a[15]||(a[15]=t("div",{class:"stat-description"}," 基于回撤和夏普比率 ",-1))]),t("div",Fe,[t("div",Ie,[a[16]||(a[16]=t("div",{class:"stat-label"},"收益风险比",-1)),t("div",Te,[s(i,null,{default:l(()=>[s(q)]),_:1})])]),t("div",Me,r((Math.abs(o.value.performance.total_return)/Math.abs(o.value.performance.max_drawdown)).toFixed(2)),1),a[17]||(a[17]=t("div",{class:"stat-description"}," 收益/最大回撤 ",-1))])])])):K("",!0)]),_:1})]),t("div",$e,[s(O,{class:"chart-card main-chart"},{header:l(()=>[...a[18]||(a[18]=[t("div",{class:"card-header"},[t("span",{class:"card-title"},"价格走势与交易信号")],-1)])]),default:l(()=>[t("div",Ve,[t("div",{ref_key:"klineChartRef",ref:W,class:"chart main-chart-content"},null,512),a[19]||(a[19]=t("div",{class:"observer-legend",style:{"margin-top":"10px","margin-bottom":"5px","text-align":"center"}},[t("span",{class:"legend-item"},[t("span",{class:"color-dot broker-color"}),T("资金曲线")]),t("span",{class:"legend-item"},[t("span",{class:"color-dot return-color"}),T("收益率曲线")]),t("span",{class:"legend-item"},[t("span",{class:"color-dot drawdown-color"}),T("回撤曲线")])],-1)),t("div",Oe,[t("div",{ref_key:"brokerChartRef",ref:G,class:"chart observer-chart"},null,512),t("div",{ref_key:"returnChartRef",ref:j,class:"chart observer-chart"},null,512),t("div",{ref_key:"drawdownChartRef",ref:U,class:"chart observer-chart"},null,512)])])]),_:1})]),Y((p(),Q(_t,{data:S.value,stripe:"",style:{width:"100%"},"default-sort":{prop:"datetime",order:"descending"},class:"trades-table"},{default:l(()=>[s(f,{type:"index",label:"#","min-width":"60"}),s(f,{prop:"datetime",label:"交易日期","min-width":"120",sortable:""},{default:l(d=>[t("span",Ne,r(Z(d.row.datetime)),1)]),_:1}),s(f,{label:"操作","min-width":"80",align:"center"},{default:l(d=>[s(ut,{type:d.row.type==="buy"?"success":"danger",size:"small",effect:"dark"},{default:l(()=>[T(r(d.row.type==="buy"?"买入":"卖出"),1)]),_:2},1032,["type"])]),_:1}),s(f,{prop:"price",label:"价格","min-width":"100",sortable:"",align:"right"},{default:l(d=>[t("span",Ee,"¥"+r(d.row.price.toFixed(2)),1)]),_:1}),s(f,{prop:"size",label:"数量","min-width":"100",align:"right"},{default:l(d=>[t("span",Pe,r(d.row.size.toLocaleString()),1)]),_:1}),s(f,{prop:"value",label:"成本","min-width":"120",sortable:"",align:"right"},{default:l(d=>[t("span",Ge,"¥"+r(d.row.value.toLocaleString()),1)]),_:1}),s(f,{prop:"pnl",label:"盈亏","min-width":"120",sortable:"",align:"right"},{default:l(d=>[d.row.type==="sell"?(p(),y("span",{key:0,class:k(B(d.row.pnl||0))},r(V(d.row.pnl)),3)):(p(),y("span",je,"-"))]),_:1}),s(f,{label:"收益率","min-width":"100",align:"right"},{default:l(d=>[d.row.type==="sell"?(p(),y("span",{key:0,class:k(B(d.row.pnl_pct||0))},r(F(d.row.pnl_pct||0)),3)):(p(),y("span",Ue,"-"))]),_:1}),s(f,{label:"手续费","min-width":"100",align:"right"},{default:l(d=>[t("span",We,"¥"+r(V(Number(d.row.commission??0))),1)]),_:1}),s(f,{label:"备注","min-width":"120"},{default:l(d=>[t("span",Ze,r(d.row.type==="buy"?"策略买入信号":"策略卖出信号"),1)]),_:1})]),_:1},8,["data"])),[[X,$.value]])])),[[X,$.value]])])}}}),Xe=Ct(He,[["__scopeId","data-v-e9cb8100"]]);export{Xe as default};
