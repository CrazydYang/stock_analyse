import{i as me}from"./index-1yOyFXf9.js";import{x as q,d as _e,a as y,G as Q,y as pe,W as ge,D as V,M as he,c as H,e as x,w as I,i as A,E as z,b as M,f as F,g as U,k as $,F as X,A as Y,l as j,J as ve,o as S,_ as xe}from"./index-hKubguDr.js";const we="/django/api/strategy";async function ye(e,p){try{return(await q.get(`${we}/industry-turnover-percentile/`,{params:{start_date:e,end_date:p}})).data}catch(a){throw console.error("获取行业换手率分位数数据失败:",a),a}}const be="/django/api/stock";async function Ie(e,p,a,N){try{const v={};return e&&(v.industry=e),p&&(v.report_type=p),(await q.get(`${be}/industry/heatmap-data/`,{params:v})).data}catch(v){throw console.error("获取行业热力图数据失败:",v),v}}var te=(e=>(e.OPERATING_REVENUE_GROWTH="avg_operating_revenue_growth_rate",e.NET_PROFIT_GROWTH="avg_net_profit_growth_rate",e.TOTAL_OPERATING_REVENUE="total_operating_revenue",e.TOTAL_NET_PROFIT="total_net_profit",e.EARNINGS_PER_SHARE="avg_earnings_per_share",e.ROE="avg_roe",e.GROSS_PROFIT_MARGIN="avg_gross_profit_margin",e.NET_ASSETS_PER_SHARE="avg_net_assets_per_share",e.OPERATING_CASH_FLOW_PER_SHARE="avg_operating_cash_flow_per_share",e))(te||{});const Z={avg_operating_revenue_growth_rate:{name:"营业收入增长率",unit:"%",description:"平均营业收入增长率"},avg_net_profit_growth_rate:{name:"净利润增长率",unit:"%",description:"平均净利润增长率"},total_operating_revenue:{name:"总营业收入",unit:"亿元",description:"总营业收入",formatter:e=>(e/1e8).toFixed(2)},total_net_profit:{name:"总净利润",unit:"亿元",description:"总净利润",formatter:e=>(e/1e8).toFixed(2)},avg_earnings_per_share:{name:"每股收益",unit:"元",description:"平均每股收益"},avg_roe:{name:"净资产收益率",unit:"%",description:"平均净资产收益率"},avg_gross_profit_margin:{name:"毛利率",unit:"%",description:"平均毛利率"},avg_net_assets_per_share:{name:"每股净资产",unit:"元",description:"平均每股净资产"},avg_operating_cash_flow_per_share:{name:"每股经营现金流",unit:"元",description:"平均每股经营现金流"}},Ne="/django/api/stock";var ae=(e=>(e.MAIN_NET_INFLOW_AMOUNT="main_net_inflow_amount",e.MAIN_NET_INFLOW_RATIO="main_net_inflow_ratio",e.SUPER_LARGE_NET_INFLOW_AMOUNT="super_large_net_inflow_amount",e.SUPER_LARGE_NET_INFLOW_RATIO="super_large_net_inflow_ratio",e.LARGE_NET_INFLOW_AMOUNT="large_net_inflow_amount",e.LARGE_NET_INFLOW_RATIO="large_net_inflow_ratio",e.MEDIUM_NET_INFLOW_AMOUNT="medium_net_inflow_amount",e.MEDIUM_NET_INFLOW_RATIO="medium_net_inflow_ratio",e.SMALL_NET_INFLOW_AMOUNT="small_net_inflow_amount",e.SMALL_NET_INFLOW_RATIO="small_net_inflow_ratio",e))(ae||{});const ee={main_net_inflow_amount:{name:"主力净流入金额",unit:"元",formatter:e=>Math.abs(e)>=1e8?(e/1e8).toFixed(2)+"亿":Math.abs(e)>=1e4?(e/1e4).toFixed(2)+"万":e.toFixed(2)},main_net_inflow_ratio:{name:"主力净流入占比",unit:"%",formatter:e=>e.toFixed(2)},super_large_net_inflow_amount:{name:"超大单净流入金额",unit:"元",formatter:e=>Math.abs(e)>=1e8?(e/1e8).toFixed(2)+"亿":Math.abs(e)>=1e4?(e/1e4).toFixed(2)+"万":e.toFixed(2)},super_large_net_inflow_ratio:{name:"超大单净流入占比",unit:"%",formatter:e=>e.toFixed(2)},large_net_inflow_amount:{name:"大单净流入金额",unit:"元",formatter:e=>Math.abs(e)>=1e8?(e/1e8).toFixed(2)+"亿":Math.abs(e)>=1e4?(e/1e4).toFixed(2)+"万":e.toFixed(2)},large_net_inflow_ratio:{name:"大单净流入占比",unit:"%",formatter:e=>e.toFixed(2)},medium_net_inflow_amount:{name:"中单净流入金额",unit:"元",formatter:e=>Math.abs(e)>=1e8?(e/1e8).toFixed(2)+"亿":Math.abs(e)>=1e4?(e/1e4).toFixed(2)+"万":e.toFixed(2)},medium_net_inflow_ratio:{name:"中单净流入占比",unit:"%",formatter:e=>e.toFixed(2)},small_net_inflow_amount:{name:"小单净流入金额",unit:"元",formatter:e=>Math.abs(e)>=1e8?(e/1e8).toFixed(2)+"亿":Math.abs(e)>=1e4?(e/1e4).toFixed(2)+"万":e.toFixed(2)},small_net_inflow_ratio:{name:"小单净流入占比",unit:"%",formatter:e=>e.toFixed(2)}};async function Le(e,p){try{const a={};return e&&(a.start_date=e),p&&(a.end_date=p),(await q.get(`${Ne}/industry/fund-flow/data/`,{params:a})).data}catch(a){throw console.error("获取行业资金流数据失败:",a),a}}const Ee={class:"congestion-heatmap"},Se={class:"header-controls"},Ae={class:"controls"},Ce=_e({__name:"CongestionHeatmap",setup(e){const p=y();let a=null;const N=y("amount"),v=y("20"),T=y(!0),E=y(""),J=y(!1),w=y("turnover"),C=y(te.OPERATING_REVENUE_GROWTH),R=y(ae.MAIN_NET_INFLOW_AMOUNT),O=y("annual"),P=y([]),k=y([]),W=y(null),D=y(null),G=async()=>{J.value=!0;try{w.value==="turnover"?await ne():w.value==="performance"?await oe():w.value==="fundflow"&&await re()}catch(n){console.error("获取数据出错:",n),z.error("获取数据出错，请检查网络连接或API服务是否可用")}finally{J.value=!1}},ne=async()=>{const n=new Date,o=n.toISOString().split("T")[0],f=v.value==="all"?30:parseInt(v.value),c=new Date(n);c.setDate(n.getDate()-f);const u=c.toISOString().split("T")[0],s=await ye(u,o);if(s){const r=s.data;if(!Array.isArray(r))throw console.error("API返回的数据不是数组:",r),new Error("API返回的数据格式不正确");const l=[...new Set(r.map(m=>m.date))].sort();k.value=l;const i=new Map;r.forEach(m=>{i.has(m.sector_code)||i.set(m.sector_code,{name:m.sector_name,data:[]});const t=i.get(m.sector_code),d=l.indexOf(m.date);for(;t.data.length<l.length;)t.data.push({turnoverRateFQuantile:0,amountCongestionQuantile:0});t.data[d]={turnoverRateFQuantile:m.turnover_ratio_percentile,amountCongestionQuantile:m.turnover_ratio_percentile}}),P.value=Array.from(i.values())}else z.error("获取数据失败: ")},oe=async()=>{const n=await Ie(E.value.trim()||void 0,O.value,void 0,void 0);n?W.value=n:z.error("获取行业业绩数据失败")},re=async()=>{const n=new Date,o=n.toISOString().split("T")[0],f=v.value==="all"?30:parseInt(v.value),c=new Date(n);c.setDate(n.getDate()-f);const u=c.toISOString().split("T")[0],s=await Le(u,o);s?D.value=s:z.error("获取行业资金流数据失败")},ie=()=>{let n=P.value;E.value.trim()&&(n=P.value.filter(c=>c.name.toLowerCase().includes(E.value.toLowerCase())));const o=v.value==="all"?k.value:k.value.slice(-parseInt(v.value)),f=n.map(c=>({...c,data:v.value==="all"?c.data:c.data.slice(-parseInt(v.value))}));return{dates:o,industries:f}},se=()=>{p.value&&(a=me(p.value),L())},L=()=>{if(a)if(w.value==="turnover"){const{dates:n,industries:o}=ie();E.value.trim()?fe(o,n):de(o,n)}else w.value==="performance"?le():w.value==="fundflow"&&ue()},le=()=>{if(!a||!W.value)return;const n=W.value,o=n.dates,f=n.swCodeNames;let c=f;E.value.trim()&&(c=f.filter(t=>t.indexName.toLowerCase().includes(E.value.toLowerCase())));const u=[...c].sort((t,d)=>{const g=n.congestions[t.indexCode]||n.congestions[t.indexName],h=n.congestions[d.indexCode]||n.congestions[d.indexName];if(!g||!h||g.length===0||h.length===0)return 0;const b=g[g.length-1][C.value],_=h[h.length-1][C.value];return T.value?b-_:_-b}),s=[];let r=1/0,l=-1/0;u.forEach((t,d)=>{const g=n.congestions[t.indexCode]||n.congestions[t.indexName];g&&g.forEach((h,b)=>{const _=h[C.value];typeof _=="number"&&!isNaN(_)&&isFinite(_)&&(s.push([b,d,_]),r=Math.min(r,_),l=Math.max(l,_))})}),(r===1/0||l===-1/0)&&(r=0,l=100);const i=Z[C.value];a.clear();const m={tooltip:{position:"top",formatter:function(t){const[d,g,h]=t.data,b=o[d],_=u[g].indexName,B=i.formatter?i.formatter(h):h.toFixed(2);return`${_}<br/>${b}<br/>${i.name}: ${B}${i.unit}`}},grid:{height:Math.max(400,u.length*20)+"px",top:"2%",left:"15%",right:"16%",bottom:"2%",containLabel:!0},xAxis:[{type:"category",data:o,splitArea:{show:!0},axisLabel:{rotate:45,fontSize:10}},{type:"category",position:"top",data:o,axisTick:{show:!1},axisLine:{show:!1},axisLabel:{rotate:45,fontSize:10,margin:6},name:"报告期",nameLocation:"end",nameTextStyle:{fontSize:12}}],yAxis:[{type:"category",data:u.map(t=>t.indexName),splitArea:{show:!0},axisLabel:{fontSize:11}},{type:"category",position:"right",data:u.map(t=>t.indexName),axisTick:{show:!1},axisLine:{show:!1},axisLabel:{fontSize:11},name:"行业",nameLocation:"end",nameTextStyle:{fontSize:12}}],visualMap:{min:r,max:l,calculable:!0,orient:"vertical",right:"2%",top:"5%",inRange:{color:["#313695","#4575b4","#74add1","#abd9e9","#e0f3f8","#ffffbf","#fee090","#fdae61","#f46d43","#d73027","#a50026"]},text:["高","低"],textStyle:{fontSize:12}},series:[{name:i.name,type:"heatmap",data:s,label:{show:!0,fontSize:9,formatter:function(t){const d=t.data[2];return i.formatter?i.formatter(d):d.toFixed(1)}},emphasis:{itemStyle:{shadowBlur:10,shadowColor:"rgba(0, 0, 0, 0.5)"}}}]};V(()=>{if(a&&(a.setOption(m),p.value)){const t=Math.max(500,u.length*22+120);p.value.style.height=t+"px",setTimeout(()=>{a&&a.resize()},0)}})},ue=()=>{if(console.log(D.value),!a||!D.value)return;const n=D.value,o=n.dates,f=n.swCodeNames;let c=f;E.value.trim()&&(c=f.filter(t=>t.indexName.toLowerCase().includes(E.value.toLowerCase())));const u=[...c].sort((t,d)=>{const g=n.congestions[t.indexCode]||n.congestions[t.indexName],h=n.congestions[d.indexCode]||n.congestions[d.indexName];if(!g||!h||g.length===0||h.length===0)return 0;const b=g[g.length-1][R.value],_=h[h.length-1][R.value];return T.value?b-_:_-b}),s=[];let r=1/0,l=-1/0;u.forEach((t,d)=>{const g=n.congestions[t.indexCode]||n.congestions[t.indexName];g&&g.forEach((h,b)=>{const _=h[R.value];typeof _=="number"&&!isNaN(_)&&isFinite(_)&&(s.push([b,d,_]),r=Math.min(r,_),l=Math.max(l,_))})}),(r===1/0||l===-1/0)&&(r=0,l=100);const i=ee[R.value];a.clear();const m={tooltip:{position:"top",formatter:function(t){const[d,g,h]=t.data,b=o[d],_=u[g].indexName,B=i.formatter?i.formatter(h):h.toFixed(2);return`${_}<br/>${b}<br/>${i.name}: ${B}${i.unit}`}},grid:{height:Math.max(400,u.length*20)+"px",top:"2%",left:"15%",right:"16%",bottom:"2%",containLabel:!0},xAxis:[{type:"category",data:o,splitArea:{show:!0},axisLabel:{rotate:45,fontSize:10}},{type:"category",position:"top",data:o,axisTick:{show:!1},axisLine:{show:!1},axisLabel:{rotate:45,fontSize:10,margin:6},name:"日期",nameLocation:"end",nameTextStyle:{fontSize:12}}],yAxis:[{type:"category",data:u.map(t=>t.indexName),splitArea:{show:!0},axisLabel:{fontSize:11}},{type:"category",position:"right",data:u.map(t=>t.indexName),axisTick:{show:!1},axisLine:{show:!1},axisLabel:{fontSize:11},name:"行业",nameLocation:"end",nameTextStyle:{fontSize:12}}],visualMap:{min:r,max:l,calculable:!0,orient:"vertical",right:"2%",top:"5%",inRange:{color:["#313695","#4575b4","#74add1","#abd9e9","#e0f3f8","#ffffbf","#fee090","#fdae61","#f46d43","#d73027","#a50026"]},text:["高","低"],textStyle:{fontSize:12}},series:[{name:i.name,type:"heatmap",data:s,label:{show:!0,fontSize:9,formatter:function(t){const d=t.data[2];return i.formatter?i.formatter(d):d.toFixed(1)}},emphasis:{itemStyle:{shadowBlur:10,shadowColor:"rgba(0, 0, 0, 0.5)"}}}]};V(()=>{if(a&&(a.setOption(m),p.value)){const t=Math.max(500,u.length*22+120);p.value.style.height=t+"px",setTimeout(()=>{a&&a.resize()},0)}})},de=(n,o)=>{if(!a)return;const f=[...n].sort((s,r)=>{if(s.data.length===0||r.data.length===0)return 0;const l=s.data[s.data.length-1][N.value==="turnover"?"turnoverRateFQuantile":"amountCongestionQuantile"],i=r.data[r.data.length-1][N.value==="turnover"?"turnoverRateFQuantile":"amountCongestionQuantile"];return T.value?l-i:i-l}),c=[];f.forEach((s,r)=>{s.data.forEach((l,i)=>{const m=N.value==="turnover"?l.turnoverRateFQuantile:l.amountCongestionQuantile;typeof m=="number"&&!isNaN(m)&&isFinite(m)&&c.push([i,r,m])})}),a.clear(),a.clear();const u={tooltip:{position:"top",formatter:function(s){const[r,l,i]=s.data,m=o[r],t=f[l].name,d=N.value==="turnover"?"等权换手率分位数":"成交金额占比分位数";return`${t}<br/>${m}<br/>${d}: ${i}`}},grid:{height:Math.max(400,f.length*20)+"px",top:"2%",left:"15%",right:"16%",bottom:"2%",containLabel:!0},xAxis:[{type:"category",data:o.map(s=>s.substring(5)),splitArea:{show:!0},axisLabel:{rotate:45,fontSize:10}},{type:"category",position:"top",data:o.map(s=>s.substring(5)),axisTick:{show:!1},axisLine:{show:!1},axisLabel:{rotate:45,fontSize:10,margin:6},name:"日期",nameLocation:"end",nameTextStyle:{fontSize:12}}],yAxis:[{type:"category",data:f.map(s=>s.name),splitArea:{show:!0},axisLabel:{fontSize:11}},{type:"category",position:"right",data:f.map(s=>s.name),axisTick:{show:!1},axisLine:{show:!1},axisLabel:{fontSize:11},name:"行业",nameLocation:"end",nameTextStyle:{fontSize:12}}],visualMap:{min:0,max:100,calculable:!0,orient:"vertical",right:"2%",top:"5%",inRange:{color:["#313695","#4575b4","#74add1","#abd9e9","#e0f3f8","#ffffbf","#fee090","#fdae61","#f46d43","#d73027","#a50026"]},text:["高","低"],textStyle:{fontSize:12}},series:[{name:N.value==="turnover"?"等权换手率分位数":"成交金额占比分位数",type:"heatmap",data:c,label:{show:!0,fontSize:9,formatter:function(s){return s.data[2]}},emphasis:{itemStyle:{shadowBlur:10,shadowColor:"rgba(0, 0, 0, 0.5)"}}}]};if(a.setOption(u),p.value){const s=Math.max(500,f.length*22+120);p.value.style.height=s+"px",a.resize()}},fe=(n,o)=>{if(!a)return;const f=["#5470C6","#91CC75","#EE6666","#FAC858","#73C0DE","#3BA272","#FC8452","#9A60B4","#EA7CCC","#2f4554","#61a0a8","#d48265","#749f83","#ca8622","#bda29a","#6e7074","#546570","#c4ccd3"],c=r=>{let l=0;for(let i=0;i<r.length;i++)l=l*31+r.charCodeAt(i)>>>0;return f[l%f.length]},u=n.map(r=>{const l=c(r.name);return{name:r.name,type:"line",data:r.data.map(i=>N.value==="turnover"?i.turnoverRateFQuantile:i.amountCongestionQuantile),smooth:!0,symbol:"circle",symbolSize:6,lineStyle:{width:2,color:l},itemStyle:{color:l}}});a.clear();const s={title:{text:`行业拥挤度趋势图 - ${n.map(r=>r.name).join("、")}`,left:"center"},tooltip:{trigger:"axis",axisPointer:{type:"cross"},formatter:function(r){let l=`${r[0].axisValue}<br/>`;return r.forEach(i=>{const m=N.value==="turnover"?"等权换手率分位数":"成交金额占比分位数";l+=`${i.seriesName} ${m}: ${i.value}<br/>`}),l}},legend:{type:"scroll",data:n.map(r=>r.name),top:"5%"},grid:{left:"3%",right:"4%",bottom:"3%",top:"15%",containLabel:!0},xAxis:{type:"category",boundaryGap:!1,data:o.map(r=>r.substring(5)),axisLabel:{rotate:45}},yAxis:{type:"value",name:N.value==="turnover"?"等权换手率分位数":"成交金额占比分位数",min:0,max:100},series:u};V(()=>{a&&(a.setOption(s,!0),p.value&&(p.value.style.height="500px",setTimeout(()=>{a&&a.resize()},0)))})},ce=()=>{T.value=!T.value,L()},K=()=>{a&&a.resize()};return Q([N,E],()=>{a&&L()}),Q([w,C,O],async()=>{await G(),a&&L()}),Q(v,async()=>{(w.value==="turnover"||w.value==="fundflow")&&(await G(),a&&L())}),pe(async()=>{const n=ge.service({target:".congestion-heatmap",text:"加载数据中...",background:"rgba(255, 255, 255, 0.7)"});try{await G(),await V(),se()}finally{n.close()}window.addEventListener("resize",K)}),he(()=>{a&&a.dispose(),window.removeEventListener("resize",K)}),(n,o)=>{const f=A("el-radio-button"),c=A("el-radio-group"),u=A("el-option"),s=A("el-select"),r=A("el-icon"),l=A("el-input"),i=A("el-button"),m=A("el-card");return S(),H("div",Ee,[x(m,null,{header:I(()=>[M("div",Se,[o[10]||(o[10]=M("h3",null,"行业拥挤度热力图",-1)),M("div",Ae,[x(c,{modelValue:w.value,"onUpdate:modelValue":o[0]||(o[0]=t=>w.value=t),onChange:L,size:"small"},{default:I(()=>[x(f,{label:"turnover"},{default:I(()=>[...o[6]||(o[6]=[$("成交金额占比分位数",-1)])]),_:1}),x(f,{label:"performance"},{default:I(()=>[...o[7]||(o[7]=[$("行业业绩指标",-1)])]),_:1}),x(f,{label:"fundflow"},{default:I(()=>[...o[8]||(o[8]=[$("行业资金流",-1)])]),_:1})]),_:1},8,["modelValue"]),w.value==="performance"?(S(),F(s,{key:0,modelValue:C.value,"onUpdate:modelValue":o[1]||(o[1]=t=>C.value=t),onChange:L,placeholder:"选择指标",style:{width:"180px","margin-left":"10px"}},{default:I(()=>[(S(!0),H(X,null,Y(j(Z),(t,d)=>(S(),F(u,{key:d,label:t.name,value:d},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])):U("",!0),w.value==="performance"?(S(),F(s,{key:1,modelValue:O.value,"onUpdate:modelValue":o[2]||(o[2]=t=>O.value=t),onChange:L,placeholder:"选择报告类型",style:{width:"120px","margin-left":"10px"}},{default:I(()=>[x(u,{label:"年报",value:"annual"}),x(u,{label:"中报",value:"semi_annual"}),x(u,{label:"一季报",value:"q1"}),x(u,{label:"三季报",value:"q3"}),x(u,{label:"季报",value:"quarterly"})]),_:1},8,["modelValue"])):U("",!0),w.value==="fundflow"?(S(),F(s,{key:2,modelValue:R.value,"onUpdate:modelValue":o[3]||(o[3]=t=>R.value=t),onChange:L,placeholder:"选择资金流指标",style:{width:"180px","margin-left":"10px"}},{default:I(()=>[(S(!0),H(X,null,Y(j(ee),(t,d)=>(S(),F(u,{key:d,label:t.name,value:d},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])):U("",!0),w.value==="turnover"||w.value==="fundflow"?(S(),F(s,{key:3,modelValue:v.value,"onUpdate:modelValue":o[4]||(o[4]=t=>v.value=t),onChange:L,placeholder:"选择日期范围",style:{width:"150px","margin-left":"10px"}},{default:I(()=>[x(u,{label:"最近10天",value:"10"}),x(u,{label:"最近15天",value:"15"}),x(u,{label:"最近20天",value:"20"}),x(u,{label:"全部29天",value:"all"})]),_:1},8,["modelValue"])):U("",!0),x(l,{modelValue:E.value,"onUpdate:modelValue":o[5]||(o[5]=t=>E.value=t),onInput:L,onClear:L,placeholder:"搜索行业",style:{width:"200px","margin-left":"10px"},clearable:""},{prefix:I(()=>[x(r,null,{default:I(()=>[x(j(ve))]),_:1})]),_:1},8,["modelValue"]),x(i,{onClick:ce,type:"primary"},{default:I(()=>[...o[9]||(o[9]=[$("按最后一列排序",-1)])]),_:1})])])]),default:I(()=>[M("div",{ref_key:"chartContainer",ref:p,class:"chart-container"},null,512)]),_:1})])}}}),Fe=xe(Ce,[["__scopeId","data-v-d1c3a6ac"]]);export{Fe as default};
