import{f as P,g as N,a as De,S as Ce,b as Ve,c as Me}from"./stockHistoryApi-COmQG49V.js";import{N as L,d as xe,r as K,a as w,B as Se,G as Ye,C as Te,c as D,b as d,g as k,e as a,w as l,i as f,E as _,f as C,F as O,A as Q,k as m,t as i,o as p,_ as Pe}from"./index-BXcHrunV.js";import{i as $e,L as Be}from"./index-1yOyFXf9.js";const Ne=async()=>(await L.get("/django/api/quant/strategies/")).data.strategies,Ue=async V=>(await L.post("/django/api/quant/backtest/create/",V)).data,Fe=async V=>(await L.post(`/django/api/quant/backtest/${V}/run/`)).data,Re=async V=>(await L.get(`/django/api/quant/backtest/${V}/status/`)).data,Le=async V=>(await L.get(`/django/api/quant/backtest/${V}/result/`)).data,qe={class:"quantitative-backtest-view"},Ie={class:"control-panel"},je={key:0,class:"chart-container"},ze={class:"card-header"},Ae={class:"stock-info"},Ee={key:1,class:"empty-state"},Ge={key:2,class:"strategy-panel"},He={key:3,class:"result-container"},Ke={class:"card-header"},Oe={key:0,class:"trades-table"},Qe={class:"performance-metrics"},Je={key:0,class:"result-chart"},We=xe({__name:"QuantitativeBacktestView",setup(V){const s=K({stockCode:"",stockName:"",dateRangeType:"month",startDate:"",endDate:""}),u=K({strategyName:"",initialCash:1e5,strategyParams:{}}),x=w([]),c=K({code:"",name:"",industry:"",listDate:"",totalMarketCap:0,circulatingMarketCap:0}),A=w([]),E=w([]),$=w(null),h=w(""),S=w(""),n=w(null),U=w([]),G=w(null),b=w(!1),le=Se(()=>!!s.stockCode&&!!u.strategyName&&x.value.length>0),se=t=>{const e=A.value.find(r=>r.code===t);e&&(s.stockCode=e.code,s.stockName=e.name,oe(e.code))},oe=async t=>{try{const e=await Ve(t);c.code=e.code,c.name=e.name,c.industry=e.industry,c.listDate=e.list_date,c.totalMarketCap=e.total_market_cap,c.circulatingMarketCap=e.circulating_market_cap}catch(e){console.error("获取股票详细信息失败:",e),_.error("获取股票详细信息失败")}},J=()=>{const e=P(new Date);switch(s.endDate=e,s.dateRangeType){case"week":s.startDate=P(N(7));break;case"month":s.startDate=P(N(30));break;case"threeMonths":s.startDate=P(N(90));break;case"sixMonths":s.startDate=P(N(180));break;case"year":s.startDate=P(N(365));break;case"threeYears":s.startDate=P(N(365*3));break;case"all":s.startDate="";break}},re=async()=>{if(!s.stockCode){_.warning("请先选择股票");return}if(s.dateRangeType==="custom"&&(!s.startDate||!s.endDate)){_.warning("请选择完整的日期范围");return}b.value=!0;try{let t=s.startDate,e=s.endDate;t&&(t=t.replace(/-/g,"")),e&&(e=e.replace(/-/g,""));const r=await Me(s.stockCode,t,e);x.value=r,r.length>0?_.success("股票数据获取成功"):_.warning("未查询到股票历史数据"),W()}catch(t){console.error("获取股票数据失败:",t),_.error("获取股票数据失败"),x.value=[]}finally{b.value=!1}},ne=()=>{s.stockCode="",s.stockName="",s.dateRangeType="month",s.startDate="",s.endDate="",x.value=[],c.code="",c.name="",c.industry="",c.listDate="",c.totalMarketCap=0,c.circulatingMarketCap=0,W()},W=()=>{u.strategyName="",u.strategyParams={},$.value=null,h.value="",S.value="",n.value=null,U.value=[]},ue=()=>{u.strategyName="",u.initialCash=1e5,u.strategyParams={},$.value=null,h.value="",S.value="",n.value=null,U.value=[]},X=t=>t?t>=1e8?`${(t/1e8).toFixed(2)}亿`:t>=1e4?`${(t/1e4).toFixed(2)}万`:t.toString():"未知",q=t=>t==null?"-":`${(t*100).toFixed(2)}%`,I=t=>t?t.toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2}):"0.00",de=t=>{switch(t){case"created":return"info";case"running":return"warning";case"completed":return"success";case"failed":return"danger";default:return"info"}},ce=t=>{switch(t){case"created":return"已创建";case"running":return"运行中";case"completed":return"已完成";case"failed":return"执行失败";default:return"未知状态"}},ie=async()=>{try{b.value=!0;const{data:t}=await De(1,100);A.value=t}catch(t){console.error("加载股票列表失败:",t),_.error("加载股票列表失败")}finally{b.value=!1}},pe=async()=>{try{b.value=!0;const t=await Ne();E.value=t}catch(t){console.error("加载策略列表失败:",t),_.error("加载策略列表失败")}finally{b.value=!1}},me=t=>{const e=E.value.find(r=>r.name===t);e&&($.value=e,console.log("选择策略:",e),u.strategyParams={},e.params&&Object.keys(e.params).forEach(r=>{u.strategyParams[r]=e.params[r].default}))},fe=async()=>{if(!s.stockCode||!u.strategyName){_.warning("请选择股票和策略");return}b.value=!0;try{const t=y=>y?y.includes("-")?y:y.length===8?`${y.slice(0,4)}-${y.slice(4,6)}-${y.slice(6,8)}`:y:"",e={strategy_name:u.strategyName,stock_code:s.stockCode,start_date:t(s.startDate),end_date:t(s.endDate),initial_cash:u.initialCash,strategy_params:u.strategyParams},r=await Ue(e);h.value=r.task_id,S.value=r.status,_.success("回测任务创建成功")}catch(t){console.error("创建回测任务失败:",t),_.error("创建回测任务失败")}finally{b.value=!1}},_e=async()=>{if(!h.value){_.warning("请先创建回测任务");return}b.value=!0;try{const t=await Fe(h.value);S.value=t.status,_.success("回测任务已启动"),Z()}catch(t){console.error("启动回测任务失败:",t),_.error("启动回测任务失败")}finally{b.value=!1}},Z=async()=>{if(h.value)try{const t=await Re(h.value);S.value=t.status,t.status==="completed"?ve():t.status==="failed"?_.error("回测任务执行失败"):t.status==="running"&&setTimeout(Z,2e3)}catch(t){console.error("获取任务状态失败:",t),_.error("获取任务状态失败")}},ve=async()=>{if(h.value)try{const t=await Le(h.value);n.value=t,ye(),ee()}catch(t){console.error("获取回测结果失败:",t),_.error("获取回测结果失败")}},ye=()=>{if(!n.value)return;const t=[];if(n.value.detailed_data?.trade_records){const e=n.value.detailed_data.trade_records;for(const r of e)t.push({date:r.datetime.split("T")[0],price:r.price,type:r.type,description:`${r.type==="buy"?"买入":"卖出"} ${Math.abs(r.size)}股`})}else if(n.value.trades){const e=n.value.trades;for(const r of e)t.push({date:r.date,price:r.price,type:r.action,description:`${r.action==="buy"?"买入":"卖出"} ${Math.abs(r.quantity)}股`})}U.value=t,console.log("交易点数据已更新:",U.value.length,"个交易点")},ee=()=>{if(!G.value||!n.value)return;const t=n.value.detailed_data?.portfolio_values||n.value.portfolio_value;if(!t||t.length===0)return;const e=$e(G.value),r=t.map(v=>v.date),y=t.map(v=>v.value),g={title:{text:"投资组合价值变化",left:"center"},tooltip:{trigger:"axis",formatter:v=>{const F=v[0].axisValue,j=v[0].data;return`${F}<br/>组合价值: ${I(j)}`}},xAxis:{type:"category",data:r},yAxis:{type:"value",name:"组合价值",axisLabel:{formatter:v=>I(v)}},series:[{name:"组合价值",type:"line",data:y,smooth:!0,lineStyle:{width:2,color:"#5470c6"},areaStyle:{color:new Be(0,0,0,1,[{offset:0,color:"rgba(84, 112, 198, 0.5)"},{offset:1,color:"rgba(84, 112, 198, 0.1)"}])}}]};e.setOption(g),window.addEventListener("resize",()=>{e.resize()})};return Ye(()=>n.value,()=>{setTimeout(()=>{ee()},0)}),Te(()=>{J(),ie(),pe()}),(t,e)=>{const r=f("el-option"),y=f("el-select"),g=f("el-form-item"),v=f("el-col"),F=f("el-row"),j=f("el-date-picker"),R=f("el-button"),te=f("el-form"),z=f("el-card"),ge=f("el-empty"),H=f("el-input-number"),ke=f("el-input"),he=f("el-switch"),ae=f("el-tag"),B=f("el-table-column"),be=f("el-table"),Y=f("el-descriptions-item"),we=f("el-descriptions");return p(),D("div",qe,[e[16]||(e[16]=d("div",{class:"page-header"},[d("h1",null,"量化策略回测"),d("p",null,"选择股票和策略，进行量化回测分析")],-1)),d("div",Ie,[a(z,null,{header:l(()=>[...e[6]||(e[6]=[d("div",{class:"card-header"},[d("span",null,"股票选择")],-1)])]),default:l(()=>[a(te,{model:s,"label-width":"100px",class:"query-form"},{default:l(()=>[a(F,{gutter:20},{default:l(()=>[a(v,{span:8},{default:l(()=>[a(g,{label:"股票代码"},{default:l(()=>[a(y,{modelValue:s.stockCode,"onUpdate:modelValue":e[0]||(e[0]=o=>s.stockCode=o),placeholder:"请选择股票",class:"full-width",onChange:se},{default:l(()=>[(p(!0),D(O,null,Q(A.value,o=>(p(),C(r,{key:o.code,label:`${o.code} ${o.name}`,value:o.code},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1}),a(v,{span:8},{default:l(()=>[a(g,{label:"时间范围"},{default:l(()=>[a(y,{modelValue:s.dateRangeType,"onUpdate:modelValue":e[1]||(e[1]=o=>s.dateRangeType=o),onChange:J,class:"full-width"},{default:l(()=>[a(r,{label:"最近一周",value:"week"}),a(r,{label:"最近一月",value:"month"}),a(r,{label:"最近三月",value:"threeMonths"}),a(r,{label:"最近六月",value:"sixMonths"}),a(r,{label:"最近一年",value:"year"}),a(r,{label:"最近三年",value:"threeYears"}),a(r,{label:"全部",value:"all"}),a(r,{label:"自定义",value:"custom"})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),s.dateRangeType==="custom"?(p(),C(F,{key:0,gutter:20},{default:l(()=>[a(v,{span:8},{default:l(()=>[a(g,{label:"开始日期"},{default:l(()=>[a(j,{modelValue:s.startDate,"onUpdate:modelValue":e[2]||(e[2]=o=>s.startDate=o),type:"date",placeholder:"选择开始日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",class:"full-width"},null,8,["modelValue"])]),_:1})]),_:1}),a(v,{span:8},{default:l(()=>[a(g,{label:"结束日期"},{default:l(()=>[a(j,{modelValue:s.endDate,"onUpdate:modelValue":e[3]||(e[3]=o=>s.endDate=o),type:"date",placeholder:"选择结束日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",class:"full-width"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})):k("",!0),a(g,null,{default:l(()=>[a(R,{type:"primary",onClick:re},{default:l(()=>[...e[7]||(e[7]=[m("查询",-1)])]),_:1}),a(R,{onClick:ne},{default:l(()=>[...e[8]||(e[8]=[m("重置",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1})]),x.value.length>0?(p(),D("div",je,[a(z,null,{header:l(()=>[d("div",ze,[d("span",null,i(c.name)+"("+i(c.code)+") K线图",1),d("div",Ae,[d("span",null,"行业: "+i(c.industry||"未知"),1),d("span",null,"上市日期: "+i(c.listDate||"未知"),1),d("span",null,"总市值: "+i(X(c.totalMarketCap)),1),d("span",null,"流通市值: "+i(X(c.circulatingMarketCap)),1)])])]),default:l(()=>[a(Ce,{"stock-code":c.code,"stock-name":c.name,"kline-data":x.value,"trade-signals":U.value,height:"500px","show-volume":!0},null,8,["stock-code","stock-name","kline-data","trade-signals"])]),_:1})])):k("",!0),x.value.length===0?(p(),D("div",Ee,[a(ge,{description:"请选择股票并查询数据"})])):k("",!0),x.value.length>0?(p(),D("div",Ge,[a(z,null,{header:l(()=>[...e[9]||(e[9]=[d("div",{class:"card-header"},[d("span",null,"策略配置")],-1)])]),default:l(()=>[a(te,{model:u,"label-width":"120px",class:"strategy-form"},{default:l(()=>[a(g,{label:"选择策略"},{default:l(()=>[a(y,{modelValue:u.strategyName,"onUpdate:modelValue":e[4]||(e[4]=o=>u.strategyName=o),placeholder:"请选择策略",class:"full-width",onChange:me},{default:l(()=>[(p(!0),D(O,null,Q(E.value,o=>(p(),C(r,{key:o.name,label:o.description,value:o.name},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),a(g,{label:"初始资金"},{default:l(()=>[a(H,{modelValue:u.initialCash,"onUpdate:modelValue":e[5]||(e[5]=o=>u.initialCash=o),min:1e4,step:1e4,precision:0,class:"full-width"},null,8,["modelValue"])]),_:1}),$.value&&$.value.params?(p(!0),D(O,{key:0},Q($.value.params,(o,M)=>(p(),C(g,{key:M,label:o.description},{default:l(()=>[o.type==="int"?(p(),C(H,{key:0,modelValue:u.strategyParams[M],"onUpdate:modelValue":T=>u.strategyParams[M]=T,min:1,precision:0,class:"full-width"},null,8,["modelValue","onUpdate:modelValue"])):o.type==="string"?(p(),C(ke,{key:1,modelValue:u.strategyParams[M],"onUpdate:modelValue":T=>u.strategyParams[M]=T,class:"full-width"},null,8,["modelValue","onUpdate:modelValue"])):o.type==="float"?(p(),C(H,{key:2,modelValue:u.strategyParams[M],"onUpdate:modelValue":T=>u.strategyParams[M]=T,precision:2,class:"full-width"},null,8,["modelValue","onUpdate:modelValue"])):o.type==="boolean"?(p(),C(he,{key:3,modelValue:u.strategyParams[M],"onUpdate:modelValue":T=>u.strategyParams[M]=T},null,8,["modelValue","onUpdate:modelValue"])):k("",!0)]),_:2},1032,["label"]))),128)):k("",!0),a(g,null,{default:l(()=>[a(R,{type:"primary",onClick:fe,disabled:!le.value},{default:l(()=>[...e[10]||(e[10]=[m("创建回测任务",-1)])]),_:1},8,["disabled"]),a(R,{type:"success",onClick:_e,disabled:!h.value},{default:l(()=>[...e[11]||(e[11]=[m("运行回测",-1)])]),_:1},8,["disabled"]),a(R,{onClick:ue},{default:l(()=>[...e[12]||(e[12]=[m("重置",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1})])):k("",!0),n.value?(p(),D("div",He,[a(z,null,{header:l(()=>[d("div",Ke,[e[13]||(e[13]=d("span",null,"回测结果",-1)),S.value?(p(),C(ae,{key:0,type:de(S.value)},{default:l(()=>[m(i(ce(S.value)),1)]),_:1},8,["type"])):k("",!0)])]),default:l(()=>[a(F,{gutter:20},{default:l(()=>[a(v,{span:16},{default:l(()=>[n.value.detailed_data?.trade_records&&n.value.detailed_data.trade_records.length>0||n.value.trades&&n.value.trades.length>0?(p(),D("div",Oe,[e[14]||(e[14]=d("h3",null,"交易记录",-1)),a(be,{data:n.value.detailed_data?.trade_records||n.value.trades,stripe:"",style:{width:"100%"}},{default:l(()=>[a(B,{label:"日期",width:"180"},{default:l(o=>[m(i(o.row.datetime||o.row.date),1)]),_:1}),a(B,{label:"操作",width:"80"},{default:l(o=>[a(ae,{type:(o.row.type||o.row.action)==="buy"?"danger":"success"},{default:l(()=>[m(i((o.row.type||o.row.action)==="buy"?"买入":"卖出"),1)]),_:2},1032,["type"])]),_:1}),a(B,{prop:"price",label:"价格",width:"100"}),a(B,{label:"数量",width:"100"},{default:l(o=>[m(i(Math.abs(o.row.size||o.row.quantity)),1)]),_:1}),a(B,{label:"金额",width:"120"},{default:l(o=>[m(i(I(o.row.value||o.row.amount)),1)]),_:1}),n.value.detailed_data?.trade_records?(p(),C(B,{key:0,label:"手续费",width:"100"},{default:l(o=>[m(i(I(o.row.commission)),1)]),_:1})):k("",!0)]),_:1},8,["data"])])):k("",!0)]),_:1}),a(v,{span:8},{default:l(()=>[d("div",Qe,[e[15]||(e[15]=d("h3",null,"绩效指标",-1)),a(we,{column:1,border:""},{default:l(()=>[a(Y,{label:"总收益率"},{default:l(()=>[m(i(q(n.value.performance?.total_return)),1)]),_:1}),a(Y,{label:"年化收益率"},{default:l(()=>[m(i(q(n.value.performance?.annual_return)),1)]),_:1}),a(Y,{label:"最大回撤"},{default:l(()=>[m(i(q(n.value.performance?.max_drawdown)),1)]),_:1}),a(Y,{label:"夏普比率"},{default:l(()=>[m(i(n.value.performance?.sharpe_ratio?.toFixed(2)||"-"),1)]),_:1}),a(Y,{label:"胜率"},{default:l(()=>[m(i(q(n.value.performance?.win_rate)),1)]),_:1}),a(Y,{label:"交易次数"},{default:l(()=>[m(i(n.value.performance?.total_trades),1)]),_:1}),a(Y,{label:"盈利交易"},{default:l(()=>[m(i(n.value.performance?.winning_trades),1)]),_:1}),a(Y,{label:"亏损交易"},{default:l(()=>[m(i(n.value.performance?.losing_trades),1)]),_:1})]),_:1})])]),_:1})]),_:1}),n.value.detailed_data?.portfolio_values&&n.value.detailed_data.portfolio_values.length>0||n.value.portfolio_value&&n.value.portfolio_value.length>0?(p(),D("div",Je,[d("div",{ref_key:"portfolioChartRef",ref:G,style:{height:"300px"}},null,512)])):k("",!0)]),_:1})])):k("",!0)])}}}),tt=Pe(We,[["__scopeId","data-v-de9fa83d"]]);export{tt as default};
